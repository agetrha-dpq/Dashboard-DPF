<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Gest√£o Financeira AGETRHA</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>

        /* ===== VARI√ÅVEIS CSS ===== */
        :root {
            --primary: #1a4e8e;
            --secondary: #2a6cba;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --light: #f8f9fa;
            --dark: #343a40;
            --gray: #6c757d;
        }
        
        /* ===== RESET E ESTILOS GERAIS ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            display: flex;
            min-height: 100vh;
        }
        
        /* ===== LOADING OVERLAY ===== */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        #loading-overlay .loading-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        #loading-overlay .fa-spinner {
            color: var(--primary);
            font-size: 40px;
        }
        
        #loading-text {
            margin-top: 15px;
            font-weight: 600;
            color: var(--primary);
        }
        
        /* ===== SIDEBAR ===== */
        .sidebar {
            width: 250px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 20px 0;
            transition: all 0.3s;
            box-shadow: 3px 0 10px rgba(0,0,0,0.1);
        }
        
        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            text-align: center;
        }
        
        .sidebar-menu {
            list-style: none;
            padding: 20px 0;
        }
        
        .sidebar-menu li {
            padding: 0;
        }
        
        .sidebar-menu a {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }
        
        .sidebar-menu a:hover, 
        .sidebar-menu a.active {
            background-color: rgba(255,255,255,0.1);
            color: white;
            border-left: 3px solid white;
        }
        
        .sidebar-menu i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        /* ===== MAIN CONTENT ===== */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* ===== TOP BAR ===== */
        .top-bar {
            background: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .logo-texto {
            display: flex;
            align-items: center;
            color: var(--primary);
            font-weight: 600;
            font-size: 18px;
        }
        
        .logo-texto img {
            height: 40px;
            margin-right: 10px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
        }
        
        .user-info img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
        }
        
        /* ===== SISTEMA DE NOTIFICA√á√ïES ===== */
        .notificacoes-container {
            position: relative;
            margin-right: 20px;
        }
        
        .btn-notificacoes {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--primary);
            cursor: pointer;
            position: relative;
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.3s;
        }
        
        .btn-notificacoes:hover {
            background-color: rgba(26, 78, 142, 0.1);
        }

        .badge-notificacoes {
            position: absolute;
            top: 0;
            right: 0;
            background-color: var(--danger);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .dropdown-notificacoes {
            display: none;
            position: absolute;
            top: 50px;
            right: 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.15);
            width: 350px;
            z-index: 1000;
            border: 1px solid #e0e0e0;
        }
        
        .dropdown-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .dropdown-header h3 {
            margin: 0;
            font-size: 16px;
            color: var(--dark);
        }
        
        .btn-text {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }
        
        .lista-notificacoes {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .notificacao-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            align-items: flex-start;
        }
        
        .notificacao-item:hover {
            background-color: #f8f9fa;
        }
        
        .notificacao-item.nao-lida {
            background-color: rgba(26, 78, 142, 0.05);
        }
        
        .notificacao-item.nao-lida:hover {
            background-color: rgba(26, 78, 142, 0.1);
        }
        
        .notificacao-icone {
            margin-right: 12px;
            font-size: 16px;
            color: var(--primary);
            margin-top: 2px;
        }
        
        .notificacao-conteudo {
            flex: 1;
        }
        
        .notificacao-titulo {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
            color: var(--dark);
        }
        
        .notificacao-descricao {
            font-size: 13px;
            color: var(--gray);
            margin-bottom: 6px;
            line-height: 1.4;
        }
        
        .notificacao-tempo {
            font-size: 11px;
            color: #999;
        }
        
        .dropdown-footer {
            padding: 12px 20px;
            border-top: 1px solid #eee;
            text-align: center;
        }
        
        .dropdown-footer a {
            color: var(--primary);
            text-decoration: none;
            font-size: 13px;
            font-weight: 600;
        }
        
        .dropdown-footer a:hover {
            text-decoration: underline;
        }
        
        /* ===== TOAST NOTIFICATIONS ===== */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        
        .toast {
            background: white;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            min-width: 300px;
            max-width: 400px;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            border-left: 4px solid var(--primary);
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast-icone {
            margin-right: 12px;
            font-size: 18px;
        }
        
        .toast-conteudo {
            flex: 1;
        }
        
        .toast-titulo {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 2px;
        }
        
        .toast-mensagem {
            font-size: 13px;
            color: var(--gray);
        }
        
        .toast-fechar {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
        }
        
        .toast.sucesso {
            border-left-color: var(--success);
        }
        
        .toast.sucesso .toast-icone {
            color: var(--success);
        }
        
        .toast.erro {
            border-left-color: var(--danger);
        }
        
        .toast.erro .toast-icone {
            color: var(--danger);
        }
        
        .toast.alerta {
            border-left-color: var(--warning);
        }
        
        .toast.alerta .toast-icone {
            color: var(--warning);
        }
        
        .toast.info {
            border-left-color: var(--primary);
        }
        
        .toast.info .toast-icone {
            color: var(--primary);
        }
        
        /* ===== CONTENT AREA ===== */
        .content {
            padding: 30px;
            overflow-y: auto;
            flex: 1;
        }
        
        .page-title {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .page-title h1 {
            color: var(--primary);
            font-size: 24px;
        }
        
        /* ===== BOT√ïES ===== */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary);
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-warning {
            background-color: var(--warning);
            color: var(--dark);
        }
        
        .btn i {
            margin-right: 5px;
        }
        
        /* ===== CARDS ===== */
        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            border-left: 4px solid var(--primary);
        }
        
        .card h3 {
            font-size: 14px;
            color: var(--gray);
            margin-bottom: 10px;
        }
        
        .card .value {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
        }
        
        .card .trend {
            font-size: 12px;
            margin-top: 5px;
            display: flex;
            align-items: center;
        }
        
        .trend.up {
            color: var(--success);
        }
        
        .trend.down {
            color: var(--danger);
        }
        
        /* ===== BARRAS DE PROGRESSO ===== */
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .card-percent {
            font-size: 12px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 10px;
        }
        
        .card-percent.up {
            background-color: rgba(40, 167, 69, 0.1);
            color: var(--success);
        }
        
        .card-percent.down {
            background-color: rgba(220, 53, 69, 0.1);
            color: var(--danger);
        }
        
        .progress-container {
            margin-top: 15px;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 5px;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        
        .progress-fill.up {
            background: linear-gradient(90deg, var(--success) 0%, #5cd85c 100%);
        }
        
        .progress-fill.down {
            background: linear-gradient(90deg, var(--danger) 0%, #ff6b6b 100%);
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--gray);
        }
        
        .progress-labels {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: var(--gray);
            margin-top: 3px;
        }
        
        .progress-labels span {
            font-weight: 600;
        }
        
        /* ===== CHARTS ===== */
        .charts {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            height: 350px;
        }
        
        .chart-title {
            font-size: 16px;
            margin-bottom: 15px;
            color: var(--primary);
            font-weight: 600;
        }
        
        /* ===== TABLES ===== */
        .table-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background-color: var(--light);
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
            border-bottom: 1px solid #dee2e6;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #dee2e6;
        }
        
        tr:hover {
            background-color: rgba(0,0,0,0.02);
        }
        
/* ===== MODAL DE LOGIN ===== */
.login-modal {
    display: flex !important;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    z-index: 9999;
    align-items: center;
    justify-content: center;
}

.login-modal.hidden {
    display: none !important;
}

.login-modal-content {
    background: white;
    border-radius: 15px;
    width: 100%;
    max-width: 400px;
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
    overflow: hidden;
    animation: modalSlideIn 0.4s ease;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.login-modal-header {
    background: var(--primary);
    color: white;
    padding: 25px;
    text-align: center;
}

.login-modal-header h2 {
    margin: 0;
    font-size: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.login-modal-header img {
    height: 40px;
    border-radius: 5px;
}

.login-modal-body {
    padding: 30px;
}

.login-form-group {
    margin-bottom: 25px;
}

.login-form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: var(--dark);
}

.login-form-control {
    width: 100%;
    padding: 12px 15px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 16px;
    transition: all 0.3s;
}

.login-form-control:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(26, 78, 142, 0.2);
}

.login-error-message {
    color: var(--danger);
    background-color: rgba(220, 53, 69, 0.1);
    padding: 10px;
    border-radius: 5px;
    margin-top: 10px;
    font-size: 14px;
    display: none;
    text-align: center;
}

.login-success-message {
    color: var(--success);
    background-color: rgba(40, 167, 69, 0.1);
    padding: 10px;
    border-radius: 5px;
    margin-top: 10px;
    font-size: 14px;
    display: none;
    text-align: center;
}

.login-modal-footer {
    padding: 0 30px 30px;
    text-align: center;
}

.lock-emoji {
    font-size: 28px;
    margin-right: 12px;
    display: inline-block;
    vertical-align: middle;
    line-height: 1;
}

.btn-login {
    width: 100%;
    padding: 14px;
    font-size: 16px;
    font-weight: 600;
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    border: none;
    border-radius: 8px;
    color: white;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.btn-login:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(26, 78, 142, 0.3);
}

.btn-login:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
}

.login-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    font-weight: 600;
    color: var(--primary);
}

        /* ===== STATUS BADGES ===== */
        .status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status.pago {
            background-color: rgba(40, 167, 69, 0.1);
            color: var(--success);
        }
        
        .status.pendente {
            background-color: rgba(255, 193, 7, 0.1);
            color: #b58900;
        }
        
        .status.atrasado {
            background-color: rgba(220, 53, 69, 0.1);
            color: var(--danger);
        }
        
        .tipo-receita {
            background-color: rgba(40, 167, 69, 0.1);
            color: var(--success);
        }
        
        .tipo-despesa {
            background-color: rgba(220, 53, 69, 0.1);
            color: var(--danger);
        }
        
        /* Status dos membros */
        .status.regular {
            background-color: rgba(40, 167, 69, 0.1);
            color: var(--success);
        }
        
        .status.suspenso {
            background-color: rgba(220, 53, 69, 0.1);
            color: var(--danger);
        }
        
        .status.pendente {
            background-color: rgba(255, 193, 7, 0.1);
            color: #b58900;
        }
        
        .status.divida {
            background-color: #dc3545;
            color: white;
        }
        
        /* Status dos relat√≥rios */
        .status.mensal {
            background-color: rgba(26, 78, 142, 0.1);
            color: var(--primary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status.trimestral {
            background-color: rgba(40, 167, 69, 0.1);
            color: var(--success);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status.semestral {
            background-color: rgba(255, 193, 7, 0.1);
            color: #b58900;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status.anual {
            background-color: rgba(111, 66, 193, 0.1);
            color: #6f42c1;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status.balanco {
            background-color: rgba(220, 53, 69, 0.1);
            color: var(--danger);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status.customizado {
            background-color: rgba(108, 117, 125, 0.1);
            color: var(--gray);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        /* Estilos para contador de resultados */
        #contador-relatorios {
            background-color: rgba(26, 78, 142, 0.1);
            padding: 8px 15px;
            border-radius: 5px;
            display: inline-block;
            margin-left: 15px;
        }

        /* Estilo para filtros ativos */
        .filter-group select:focus,
        .filter-group input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 0.2rem rgba(26, 78, 142, 0.25);
        }

        /* ===== ACTION BUTTONS ===== */
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            min-width: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .action-btn.view {
            background-color: rgba(26, 78, 142, 0.1);
            color: var(--primary);
        }
        
        .action-btn.edit {
            background-color: rgba(40, 167, 69, 0.1);
            color: var(--success);
        }
        
        .action-btn.delete {
            background-color: rgba(220, 53, 69, 0.1);
            color: var(--danger);
        }
        
        /* ===== FILTERS ===== */
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-group label {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--gray);
        }
        
        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 15px;
        }
        
        /* ===== MODAL ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 20px;
            border-top: 1px solid #ddd;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        /* ===== CONTROL DE PAGAMENTO - TABS ===== */
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
            overflow-x: auto;
            white-space: nowrap;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            border-bottom: 3px solid var(--primary);
            color: var(--primary);
            font-weight: 600;
        }
        
        /* ===== PAYMENT STATUS ===== */
        .payment-status {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .payment-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            transition: all 0.3s;
        }
        
        .payment-btn.paid {
            background-color: var(--success);
            color: white;
        }
        
        .payment-btn.overdue {
            background-color: var(--danger);
            color: white;
        }
        
        /* ===== ESTILOS ESPEC√çFICOS ===== */
        /* Campos obrigat√≥rios */
        .form-group label[for*="*"]::after {
            content: " *";
            color: var(--danger);
        }
        
        /* Datalist */
        input[list] {
            background-image: url('data:image/svg+xml;utf8,<svg fill="%231a4e8e" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px;
            padding-right: 30px;
        }
        
        /* ===== RESPONSIVE ===== */
        @media (max-width: 992px) {
            .sidebar {
                width: 70px;
            }
            
            .sidebar-header h2, .sidebar-menu span {
                display: none;
            }
            
            .sidebar-menu a {
                justify-content: center;
                padding: 15px;
            }
            
            .sidebar-menu i {
                margin-right: 0;
                font-size: 20px;
            }
        }
        
        @media (max-width: 768px) {
            .cards {
                grid-template-columns: 1fr 1fr;
            }
            
            .charts {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                height: 300px;
            }
            
            .page-title {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .page-title h1 {
                font-size: 20px;
            }
            
            .btn {
                padding: 8px 16px;
                font-size: 14px;
            }
            
            .content {
                padding: 15px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                flex: 1 0 auto;
                text-align: center;
                padding: 10px 5px;
                font-size: 12px;
            }
        }
        
        @media (max-width: 576px) {
            .cards {
                grid-template-columns: 1fr;
            }
            
            .top-bar {
                flex-direction: column;
                align-items: flex-start;
                padding: 15px;
            }
            
            .logo-texto {
                margin-bottom: 15px;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 5px;
            }
            
            .filters {
                flex-direction: column;
            }
            
            .filter-group {
                width: 100%;
            }
        }

/* ===== OCULTAR CONTE√öDO DURANTE LOGIN ===== */
body.login-active .sidebar,
body.login-active .main-content {
    display: none !important;
}

    </style>
    
</head>
<body>

<!-- ===== MODAL DE LOGIN ===== -->
<div id="login-modal" class="login-modal">
    <div class="login-modal-content">
        <div class="login-modal-header">
            <img src="https://i.postimg.cc/DyKZTbYq/Logotipo.jpg" alt="AGETRHA Logo">
            <h2><span style="font-size: 28px; margin-right: 10px; display: inline-block;">üîí</span> Acesso Restrito</h2>
        </div>
        
        <div class="login-modal-body">
            <div style="text-align: center; margin-bottom: 25px;">
                <h3 style="color: var(--primary); margin-bottom: 8px;">Departamento de Planejamento e Finan√ßas</h3>
                <p style="color: var(--gray); font-size: 14px;">AGETRHA - Gest√£o Financeira</p>
            </div>
            
            <form id="login-form">
                <div class="login-form-group">
                    <label for="login-password"><i class="fas fa-key"></i> Senha de Acesso</label>
                    <input type="password" 
                           id="login-password" 
                           class="login-form-control" 
                           placeholder="Digite a senha de acesso" 
                           autocomplete="off"
                           required>
                </div>
                
                <div id="login-error-message" class="login-error-message">
                    <i class="fas fa-exclamation-circle"></i> <span id="login-error-text"></span>
                </div>
                
                <div id="login-success-message" class="login-success-message">
                    <i class="fas fa-check-circle"></i> Autentica√ß√£o bem-sucedida!
                </div>
            </form>
        </div>
        
        <div class="login-modal-footer">
            <button id="btn-login-submit" class="btn-login" type="button">
                <i class="fas fa-sign-in-alt"></i> Entrar no Sistema
            </button>
            <p style="margin-top: 15px; font-size: 12px; color: var(--gray);">
                <i class="fas fa-info-circle"></i> Acesso restrito aos membros do DPF
            </p>
        </div>
    </div>
</div>

    <!-- ===== SIDEBAR ===== -->
    <div class="sidebar">
        <div class="sidebar-header">
        </div>
        <ul class="sidebar-menu">
            <li><a href="#" data-page="resumo-financeiro" class="active"><i class="fas fa-chart-line"></i> <span>Gest√£o Financeira</span></a></li>
            <li><a href="#" data-page="transacoes"><i class="fas fa-exchange-alt"></i> <span>Transa√ß√µes</span></a></li>
            <li><a href="#" data-page="gestao-membros"><i class="fa fa-credit-card"></i> <span>Controlo de Pagamento</span></a></li>
            <li><a href="#" data-page="facturas"><i class="fas fa-file-invoice"></i> <span>Facturas</span></a></li>
            <li><a href="#" data-page="relatorios-financeiros"><i class="fas fa-file-invoice-dollar"></i> <span>Relat√≥rios</span></a></li>
            <li><a href="#" data-page="or√ßamento"><i class="fas fa-money-bill-wave"></i> <span>Or√ßamento</span></a></li>
            <li><a href="#" data-page="configuracoes"><i class="fas fa-cogs"></i> <span>Configura√ß√µes</span></a></li>
        </ul>
    </div>

    <!-- ===== MAIN CONTENT ===== -->
    <div class="main-content">
        <!-- ===== TOP BAR ===== -->
        <div class="top-bar">
            <div class="logo-texto">
                <img src="https://i.postimg.cc/DyKZTbYq/Logotipo.jpg" alt="AGETRHA Logo">
                <strong>DEP. PLANEJAMENTO E FINAN√áAS - AGETRHA</strong>
            </div>
            
            <!-- Sistema de Notifica√ß√µes -->
            <div class="notificacoes-container">
                <button id="btn-notificacoes" class="btn-notificacoes">
                    <i class="fas fa-bell"></i>
                    <span id="badge-notificacoes" class="badge-notificacoes">0</span>
                </button>

                <div id="dropdown-notificacoes" class="dropdown-notificacoes">
                    <div class="dropdown-header">
                        <h3>Notifica√ß√µes</h3>
                        <div>
                            <button id="btn-marcar-todas-lidas" class="btn-text">Marcar todas como lidas</button>
                            <button id="btn-verificar-notificacoes" class="btn-text" style="margin-left: 10px;">
                                <i class="fas fa-sync-alt"></i> Verificar Agora
                            </button>
                        </div>
                    </div>
                    <div id="lista-notificacoes" class="lista-notificacoes">
                        <!-- Notifica√ß√µes ser√£o carregadas aqui -->
                    </div>
                    <div class="dropdown-footer">
                        <a href="#" id="btn-ver-todas-notificacoes">Ver todas as notifica√ß√µes</a>
                    </div>
                </div>
            </div>
            
            <div class="user-info">
                <img id="presidentPhoto" src="https://drive.google.com/thumbnail?id=1YsOaQewTX-_-K2fZGdF7omP8L68jvsNP&sz=w400" alt="Geraldina Francisco">
                <div>
                    <div style="font-weight: 600;">Geraldina Francisco</div>
                    <div style="font-size: 12px; color: var(--gray);">Presidente</div>
                </div>
            </div>
        </div>

        <!-- ===== CONTENT AREA ===== -->
        <div class="content">
            <!-- Resumo Financeiro Content (inicialmente vis√≠vel) -->
            <div id="resumo-financeiro-content" style="display: block;">
                <div class="page-title">
                    <h1><i class="fas fa-chart-line"></i> Resumo Financeiro</h1>
                    <div>
                        <button class="btn btn-primary" id="btn-nova-transacao"><i class="fas fa-plus"></i> Nova Transa√ß√£o</button>
                        <button class="btn btn-success" id="btn-exportar-relatorio"><i class="fas fa-download"></i> Exportar Relat√≥rio PDF</button>
                    </div>
                </div>

                <!-- Cards com Barras de Progresso -->
                <div class="cards">
                    <div class="card">
                        <div class="card-header">
                            <h3>SALDO ACTUAL</h3>
                            <span class="card-percent up" id="percent-saldo">0,0%</span>
                        </div>
                        <div class="value" id="saldo-atual">0,00 Kz</div>
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill up" style="width: 65%"></div>
                            </div>
                            <div class="progress-info">
                                <span class="trend up"><i class="fas fa-arrow-up"></i> 0,0% desde o √∫ltimo m√™s</span>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3>RECEITAS DO M√äS</h3>
                            <span class="card-percent up" id="percent-receitas">0,0%</span>
                        </div>
                        <div class="value" id="receitas-mes">0,00 Kz</div>
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill up" style="width: 0%"></div>
                            </div>
                            <div class="progress-info">
                                <span class="trend up"><i class="fas fa-arrow-up"></i> 0,0% desde o √∫ltimo m√™s</span>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3>DESPESAS DO M√äS</h3>
                            <span class="card-percent down" id="percent-despesas">0,0%</span>
                        </div>
                        <div class="value" id="despesas-mes">0,00 Kz</div>
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill down" style="width: 0%"></div>
                            </div>
                            <div class="progress-info">
                                <span class="trend down"><i class="fas fa-arrow-down"></i> 0,0% desde o √∫ltimo m√™s</span>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3>SALDO PREVISTO</h3>
                            <span class="card-percent up" id="percent-previsto">0,0%</span>
                        </div>
                        <div class="value" id="saldo-previsto">0,00 Kz</div>
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill up" style="width: 0%"></div>
                            </div>
                            <div class="progress-info">
                                <span class="trend up"><i class="fas fa-arrow-up"></i> 0,0% at√© final do m√™s</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="charts">
                    <div class="chart-container">
                        <div class="chart-title">Evolu√ß√£o de Receitas e Despesas</div>
                        <canvas id="fluxoCaixaChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Distribui√ß√£o de Despesas por Categoria</div>
                        <canvas id="categoriasDespesasChart"></canvas>
                    </div>
                </div>

                <!-- Transa√ß√µes Recentes -->
                <div class="page-title">
                    <h1><i class="fas fa-exchange-alt"></i> Transa√ß√µes Recentes</h1>
                </div>

                <div class="table-container">
                    <table id="tabela-transacoes-recentes">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Descri√ß√£o</th>
                                <th>Natureza</th>
                                <th>Tipo</th>
                                <th>Valor</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="corpo-tabela-transacoes-recentes">
                            <!-- As transa√ß√µes recentes ser√£o inseridas aqui via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Transa√ß√µes Content -->
            <div id="transacoes-content" style="display: none;">
                <div class="page-title">
                    <h1><i class="fas fa-exchange-alt"></i> Transa√ß√µes / Controlo</h1>
                    <button class="btn btn-primary" id="btn-nova-transacao-lista"><i class="fas fa-plus"></i> Nova Transa√ß√£o</button>
                </div>

                <!-- Filtros -->
                <div class="filters">
                    <div class="filter-group">
                        <label for="filter-periodo-transacoes">Per√≠odo</label>
                        <select id="filter-periodo-transacoes" class="form-control">
                            <option value="mes">Este M√™s</option>
                            <option value="trimestre">Este Trimestre</option>
                            <option value="semestre">Este Semestre</option>
                            <option value="ano">Este Ano</option>
                            <option value="todos">Todos</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filter-tipo-transacoes">Tipo</label>
                        <select id="filter-tipo-transacoes" class="form-control">
                            <option value="">Todos os tipos</option>
                            <option value="receita">Receita</option>
                            <option value="despesa">Despesa</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filter-categoria-transacoes">Natureza</label>
                        <select id="filter-categoria-transacoes" class="form-control">
                            <option value="">Todas as categorias</option>
                            <option value="quotas">Quotas</option>
                            <option value="formacoes">Forma√ß√µes</option>
                            <option value="eventos">Eventos</option>
                            <option value="infraestrutura">Infraestrutura</option>
                            <option value="pessoal">Pessoal</option>
                            <option value="outros">Outros</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>&nbsp;</label>
                        <button class="btn btn-primary" id="btn-aplicar-filtros-transacoes">Aplicar Filtros</button>
                    </div>
                </div>

                <!-- Tabela de Transa√ß√µes -->
                <div class="table-container">
                    <table id="tabela-transacoes">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Descri√ß√£o</th>
                                <th>Natureza</th>
                                <th>Tipo</th>
                                <th>Valor</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="corpo-tabela-transacoes">
                            <!-- As transa√ß√µes ser√£o inseridas aqui via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Controlo de Pagamento Content -->
            <div id="gestao-membros-content" style="display: none;">
                <div class="page-title">
                    <h1><i class="fa fa-credit-card"></i> Controlo de Pagamento</h1>
                </div>

                <!-- Filtros -->
                <div class="filters">
                    <div class="filter-group">
                        <label for="filter-categoria">Categoria</label>
                        <select id="filter-categoria" class="form-control">
                            <option value="">Todas as categorias</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filter-status">Status</label>
                        <select id="filter-status" class="form-control">
                            <option value="">Todos os status</option>
                            <option value="Regular">Regular</option>
                            <option value="Suspenso">Suspenso</option>
                            <option value="Pendente">Pendente</option>
                            <option value="D√≠vida">D√≠vida</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filter-nome">Nome do Membro</label>
                        <input type="text" id="filter-nome" class="form-control" placeholder="Digite o nome...">
                    </div>
                    <div class="filter-group">
                        <label>&nbsp;</label>
                        <button class="btn btn-primary" id="btn-aplicar-filtros-membros">
                            Aplicar Filtros
                        </button>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="tabs">
                    <div class="tab active" data-tab="todos">Todos os Membros</div>
                    <div class="tab" data-tab="regulares">Membros Regulares</div>
                    <div class="tab" data-tab="suspensos">Membros Suspensos</div>
                    <div class="tab" data-tab="pendentes">Membros Pendentes</div>
                    <div class="tab" data-tab="divida">Membros em D√≠vida</div>
                </div>

                <!-- Tabela de Membros -->
                <div class="table-container">
                    <table id="tabela-membros">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Categoria</th>
                                <th>Data Admiss√£o</th>
                                <th>N√∫mero de Membro</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="corpo-tabela-membros">
                            <!-- Os membros ser√£o inseridos aqui via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Facturas Content -->
            <div id="facturas-content" style="display: none;">
                <div class="page-title">
                    <h1><i class="fas fa-file-invoice"></i> Emiss√£o e Controlo de Facturas</h1>
                    <button class="btn btn-primary" id="btn-nova-factura"><i class="fas fa-plus"></i> Emitir Nova Factura</button>
                </div>

                <!-- Filtros -->
                <div class="filters">
                    <div class="filter-group">
                        <label for="filter-nome-factura">Nome do Associado / Outro</label>
                        <input type="text" id="filter-nome-factura" class="form-control" placeholder="Buscar por nome...">
                    </div>
                    <div class="filter-group">
                        <label for="filter-data-factura">Data</label>
                        <input type="date" id="filter-data-factura" class="form-control">
                    </div>
                    <div class="filter-group">
                        <label>&nbsp;</label>
                        <button class="btn btn-primary" id="btn-aplicar-filtros-facturas">Aplicar Filtros</button>
                    </div>
                </div>

                <!-- Tabela de Facturas -->
                <div class="table-container">
                    <table id="tabela-facturas">
                        <thead>
                            <tr>
                                <th>N¬∫ Factura</th>
                                <th>Data</th>
                                <th>Associado</th>
                                <th>Valor</th>
                                <th>Estado</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="corpo-tabela-facturas">
                            <!-- As facturas ser√£o inseridas aqui via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Relat√≥rios Financeiros Content -->
            <div id="relatorios-financeiros-content" style="display: none;">
                <div class="page-title">
                    <h1><i class="fas fa-file-invoice-dollar"></i> Relat√≥rios Financeiros</h1>
                    <button class="btn btn-primary" id="btn-gerar-relatorio"><i class="fas fa-plus"></i> Novo Relat√≥rio</button>
                </div>

                <!-- Filtros para Relat√≥rios -->
                <div class="filters">
                    <div class="filter-group">
                        <label for="filter-tipo-relatorio">Tipo de Relat√≥rio</label>
                        <select id="filter-tipo-relatorio" class="form-control">
                            <option value="">Todos os tipos</option>
                            <option value="mensal">Mensal</option>
                            <option value="trimestral">Trimestral</option>
                            <option value="semestral">Semestral</option>
                            <option value="anual">Anual</option>
                            <option value="balanco">Balan√ßo Patrimonial</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="filter-autor-relatorio">Autor</label>
                        <input type="text" id="filter-autor-relatorio" class="form-control" placeholder="Buscar por autor...">
                    </div>
                    <div class="filter-group">
                        <label>&nbsp;</label>
                        <button class="btn btn-primary" id="btn-aplicar-filtros-relatorios">Aplicar Filtros</button>
                        <button class="btn btn-warning" id="btn-limpar-filtros-relatorios" style="margin-left: 10px;">Limpar</button>
                    </div>
                </div>

                <!-- Cards de Relat√≥rios -->
                <div class="cards">
                    <div class="card">
                        <h3>RELAT√ìRIO MENSAL</h3>
                        <div class="value">0</div>
                        <div class="trend">Relat√≥rios dispon√≠veis</div>
                    </div>
                    <div class="card">
                        <h3>RELAT√ìRIO TRIMESTRAL</h3>
                        <div class="value">0</div>
                        <div class="trend">Relat√≥rios dispon√≠veis</div>
                    </div>
                    <div class="card">
                        <h3>RELAT√ìRIO ANUAL</h3>
                        <div class="value">0</div>
                        <div class="trend">Relat√≥rios dispon√≠veis</div>
                    </div>
                    <div class="card">
                        <h3>BALAN√áO PATRIMONIAL</h3>
                        <div class="value">0</div>
                        <div class="trend">√öltima atualiza√ß√£o: Dez/2025</div>
                    </div>
                </div>

                <!-- Tabela de Relat√≥rios -->
                <div class="table-container">
                    <table id="tabela-relatorios">
                        <thead>
                            <tr>
                                <th>Nome do Relat√≥rio</th>
                                <th>Tipo</th>
                                <th>Per√≠odo</th>
                                <th>Data</th>
                                <th>Autor</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="corpo-tabela-relatorios">
                            <!-- Os relat√≥rios ser√£o inseridos aqui via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Or√ßamento Content -->
            <div id="or√ßamento-content" style="display: none;">
                <div class="page-title">
                    <h1><i class="fas fa-money-bill-wave"></i> Or√ßamento</h1>
                    <div>
                        <button class="btn btn-primary" id="btn-novo-orcamento"><i class="fas fa-plus"></i> Novo Or√ßamento</button>
                        <button class="btn btn-success" id="btn-previsao-saldo"><i class="fas fa-chart-line"></i> Previs√£o de Saldo</button>
                    </div>
                </div>

                <!-- Cards de Or√ßamento -->
                <div class="cards">
                    <div class="card">
                        <h3>OR√áAMENTO ANUAL</h3>
                        <div class="value">0,00 Kz</div>
                        <div class="trend">Para 2025</div>
                    </div>
                    <div class="card">
                        <h3>OR√áAMENTO REALIZADO</h3>
                        <div class="value">0,00 Kz</div>
                        <div class="trend">39,8% do or√ßamento anual</div>
                    </div>
                    <div class="card">
                        <h3>OR√áAMENTO RESTANTE</h3>
                        <div class="value">0,00 Kz</div>
                        <div class="trend">60,2% do or√ßamento anual</div>
                    </div>
                    <div class="card">
                        <h3>PROJE√á√ÉO DE SALDO</h3>
                        <div class="value">0,00 Kz</div>
                        <div class="trend">At√© final de 2025</div>
                    </div>
                </div>

                <!-- Charts de Or√ßamento -->
                <div class="charts">
                    <div class="chart-container">
                        <div class="chart-title">Execu√ß√£o Or√ßamental por Categoria</div>
                        <canvas id="execucaoOrcamentoChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Compara√ß√£o Or√ßamentado vs Realizado</div>
                        <canvas id="comparacaoOrcamentoChart"></canvas>
                    </div>
                </div>

                <!-- Tabela de Or√ßamento -->
                <div class="table-container">
                    <table id="tabela-orcamento">
                        <thead>
                            <tr>
                                <th>Nome do Or√ßamento</th>
                                <th>Or√ßamentado</th>
                                <th>Realizado</th>
                                <th>Diferen√ßa</th>
                                <th>% Realizado</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="corpo-tabela-orcamento">
                            <!-- Os dados do or√ßamento ser√£o inseridos aqui via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Configura√ß√µes Content -->
            <div id="configuracoes-content" style="display: none;">
                <div class="page-title">
                    <h1><i class="fas fa-cogs"></i> Configura√ß√µes</h1>
                </div>

                <div class="table-container">
                    <div style="text-align: center; padding: 80px 20px; color: var(--gray);">
                        <i class="fas fa-tools" style="font-size: 80px; margin-bottom: 20px; color: var(--warning);"></i>
                        <h2 style="color: var(--primary); margin-bottom: 15px;">Configura√ß√µes em Desenvolvimento</h2>
                        <p style="font-size: 16px; max-width: 500px; margin: 0 auto;">
                            As configura√ß√µes do sistema est√£o sendo desenvolvidas e estar√£o dispon√≠veis em breve.<br>
                            Aguarde pelas atualiza√ß√µes!
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== MODALS ===== -->
    
    <!-- Modal para Nova Transa√ß√£o -->
    <div id="modal-transacao" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-titulo-transacao">Nova Transa√ß√£o</h2>
                <button id="btn-fechar-modal-transacao" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-transacao">
                    <input type="hidden" id="transacao-id">

                    <div class="form-group">
                        <label for="transacao-tipo">Tipo</label>
                        <select id="transacao-tipo" class="form-control" required>
                            <option value="">Selecione o tipo</option>
                            <option value="receita">Receita</option>
                            <option value="despesa">Despesa</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="transacao-categoria">Natureza</label>
                        <select id="transacao-categoria" class="form-control" required>
                            <option value="">Selecione a categoria</option>
                            <option value="quotas">Quotas</option>
                            <option value="formacoes">Forma√ß√µes</option>
                            <option value="eventos">Eventos</option>
                            <option value="infraestrutura">Infraestrutura</option>
                            <option value="transporte">Transporte</option>
                            <option value="alimentacao">Alimenta√ß√£o</option>
                            <option value="hospedagem">Hospedagem</option>
                            <option value="aluguer">Aluguer</option>
                            <option value="material">Material</option>
                            <option value="estado">Estado</option>
                            <option value="privado">Privado</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="transacao-descricao">Descri√ß√£o</label>
                        <input type="text" id="transacao-descricao" class="form-control" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="transacao-valor">Valor (Kz)</label>
                            <input type="number" id="transacao-valor" class="form-control" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="transacao-data">Data</label>
                            <input type="date" id="transacao-data" class="form-control" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="transacao-status">Status</label>
                        <select id="transacao-status" class="form-control" required>
                            <option value="pago">Pago</option>
                            <option value="pendente">Pendente</option>
                            <option value="atrasado">Atrasado</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="transacao-observacoes">Observa√ß√µes</label>
                        <textarea id="transacao-observacoes" class="form-control" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" id="btn-cancelar-transacao">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btn-salvar-transacao">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Nova Factura -->
    <div id="modal-factura" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 id="modal-titulo-factura">Emitir Nova Factura</h2>
                <button id="btn-fechar-modal-factura" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-factura">
                    <input type="hidden" id="factura-id">

                    <div class="form-row">
                        <div class="form-group">
                            <label for="factura-numero">N¬∫ Factura</label>
                            <input type="text" id="factura-numero" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="factura-data">Data de Emiss√£o</label>
                            <input type="text" id="factura-data" class="form-control" readonly style="background-color: #f8f9fa;">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="factura-cliente">Nome do Associado *</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="factura-cliente" class="form-control" required
                                   list="lista-associados" autocomplete="off" placeholder="Digite o nome...">
                            <button type="button" class="btn btn-warning" onclick="carregarMembrosParaFacturas()"
                                    title="Recarregar lista de membros" style="white-space: nowrap;">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                        <datalist id="lista-associados">
                            <!-- Ser√° preenchido dinamicamente -->
                        </datalist>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="factura-categoria">Natureza</label>
                            <select id="factura-categoria" class="form-control">
                                <option value="quotas">Quotas</option>
                                <option value="formacoes">Forma√ß√µes</option>
                                <option value="eventos">Eventos</option>
                                <option value="transporte">Transporte</option>
                                <option value="alimentacao">Alimenta√ß√£o</option>
                                <option value="hospedagem">Hospedagem</option>
                                <option value="material">Material</option>
                                <option value="estado">Estado</option>
                                <option value="privado">Privado</option>
                                <option value="outros">Outros</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="factura-funcao">Fun√ß√£o</label>
                            <input type="text" id="factura-funcao" class="form-control">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="factura-numero-membro">N¬∫ de Membro</label>
                            <input type="text" id="factura-numero-membro" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="factura-periodo">Pagamento Referente *</label>
                            <input type="month" id="factura-periodo" class="form-control" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="factura-quota">Quota (kz) / Valor (kz) *</label>
                            <input type="number" id="factura-quota" class="form-control" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="factura-multa">Multa (kz)</label>
                            <input type="number" id="factura-multa" class="form-control" step="0.01" value="0">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="factura-joia">Joia de Inscri√ß√£o (kz)</label>
                        <input type="number" id="factura-joia" class="form-control" step="0.01" value="0">
                    </div>

                    <div class="form-group">
                        <label for="factura-descricao">Descri√ß√£o</label>
                        <textarea id="factura-descricao" class="form-control" rows="3"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="factura-estado">Estado *</label>
                        <select id="factura-estado" class="form-control" required>
                            <option value="">Selecione o estado</option>
                            <option value="pendente">Pendente</option>
                            <option value="pago">Pago</option>
                            <option value="cancelado">Cancelado</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Total: <span id="factura-total">0.00 Kz</span></label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" id="btn-cancelar-factura">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btn-salvar-factura">Salvar</button>
                <button type="button" class="btn btn-success" id="btn-imprimir-factura"><i class="fas fa-print"></i> Imprimir PDF</button>
            </div>
        </div>
    </div>

    <!-- Modal para Novo Relat√≥rio -->
    <div id="modal-novo-relatorio" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>Novo Relat√≥rio Financeiro</h2>
                <button id="btn-fechar-modal-relatorio" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-novo-relatorio">
                    <div class="form-group">
                        <label for="relatorio-nome">Nome do Relat√≥rio *</label>
                        <input type="text" id="relatorio-nome" class="form-control" required placeholder="Ex: Relat√≥rio Financeiro Mensal - Junho 2025">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="relatorio-tipo">Tipo *</label>
                            <select id="relatorio-tipo" class="form-control" required>
                                <option value="">Selecione o tipo</option>
                                <option value="mensal">Mensal</option>
                                <option value="trimestral">Trimestral</option>
                                <option value="semestral">Semestral</option>
                                <option value="anual">Anual</option>
                                <option value="balanco">Balan√ßo Patrimonial</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="relatorio-periodo">Per√≠odo *</label>
                            <input type="text" id="relatorio-periodo" class="form-control" required placeholder="Ex: Junho 2025, Q2 2025, 2024">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="relatorio-data">Data de Emiss√£o *</label>
                            <input type="date" id="relatorio-data" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="relatorio-autor">Autor *</label>
                            <input type="text" id="relatorio-autor" class="form-control" required
                                   list="lista-autores" autocomplete="off" placeholder="Digite o nome do autor">
                            <datalist id="lista-autores">
                                <option value="Ant√≥nio Joaquim Suente">
                                <option value="Pedro Manuel Bolela">                                
                            </datalist>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="relatorio-upload">Upload do PDF *</label>
                        <input type="file" id="relatorio-upload" class="form-control"
                               accept=".pdf" required>
                        <small style="color: var(--gray);">Apenas arquivos PDF s√£o permitidos (m√°x. 10MB)</small>
                    </div>

                    <div class="form-group">
                        <label for="relatorio-descricao">Descri√ß√£o</label>
                        <textarea id="relatorio-descricao" class="form-control" rows="3" placeholder="Descri√ß√£o detalhada do relat√≥rio..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" id="btn-cancelar-relatorio">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btn-salvar-relatorio">
                    <i class="fas fa-save"></i> Salvar Relat√≥rio
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para Novo Or√ßamento -->
    <div id="modal-novo-orcamento" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>Novo Or√ßamento</h2>
                <button id="btn-fechar-modal-novo-orcamento" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-novo-orcamento">
                    <div class="form-group">
                        <label for="orcamento-nome">Nome do Or√ßamento *</label>
                        <input type="text" id="orcamento-nome" class="form-control" required placeholder="Ex: Or√ßamento Anual 2025 - Quotas">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="orcamento-natureza">Natureza *</label>
                            <select id="orcamento-natureza" class="form-control" required>
                                <option value="">Selecione a natureza</option>
                                <option value="Quotas">Quotas</option>
                                <option value="Forma√ß√µes">Forma√ß√µes</option>
                                <option value="Eventos">Eventos</option>
                                <option value="Infraestrutura">Infraestrutura</option>
                                <option value="Pessoal">Pessoal</option>
                                <option value="Outros">Outros</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="orcamento-valor">Or√ßamento (kz) *</label>
                            <input type="number" id="orcamento-valor" class="form-control" step="0.01" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="orcamento-descricao">Descri√ß√£o</label>
                        <textarea id="orcamento-descricao" class="form-control" rows="3" placeholder="Descri√ß√£o detalhada do or√ßamento..."></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="orcamento-data-aprovacao">Data de Aprova√ß√£o *</label>
                            <input type="date" id="orcamento-data-aprovacao" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="orcamento-data-inicio">Data de In√≠cio *</label>
                            <input type="date" id="orcamento-data-inicio" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="orcamento-data-fim">Data de Fim *</label>
                            <input type="date" id="orcamento-data-fim" class="form-control" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" id="btn-cancelar-novo-orcamento">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btn-salvar-novo-orcamento">
                    <i class="fas fa-save"></i> Salvar Or√ßamento
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para Visualizar Or√ßamento -->
    <div id="modal-visualizar-orcamento" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>Detalhes do Or√ßamento</h2>
                <button id="btn-fechar-modal-visualizar-orcamento" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            <div class="modal-body">
                <div id="detalhes-orcamento">
                    <!-- Detalhes ser√£o inseridos aqui via JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="btn-fechar-visualizar-orcamento">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Previs√£o de Saldo -->
    <div id="modal-previsao-saldo" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Previs√£o de Saldo</h2>
                <button id="btn-fechar-modal-previsao-saldo" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-previsao-saldo">
                    <div class="form-group">
                        <label for="previsao-saldo-valor">Saldo Previsto (kz) *</label>
                        <input type="number" id="previsao-saldo-valor" class="form-control" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="previsao-saldo-data">Data de Previs√£o *</label>
                        <input type="date" id="previsao-saldo-data" class="form-control" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" id="btn-cancelar-previsao-saldo">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btn-salvar-previsao-saldo">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Or√ßamento -->
    <div id="modal-editar-orcamento" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Editar Or√ßamento</h2>
                <button id="btn-fechar-modal-editar-orcamento" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-editar-orcamento">
                    <input type="hidden" id="editar-orcamento-id">
                    <input type="hidden" id="editar-orcamento-valor-atual">

                    <div class="form-group">
                        <label for="editar-orcamento-status">Status *</label>
                        <input type="text" id="editar-orcamento-status" class="form-control"
                               list="lista-status-orcamento" autocomplete="off" required>
                        <datalist id="lista-status-orcamento">
                            <option value="Normal">
                            <option value="Aten√ß√£o">
                            <option value="Alerta">
                            <option value="Anulado">
                            <option value="Suspenso">
                        </datalist>
                    </div>

                    <div class="form-group">
                        <label for="editar-orcamento-realizado">Realizado (kz) *</label>
                        <input type="number" id="editar-orcamento-realizado" class="form-control" step="0.01" required>
                        <small style="color: var(--gray);">Valor m√≠nimo: <span id="minimo-realizado">0</span> kz</small>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="editar-orcamento-data-inicio">Data de In√≠cio *</label>
                            <input type="date" id="editar-orcamento-data-inicio" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="editar-orcamento-data-fim">Data de Fim *</label>
                            <input type="date" id="editar-orcamento-data-fim" class="form-control" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" id="btn-cancelar-editar-orcamento">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btn-salvar-editar-orcamento">
                    <i class="fas fa-save"></i> Salvar Altera√ß√µes
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Membro -->
    <div id="modal-membro" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-titulo">Editar Membro</h2>
                <button id="btn-fechar-modal" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-membro">
                    <input type="hidden" id="membro-id">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nome">Nome</label>
                            <input type="text" id="nome" class="form-control" required readonly>
                        </div>
                        <div class="form-group">
                            <label for="numero-membro">N√∫mero de Membro</label>
                            <input type="text" id="numero-membro" class="form-control" readonly>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="categoria">Categoria</label>
                            <input type="text" id="categoria" class="form-control" readonly>
                        </div>
                        <div class="form-group">
                            <label for="telefone">Telefone</label>
                            <input type="text" id="telefone" class="form-control" readonly>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="status">Status</label>
                        <select id="status" class="form-control" required>
                            <option value="">Selecione...</option>
                            <option value="Regular">Regular</option>
                            <option value="Suspenso">Suspenso</option>
                            <option value="Pendente">Pendente</option>
                            <option value="D√≠vida">D√≠vida</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status de Pagamento</label>
                        <div class="payment-status">
                            <button type="button" class="payment-btn overdue" id="btn-em-divida" style="display: none;">
                                <i class="fas fa-exclamation-triangle"></i> D√≠vida
                            </button>
                            <button type="button" class="payment-btn paid" id="btn-pagou">
                                <i class="fas fa-check"></i> Pagou
                            </button>
                        </div>
                        <div id="info-pagamento" style="margin-top: 10px; font-size: 14px; color: var(--gray);"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" id="btn-cancelar">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btn-salvar-membro">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Visualizar Membro -->
    <div id="modal-ver-membro" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>Detalhes do Membro</h2>
                <button id="btn-fechar-modal-ver" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            <div class="modal-body" id="modal-ver-corpo">
                <!-- As informa√ß√µes do membro ser√£o inseridas aqui -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" id="btn-fechar-ver">Fechar</button>
            </div>
        </div>
    </div>

    <script>
        // ===== CONFIGURA√á√ÉO DO BACKEND =====
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbxN3yGz_oTMzxB-6_PvQtsZQmYftTltqWwWg9lEx_XHacpUnZx_tKzEEVrfrTzsKRlWwQ/exec';
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw4NklQ1lF4Uq8yqPm35qeJ7kjE1c1E7YLVfMEa-h3WjsGOT0Gi5KtHz8PoDy1-Mo4/exec';
        const MEMBROS_GAS_URL = 'https://script.google.com/macros/s/AKfycbw4NklQ1lF4Uq8yqPm35qeJ7kjE1c1E7YLVfMEa-h3WjsGOT0Gi5KtHz8PoDy1-Mo4/exec';
	const AUTH_GAS_URL = 'https://script.google.com/macros/s/AKfycbzhCq6YKeV7li8sJHHcLTeDbaGpAJsFjEoAS_yE3aOuqZWW6p-T2emWo_Rdgkez6AsF/exec';
	
        let carregandoDados = false;
        let listaMembrosCompleta = [];
	let isAuthenticated = false;


        // ===== DADOS INICIAIS =====
        let transacoes = [];
        let facturas = [];
        let relatorios = [];
        let orcamento = [];
        let membros = JSON.parse(localStorage.getItem('membros')) || [];
        let notificacoes = JSON.parse(localStorage.getItem('notificacoes')) || [];
        let currentFilters = {
            categoria: '',
            status: '',
            nome: ''
        };

        // ===== VARI√ÅVEIS DE CONTROLE =====
        
        let chartsInicializados = false; 

        let dadosCarregados = {
            transacoes: false,
            facturas: false,
            relatorios: false,
            orcamento: false,
            dashboard: false
        };

        
        // ===== RESET GLOBAL DOS GR√ÅFICOS =====
        // Garantir que as vari√°veis dos gr√°ficos estejam limpas
        window.fluxoCaixaChart = undefined;
        window.categoriasDespesasChart = undefined;
        window.execucaoOrcamentoChart = undefined;
        window.comparacaoOrcamentoChart = undefined;
        // REMOVA a linha abaixo - chartsInicializados j√° √© declarado mais adiante

        console.log('üîÑ Vari√°veis dos gr√°ficos resetadas');

        // TESTE R√ÅPIDO - adicione no final do arquivo
        async function testarNovoGAS() {
            console.log('üß™ Testando novo GAS de membros...');

            // Teste 1: Ping
            const pingUrl = `${MEMBROS_GAS_URL}?action=ping`;
            console.log('üîó URL do ping:', pingUrl);

            try {
                const pingResponse = await fetch(pingUrl);
                const pingResult = await pingResponse.json();
                console.log('‚úÖ Ping OK:', pingResult);
            } catch (error) {
                console.error('‚ùå Erro no ping:', error);
            }

            // Teste 2: Membros
            const membrosUrl = `${MEMBROS_GAS_URL}?action=getMembers`;
            console.log('üîó URL dos membros:', membrosUrl);

            try {
                const membrosResponse = await fetch(membrosUrl);
                const membrosResult = await membrosResponse.json();
                console.log('‚úÖ Membros recebidos:', membrosResult);

                if (membrosResult.success) {
                    console.log(`üìä Total de membros: ${membrosResult.total}`);
                    if (membrosResult.members && membrosResult.members.length > 0) {
                        console.log('üë§ Primeiro membro:', membrosResult.members[0]);
                    }
                }
            } catch (error) {
                console.error('‚ùå Erro nos membros:', error);
            }
        }

        // Executar teste ap√≥s 5 segundos
        setTimeout(testarNovoGAS, 5000);


        // ===== FUN√á√ïES GERAIS =====



        function formatarValor(valor) {
            return new Intl.NumberFormat('pt-AO', { style: 'decimal', minimumFractionDigits: 2 }).format(valor) + ' Kz';
        }

        function formatarData(dataString) {
            if (!dataString) return '';

            // Usar nosso parser personalizado
            const data = parsearDataPortugues(dataString);

            if (isNaN(data.getTime())) {
                console.error('‚ùå Data inv√°lida em formatarData:', dataString);
                return dataString;
            }

            const dia = String(data.getDate()).padStart(2, '0');
            const mes = String(data.getMonth() + 1).padStart(2, '0');
            const ano = data.getFullYear();
            return `${dia}/${mes}/${ano}`;
        }

        function formatarTempoRelativo(dataString) {
            const data = new Date(dataString);
            const agora = new Date();
            const diferencaSegundos = Math.floor((agora - data) / 1000);

            if (diferencaSegundos < 60) return 'Agora mesmo';
            if (diferencaSegundos < 3600) return `H√° ${Math.floor(diferencaSegundos / 60)} minutos`;
            if (diferencaSegundos < 86400) return `H√° ${Math.floor(diferencaSegundos / 3600)} horas`;
            if (diferencaSegundos < 2592000) return `H√° ${Math.floor(diferencaSegundos / 86400)} dias`;
            return formatarData(dataString);
        }

        function parsearDataPortugues(dataString) {
            if (!dataString) return null;

            // Se j√° for YYYY-MM-DD, retorna direto
            if (dataString.includes('-')) {
                const partes = dataString.split('-');
                if (partes.length === 3) {
                    return new Date(partes[0], partes[1] - 1, partes[2]);
                }
            }

            // Para formato DD/MM/YYYY
            const partes = dataString.split('/');
            if (partes.length === 3) {
                const dia = parseInt(partes[0], 10);
                const mes = parseInt(partes[1], 10) - 1; // Meses s√£o 0-indexados
                const ano = parseInt(partes[2], 10);

                console.log(`üîÑ Convertendo "${dataString}" ‚Üí Dia: ${dia}, M√™s: ${mes + 1}, Ano: ${ano}`);
                return new Date(ano, mes, dia);
            }

            // Tenta o parser nativo como fallback
            return new Date(dataString);
        }

// ===== FUN√á√ïES DE AUTENTICA√á√ÉO =====
function mostrarModalLogin() {
    console.log('üîí Mostrando modal de login...');
    const loginModal = document.getElementById('login-modal');
    if (loginModal) {
        loginModal.classList.remove('hidden');
        document.body.classList.add('login-active');
        
        // Focar no campo de senha
        setTimeout(() => {
            document.getElementById('login-password').focus();
        }, 300);
    }
}

function esconderModalLogin() {
    console.log('‚úÖ Escondendo modal de login...');
    const loginModal = document.getElementById('login-modal');
    if (loginModal) {
        loginModal.classList.add('hidden');
        document.body.classList.remove('login-active');
    }
}

async function validarSenha(senha) {
    try {
        mostrarLoading('Validando senha...');
        
        // Enviar como texto simples, n√£o como JSON puro
        const dados = {
            action: 'validateDashboardPassword',
            password: senha,
            department: 'DPF'
        };
        
        // Formato especial para GAS - texto plano que parece JSON
        const xhr = new XMLHttpRequest();
        xhr.open('POST', AUTH_GAS_URL);
        
        // Importante: enviar como texto simples
        xhr.setRequestHeader('Content-Type', 'text/plain; charset=UTF-8');
        
        return new Promise((resolve, reject) => {
            xhr.onload = function() {
                esconderLoading();
                if (xhr.status === 200) {
                    try {
                        const resultado = JSON.parse(xhr.responseText);
                        console.log('üîë Resposta da autentica√ß√£o:', resultado);
                        resolve(resultado);
                    } catch (e) {
                        console.error('Erro ao analisar JSON:', e);
                        reject({ 
                            success: false, 
                            valid: false, 
                            message: 'Resposta inv√°lida do servidor' 
                        });
                    }
                } else {
                    reject({ 
                        success: false, 
                        valid: false, 
                        message: 'Erro HTTP ' + xhr.status 
                    });
                }
            };
            
            xhr.onerror = function() {
                esconderLoading();
                console.error('Erro de rede no XHR');
                reject({ 
                    success: false, 
                    valid: false, 
                    message: 'Erro de conex√£o com o servidor' 
                });
            };
            
            // Enviar como string JSON (n√£o como URLSearchParams)
            xhr.send(JSON.stringify(dados));
        });
        
    } catch (error) {
        esconderLoading();
        console.error('‚ùå Erro na autentica√ß√£o:', error);
        return {
            success: false,
            valid: false,
            message: 'Erro ao processar requisi√ß√£o'
        };
    }
}
		
function mostrarErroLogin(mensagem) {
    const errorElement = document.getElementById('login-error-message');
    const errorText = document.getElementById('login-error-text');
    const successElement = document.getElementById('login-success-message');
    
    if (errorElement && errorText) {
        errorText.textContent = mensagem;
        errorElement.style.display = 'block';
    }
    
    if (successElement) {
        successElement.style.display = 'none';
    }
}

function mostrarSucessoLogin() {
    const errorElement = document.getElementById('login-error-message');
    const successElement = document.getElementById('login-success-message');
    
    if (errorElement) {
        errorElement.style.display = 'none';
    }
    
    if (successElement) {
        successElement.style.display = 'block';
    }
}

function resetarMensagensLogin() {
    const errorElement = document.getElementById('login-error-message');
    const successElement = document.getElementById('login-success-message');
    
    if (errorElement) {
        errorElement.style.display = 'none';
    }
    
    if (successElement) {
        successElement.style.display = 'none';
    }
}

async function fazerLogin() {
    const senha = document.getElementById('login-password').value.trim();
    const btnLogin = document.getElementById('btn-login-submit');
    
    if (!senha) {
        mostrarErroLogin('Por favor, insira a senha de acesso');
        return;
    }
    
    // Desabilitar bot√£o durante a valida√ß√£o
    if (btnLogin) {
        btnLogin.disabled = true;
        btnLogin.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Validando...';
    }
    
    resetarMensagensLogin();
    
    try {
        const resultado = await validarSenha(senha);
        
        if (resultado.success && resultado.valid) {
            // Login bem-sucedido
            mostrarSucessoLogin();
            isAuthenticated = true;
            
            // Salvar estado de autentica√ß√£o na sess√£o
            sessionStorage.setItem('dpf_authenticated', 'true');
            sessionStorage.setItem('dpf_auth_timestamp', Date.now().toString());
            
            // Mostrar mensagem de boas-vindas
            mostrarToast('Bem-vindo(a)!', 'Acesso concedido ao sistema de gest√£o financeira.', 'sucesso');
            
            // Aguardar um pouco para mostrar a mensagem de sucesso
            setTimeout(() => {
                esconderModalLogin();
                
                // Restaurar bot√£o
                if (btnLogin) {
                    btnLogin.disabled = false;
                    btnLogin.innerHTML = '<i class="fas fa-sign-in-alt"></i> Entrar no Sistema';
                }
                
                // Inicializar sistema normalmente
                inicializarSistemaCompleto();
                
            }, 1500);
            
        } else {
            // Login falhou
            mostrarErroLogin(resultado.message || 'Senha incorreta!');
            
            // Limpar campo de senha
            document.getElementById('login-password').value = '';
            document.getElementById('login-password').focus();
            
            // Restaurar bot√£o
            if (btnLogin) {
                btnLogin.disabled = false;
                btnLogin.innerHTML = '<i class="fas fa-sign-in-alt"></i> Entrar no Sistema';
            }
        }
        
    } catch (error) {
        console.error('Erro no processo de login:', error);
        mostrarErroLogin('Erro durante a autentica√ß√£o');
        
        // Restaurar bot√£o
        if (btnLogin) {
            btnLogin.disabled = false;
            btnLogin.innerHTML = '<i class="fas fa-sign-in-alt"></i> Entrar no Sistema';
        }
    }
}

function configurarEventosLogin() {
    const btnLogin = document.getElementById('btn-login-submit');
    const inputSenha = document.getElementById('login-password');
    const loginForm = document.getElementById('login-form');
    
    if (btnLogin) {
        btnLogin.addEventListener('click', fazerLogin);
    }
    
    if (inputSenha) {
        inputSenha.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                fazerLogin();
            }
        });
    }
    
    if (loginForm) {
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            fazerLogin();
        });
    }
}

function verificarSessaoAtiva() {
    const autenticado = sessionStorage.getItem('dpf_authenticated');
    const timestamp = sessionStorage.getItem('dpf_auth_timestamp');
    
    if (autenticado === 'true' && timestamp) {
        const agora = Date.now();
        const tempoSessao = agora - parseInt(timestamp);
        const horas = tempoSessao / (1000 * 60 * 60);
        
        // Sess√£o v√°lida por 8 horas
        if (horas < 8) {
            console.log('‚úÖ Sess√£o ativa encontrada');
            return true;
        } else {
            // Sess√£o expirada
            sessionStorage.removeItem('dpf_authenticated');
            sessionStorage.removeItem('dpf_auth_timestamp');
        }
    }
    
    return false;
}

function inicializarSistemaCompleto() {
    console.log('üöÄ Inicializando sistema completo...');
    
    // Inicializar notifica√ß√µes
    inicializarSistemaNotificacoes();
    
    // Configurar eventos
    inicializarEventListeners();
    
    // Carregar dados do dashboard
    setTimeout(() => {
        carregarDadosDashboard();
    }, 500);
    
    // Pr√©-carregar membros
    setTimeout(() => {
        carregarMembrosParaFacturas();
    }, 1000);
}

        // ===== SISTEMA DE NOTIFICA√á√ïES =====
        function inicializarSistemaNotificacoes() {
            console.log('üîî Inicializando sistema de notifica√ß√µes...');

            // Carregar notifica√ß√µes do localStorage
            const notificacoesSalvas = localStorage.getItem('notificacoes');
            if (notificacoesSalvas) {
                try {
                    notificacoes = JSON.parse(notificacoesSalvas);
                    console.log(`üì• ${notificacoes.length} notifica√ß√µes carregadas do localStorage`);
                } catch (e) {
                    console.error('‚ùå Erro ao carregar notifica√ß√µes:', e);
                    notificacoes = [];
                    localStorage.setItem('notificacoes', JSON.stringify(notificacoes));
                }
            } else {
                // Se n√£o houver notifica√ß√µes salvas, inicialize com array vazio
                notificacoes = [];
                localStorage.setItem('notificacoes', JSON.stringify(notificacoes));
                console.log('üìù Notifica√ß√µes inicializadas (vazio)');
            }

            atualizarBadgeNotificacoes();
            carregarNotificacoes();
            configurarVerificacaoAutomatica();

            // Event listeners para o dropdown de notifica√ß√µes
            const btnNotificacoes = document.getElementById('btn-notificacoes');
            const dropdownNotificacoes = document.getElementById('dropdown-notificacoes');

            if (btnNotificacoes) {
                btnNotificacoes.addEventListener('click', toggleDropdownNotificacoes);
            } else {
                console.error('‚ùå Bot√£o de notifica√ß√µes n√£o encontrado!');
            }

            if (dropdownNotificacoes) {
                const btnMarcarTodasLidas = document.getElementById('btn-marcar-todas-lidas');
                const btnVerTodas = document.getElementById('btn-ver-todas-notificacoes');
                const btnVerificarNotificacoes = document.getElementById('btn-verificar-notificacoes');

                if (btnMarcarTodasLidas) {
                    btnMarcarTodasLidas.addEventListener('click', marcarTodasComoLidas);
                }

                if (btnVerTodas) {
                    btnVerTodas.addEventListener('click', verTodasNotificacoes);
                }

                // Adicionar evento para o novo bot√£o
                if (btnVerificarNotificacoes) {
                    btnVerificarNotificacoes.addEventListener('click', function () {
                        verificarPrazos();
                        verificarAlteracoesEmTempoReal();
                        mostrarToast('Notifica√ß√µes', 'Verifica√ß√£o realizada!', 'info');
                    });
                }
            }

            // Fechar dropdown ao clicar fora
            document.addEventListener('click', (e) => {
                const dropdown = document.getElementById('dropdown-notificacoes');
                const btn = document.getElementById('btn-notificacoes');
                if (dropdown && btn && !dropdown.contains(e.target) && !btn.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });

            console.log('‚úÖ Sistema de notifica√ß√µes inicializado');
        }

        function atualizarBadgeNotificacoes() {
            const naoLidas = notificacoes.filter(n => !n.lida).length;
            const badge = document.getElementById('badge-notificacoes');

            if (badge) {
                badge.textContent = naoLidas;
                badge.style.display = naoLidas > 0 ? 'flex' : 'none';
                console.log(`üîî Badge atualizado: ${naoLidas} n√£o lidas`);
            } else {
                console.error('‚ùå Elemento badge-notificacoes n√£o encontrado!');
            }
        }

        function carregarNotificacoes() {
            const lista = document.getElementById('lista-notificacoes');
            if (!lista) {
                console.error('‚ùå Elemento lista-notificacoes n√£o encontrado!');
                return;
            }

            lista.innerHTML = '';

            // Mostrar apenas as 10 notifica√ß√µes mais recentes
            const notificacoesRecentes = [...notificacoes]
                .sort((a, b) => new Date(b.data) - new Date(a.data))
                .slice(0, 10);

            if (notificacoesRecentes.length === 0) {
                lista.innerHTML = `
            <div style="padding: 40px 20px; text-align: center; color: var(--gray);">
                <i class="fas fa-bell-slash" style="font-size: 40px; margin-bottom: 15px; opacity: 0.5;"></i>
                <p>Nenhuma notifica√ß√£o no momento</p>
            </div>
        `;
                return;
            }

            notificacoesRecentes.forEach(notificacao => {
                const div = document.createElement('div');
                div.className = `notificacao-item ${notificacao.lida ? '' : 'nao-lida'}`;
                div.onclick = () => abrirNotificacao(notificacao);

                let icon = 'fas fa-info-circle';
                let iconColor = 'var(--primary)';
                switch (notificacao.tipo) {
                    case 'alerta': icon = 'fas fa-exclamation-triangle'; iconColor = 'var(--warning)'; break;
                    case 'erro': icon = 'fas fa-times-circle'; iconColor = 'var(--danger)'; break;
                    case 'sucesso': icon = 'fas fa-check-circle'; iconColor = 'var(--success)'; break;
                    case 'pagamento': icon = 'fas fa-credit-card'; break;
                    case 'factura': icon = 'fas fa-file-invoice'; break;
                    case 'prazo': icon = 'fas fa-clock'; break;
                }

                div.innerHTML = `
            <div class="notificacao-icone" style="color: ${iconColor};">
                <i class="${icon}"></i>
            </div>
            <div class="notificacao-conteudo">
                <div class="notificacao-titulo">${notificacao.titulo}</div>
                <div class="notificacao-descricao">${notificacao.mensagem}</div>
                <div class="notificacao-tempo">${formatarTempoRelativo(notificacao.data)}</div>
            </div>
            ${!notificacao.lida ? '<div style="width: 8px; height: 8px; background: var(--primary); border-radius: 50%; margin-left: 10px;"></div>' : ''}
        `;
                lista.appendChild(div);
            });

            console.log(`üìã ${notificacoesRecentes.length} notifica√ß√µes carregadas na lista`);
        }

        function abrirNotificacao(notificacao) {
            console.log('üì± Abrindo notifica√ß√£o:', notificacao.titulo);

            // Marcar como lida
            notificacao.lida = true;

            // Atualizar localStorage
            localStorage.setItem('notificacoes', JSON.stringify(notificacoes));

            // Atualizar UI
            atualizarBadgeNotificacoes();
            carregarNotificacoes();

            // Navegar conforme o tipo da notifica√ß√£o
            switch (notificacao.tipo) {
                case 'factura':
                    alternarPagina('facturas');
                    mostrarToast('Factura', 'Abrindo p√°gina de facturas...', 'info');
                    break;
                case 'pagamento':
                    alternarPagina('gestao-membros');
                    mostrarToast('Pagamento', 'Abrindo controlo de pagamentos...', 'info');
                    break;
                default:
                    mostrarToast(notificacao.titulo, notificacao.mensagem, notificacao.tipo);
            }
        }

        function adicionarNotificacao(titulo, mensagem, tipo = 'info') {
            console.log(`‚ûï Adicionando notifica√ß√£o: ${titulo} (${tipo})`);

            // Verificar se j√° existe notifica√ß√£o similar (para evitar duplicados)
            const notificacaoExistente = notificacoes.find(n =>
                n.titulo === titulo && n.mensagem === mensagem
            );

            if (notificacaoExistente) {
                console.log('‚ö†Ô∏è Notifica√ß√£o similar j√° existe, atualizando...');
                // Atualizar data e marca como n√£o lida
                notificacaoExistente.data = new Date().toISOString();
                notificacaoExistente.lida = false;

                // Atualizar localStorage
                localStorage.setItem('notificacoes', JSON.stringify(notificacoes));

                // Atualizar UI
                atualizarBadgeNotificacoes();
                carregarNotificacoes();
                return;
            }

            const novaNotificacao = {
                id: Date.now(),
                titulo: titulo,
                mensagem: mensagem,
                tipo: tipo,
                data: new Date().toISOString(),
                lida: false
            };

            notificacoes.unshift(novaNotificacao);

            // Manter apenas as √∫ltimas 50 notifica√ß√µes
            if (notificacoes.length > 50) {
                notificacoes = notificacoes.slice(0, 50);
            }

            localStorage.setItem('notificacoes', JSON.stringify(notificacoes));

            atualizarBadgeNotificacoes();
            carregarNotificacoes();
            mostrarToast(titulo, mensagem, tipo);

            console.log(`‚úÖ Notifica√ß√£o adicionada. Total: ${notificacoes.length}`);
        }

        function configurarVerificacaoAutomatica() {
            // Verificar prazos a cada 30 minutos (em vez de 1 hora)
            setInterval(verificarPrazos, 1800000);

            // Verificar altera√ß√µes em tempo real a cada 5 minutos
            setInterval(verificarAlteracoesEmTempoReal, 300000);

            // Verificar imediatamente ao carregar
            setTimeout(() => {
                verificarPrazos();
                verificarAlteracoesEmTempoReal();
            }, 5000);

            console.log('‚è∞ Verifica√ß√£o autom√°tica configurada');
        }

        function verificarPrazos() {
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0); // Zera horas para comparar apenas datas
            let novasNotificacoes = 0;

            console.log('üîç Verificando prazos...');
            console.log('Data de hoje (zerada):', hoje);

            // Verificar facturas pendentes
            facturas.forEach(factura => {
                if (factura.estado === 'pendente' && factura.data) {
                    try {
                        const dataFactura = parsearDataPortugues(factura.data);
                        dataFactura.setHours(0, 0, 0, 0); // Zera horas

                        console.log(`Factura ${factura.numero}:`, {
                            dataOriginal: factura.data,
                            dataConvertida: dataFactura,
                            estado: factura.estado
                        });

                        // Verificar se a data √© v√°lida
                        if (isNaN(dataFactura.getTime())) {
                            console.error(`‚ùå Data inv√°lida na factura ${factura.numero}:`, factura.data);
                            return;
                        }

                        const diferencaDias = Math.ceil((dataFactura - hoje) / (1000 * 60 * 60 * 24));

                        console.log(`Dias para vencimento: ${diferencaDias}`);

                        if (diferencaDias === 3) {
                            adicionarNotificacao(
                                'Factura Pr√≥xima do Vencimento',
                                `A factura ${factura.numero} vence em 3 dias (${formatarData(factura.data)})`,
                                'alerta'
                            );
                            novasNotificacoes++;
                        } else if (diferencaDias === 0) {
                            adicionarNotificacao(
                                'Factura Vence Hoje',
                                `A factura ${factura.numero} vence hoje!`,
                                'erro'
                            );
                            novasNotificacoes++;
                        } else if (diferencaDias < 0) {
                            // J√° venceu
                            adicionarNotificacao(
                                'Factura Vencida',
                                `A factura ${factura.numero} venceu h√° ${Math.abs(diferencaDias)} dias`,
                                'erro'
                            );
                            novasNotificacoes++;
                        }
                    } catch (e) {
                        console.error('Erro ao verificar prazo da factura:', e);
                    }
                }
            });

            // Verificar transa√ß√µes atrasadas (CORRIGIDO)
            transacoes.forEach(transacao => {
                if (transacao.status === 'pendente' && transacao.data) {
                    try {
                        const dataTransacao = parsearDataPortugues(transacao.data);
                        dataTransacao.setHours(0, 0, 0, 0); // Zera horas

                        console.log(`Transa√ß√£o ${transacao.id}:`, {
                            dataOriginal: transacao.data,
                            dataConvertida: dataTransacao,
                            descricao: transacao.descricao
                        });

                        // Verificar se a data √© v√°lida
                        if (isNaN(dataTransacao.getTime())) {
                            console.error(`‚ùå Data inv√°lida na transa√ß√£o ${transacao.id}:`, transacao.data);
                            return;
                        }

                        // CORRE√á√ÉO: Garantir que calculamos dias POSITIVOS (dias passados)
                        const diferencaDias = Math.max(0, Math.ceil((hoje - dataTransacao) / (1000 * 60 * 60 * 24)));

                        console.log(`Dias pendente: ${diferencaDias}`);

                        if (diferencaDias > 0) {
                            if (diferencaDias > 30) {
                                adicionarNotificacao(
                                    'Transa√ß√£o Atrasada',
                                    `A transa√ß√£o "${transacao.descricao}" est√° pendente h√° ${diferencaDias} dias`,
                                    'erro'
                                );
                            } else if (diferencaDias > 7) {
                                adicionarNotificacao(
                                    'Transa√ß√£o Pendente (1 semana+)',
                                    `A transa√ß√£o "${transacao.descricao}" est√° pendente h√° ${diferencaDias} dias`,
                                    'alerta'
                                );
                            } else {
                                adicionarNotificacao(
                                    'Transa√ß√£o Pendente',
                                    `A transa√ß√£o "${transacao.descricao}" est√° pendente h√° ${diferencaDias} dias`,
                                    'info'
                                );
                            }
                            novasNotificacoes++;
                        }
                    } catch (e) {
                        console.error('Erro ao verificar prazo da transa√ß√£o:', e);
                    }
                }
            });

            if (novasNotificacoes > 0) {
                console.log(`üîî ${novasNotificacoes} novas notifica√ß√µes de prazo`);
            } else {
                console.log('‚úÖ Nenhum prazo pr√≥ximo encontrado');
            }
        }

        function verificarAlteracoesEmTempoReal() {
            console.log('üîç Verificando altera√ß√µes para notifica√ß√µes...');

            // Verificar facturas recentemente criadas/modificadas
            facturas.forEach(factura => {
                const agora = new Date();
                const dataFactura = new Date(factura.data);
                const diferencaHoras = Math.abs(agora - dataFactura) / 36e5; // horas

                // Se a factura foi criada/modificada nas √∫ltimas 2 horas
                if (diferencaHoras < 2) {
                    if (factura.estado === 'pendente' && !factura.notificado) {
                        adicionarNotificacao(
                            'Nova Factura Pendente',
                            `Factura ${factura.numero} para ${factura.cliente} est√° pendente`,
                            'alerta'
                        );
                        factura.notificado = true; // Marcar como notificado
                    }
                }
            });

            // Verificar transa√ß√µes recentes
            transacoes.forEach(transacao => {
                const agora = new Date();
                const dataTransacao = new Date(transacao.data);
                const diferencaHoras = Math.abs(agora - dataTransacao) / 36e5;

                if (diferencaHoras < 2 && !transacao.notificado) {
                    if (transacao.status === 'pendente') {
                        adicionarNotificacao(
                            'Nova Transa√ß√£o Pendente',
                            `Transa√ß√£o "${transacao.descricao}" de ${formatarValor(transacao.valor)}`,
                            'info'
                        );
                        transacao.notificado = true;
                    }
                }
            });
        }

        function verificarFormatosData() {
            console.log('üìÖ VERIFICA√á√ÉO DE FORMATOS DE DATA:');

            console.log('\n=== FACTURAS ===');
            facturas.forEach((f, i) => {
                const data = new Date(f.data);
                console.log(`${i + 1}. ${f.numero}: "${f.data}" ‚Üí`, {
                    dataOriginal: f.data,
                    dataConvertida: data,
                    isValid: !isNaN(data.getTime()),
                    ano: data.getFullYear(),
                    mes: data.getMonth() + 1,
                    dia: data.getDate()
                });
            });

            console.log('\n=== TRANSA√á√ïES ===');
            transacoes.forEach((t, i) => {
                const data = new Date(t.data);
                console.log(`${i + 1}. ${t.descricao}: "${t.data}" ‚Üí`, {
                    dataOriginal: t.data,
                    dataConvertida: data,
                    isValid: !isNaN(data.getTime()),
                    ano: data.getFullYear(),
                    mes: data.getMonth() + 1,
                    dia: data.getDate()
                });
            });
        }

        function toggleDropdownNotificacoes() {
            const dropdown = document.getElementById('dropdown-notificacoes');
            if (dropdown) {
                if (dropdown.style.display === 'block') {
                    dropdown.style.display = 'none';
                    console.log('üì™ Dropdown de notifica√ß√µes fechado');
                } else {
                    dropdown.style.display = 'block';
                    console.log('üì¨ Dropdown de notifica√ß√µes aberto');
                }
            }
        }

        function marcarTodasComoLidas() {
            console.log('üìå Marcando todas as notifica√ß√µes como lidas');

            notificacoes.forEach(n => n.lida = true);
            localStorage.setItem('notificacoes', JSON.stringify(notificacoes));

            atualizarBadgeNotificacoes();
            carregarNotificacoes();

            mostrarToast('Notifica√ß√µes', 'Todas as notifica√ß√µes foram marcadas como lidas', 'sucesso');
        }

        function verTodasNotificacoes(e) {
            e.preventDefault();
            mostrarToast('Informa√ß√£o', 'Funcionalidade em desenvolvimento', 'info');
        }

        function mostrarToast(titulo, mensagem, tipo = 'info') {
            const container = document.querySelector('.toast-container') || criarToastContainer();
            const toast = document.createElement('div');
            toast.className = `toast ${tipo}`;

            let icon = 'fas fa-info-circle';
            switch (tipo) {
                case 'sucesso': icon = 'fas fa-check-circle'; break;
                case 'erro': icon = 'fas fa-times-circle'; break;
                case 'alerta': icon = 'fas fa-exclamation-triangle'; break;
            }

            toast.innerHTML = `
                <div class="toast-icone">
                    <i class="${icon}"></i>
                </div>
                <div class="toast-conteudo">
                    <div class="toast-titulo">${titulo}</div>
                    <div class="toast-mensagem">${mensagem}</div>
                </div>
                <button class="toast-fechar" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;

            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        function criarToastContainer() {
            const container = document.createElement('div');
            container.className = 'toast-container';
            document.body.appendChild(container);
            return container;
        }

                        
             
        // ===== FUN√á√ïES DA API =====
        async function fazerRequisicao(acao, dados = {}) {
            try {
                const params = new URLSearchParams({ action: acao, ...dados });
                const resposta = await fetch(`${GAS_URL}?${params}`);
                return await resposta.json();
            } catch (error) {
                console.error(`Erro na requisi√ß√£o ${acao}:`, error);
                return { success: false, message: 'Erro de conex√£o com o servidor' };
            }
        }

        async function fazerRequisicaoPOST(acao, dados = {}) {
            try {
                const formData = new URLSearchParams();
                formData.append('action', acao);
                Object.keys(dados).forEach(key => {
                    if (dados[key] !== null && dados[key] !== undefined) {
                        formData.append(key, dados[key]);
                    }
                });

                const resposta = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData
                });

                return await resposta.json();
            } catch (error) {
                console.error(`Erro na requisi√ß√£o POST ${acao}:`, error);
                return { success: false, message: 'Erro de conex√£o com o servidor' };
            }
        }

        // ===== FUN√á√ÉO PARA ATUALIZAR STATUS DO MEMBRO NA PLANILHA =====
        async function atualizarStatusMembroAPI(numeroMembro, status) {
            try {
                const resultado = await fazerRequisicaoPOST('updateMemberStatus', {
                    numeroMembro: numeroMembro,
                    status: status
                });

                return resultado;
            } catch (error) {
                console.error('Erro ao atualizar status do membro:', error);
                return { success: false, message: 'Erro de conex√£o com o servidor' };
            }
        }

        // ===== FUN√á√ïES DE UI =====
        function mostrarLoading(mensagem = 'Carregando...') {
            let loading = document.getElementById('loading-overlay');
            if (!loading) {
                loading = document.createElement('div');
                loading.id = 'loading-overlay';
                loading.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 9999;
                `;

                const loadingContent = document.createElement('div');
                loadingContent.style.cssText = `
                    background: white;
                    padding: 30px;
                    border-radius: 10px;
                    text-align: center;
                    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                `;

                const spinner = document.createElement('div');
                spinner.innerHTML = '<i class="fas fa-spinner fa-spin fa-3x" style="color: var(--primary);"></i>';

                const text = document.createElement('div');
                text.style.marginTop = '15px';
                text.style.fontWeight = '600';
                text.style.color = 'var(--primary)';
                text.id = 'loading-text';
                text.textContent = mensagem;

                loadingContent.appendChild(spinner);
                loadingContent.appendChild(text);
                loading.appendChild(loadingContent);
                document.body.appendChild(loading);
            } else {
                document.getElementById('loading-text').textContent = mensagem;
                loading.style.display = 'flex';
            }
        }

        function esconderLoading() {
            const loading = document.getElementById('loading-overlay');
            if (loading) loading.style.display = 'none';
        }

        function mostrarSucesso(mensagem) {
            mostrarToast('Sucesso', mensagem, 'sucesso');
        }

        function mostrarErro(mensagem) {
            mostrarToast('Erro', mensagem, 'erro');
        }

        function mostrarInfo(mensagem) {
            mostrarToast('Informa√ß√£o', mensagem, 'info');
        }

        // ===== FUN√á√ÉO PARA ALTERNAR ENTRE P√ÅGINAS =====
        async function alternarPagina(pagina) {
            console.log('üîÑ Alternando para p√°gina:', pagina);

            const secoes = [
                'resumo-financeiro-content',
                'transacoes-content',
                'facturas-content',
                'gestao-membros-content',
                'relatorios-financeiros-content',
                'or√ßamento-content',
                'configuracoes-content'
            ];

            secoes.forEach(secao => {
                const elemento = document.getElementById(secao);
                if (elemento) {
                    elemento.style.display = 'none';
                }
            });

            document.querySelectorAll('.sidebar-menu a').forEach(item => {
                item.classList.remove('active');
            });

            switch (pagina) {
                case 'resumo-financeiro':
                    document.getElementById('resumo-financeiro-content').style.display = 'block';
                    document.querySelector('[data-page="resumo-financeiro"]').classList.add('active');
                    await carregarDadosDashboard();
                    break;

                case 'transacoes':
                    document.getElementById('transacoes-content').style.display = 'block';
                    document.querySelector('[data-page="transacoes"]').classList.add('active');
                    if (!dadosCarregados.transacoes) {
                        await carregarTransacoes();
                    } else {
                        carregarTabelaTransacoes();
                    }
                    break;

                case 'facturas':
                    document.getElementById('facturas-content').style.display = 'block';
                    document.querySelector('[data-page="facturas"]').classList.add('active');
                    if (!dadosCarregados.facturas) {
                        await carregarFacturas();
                    } else {
                        carregarTabelaFacturas();
                    }
                    break;

                case 'gestao-membros':
                    document.getElementById('gestao-membros-content').style.display = 'block';
                    document.querySelector('[data-page="gestao-membros"]').classList.add('active');
                    inicializarPaginaGestaoMembros();
                    break;

                case 'relatorios-financeiros':
                    document.getElementById('relatorios-financeiros-content').style.display = 'block';
                    document.querySelector('[data-page="relatorios-financeiros"]').classList.add('active');
                    if (!dadosCarregados.relatorios) {
                        await carregarRelatorios();
                    } else {
                        carregarTabelaRelatorios();
                        atualizarCardsRelatorios();
                    }
                    break;

                case 'or√ßamento':
                    document.getElementById('or√ßamento-content').style.display = 'block';
                    document.querySelector('[data-page="or√ßamento"]').classList.add('active');
                    if (!dadosCarregados.orcamento) {
                        await carregarOrcamentos();
                    } else {
                        carregarTabelaOrcamento();
                        atualizarCardsOrcamento();
                        atualizarGraficosOrcamentoComDadosReais();
                    }
                    break;

                case 'configuracoes':
                    document.getElementById('configuracoes-content').style.display = 'block';
                    document.querySelector('[data-page="configuracoes"]').classList.add('active');
                    break;
            }
        }

        async function salvarTransacaoAPI(transacao) {
            try {
                mostrarLoading('Salvando transa√ß√£o...');

                let resultado;
                if (transacao.id && transacao.id > 0) {
                    resultado = await fazerRequisicaoPOST('updateTransaction', {
                        id: transacao.id,
                        data: transacao.data,
                        descricao: transacao.descricao,
                        natureza: transacao.natureza,
                        tipo: transacao.tipo,
                        valor: transacao.valor,
                        status: transacao.status,
                        observacoes: transacao.observacoes || ''
                    });
                } else {
                    resultado = await fazerRequisicaoPOST('addTransaction', {
                        data: transacao.data,
                        descricao: transacao.descricao,
                        natureza: transacao.natureza,
                        tipo: transacao.tipo,
                        valor: transacao.valor,
                        status: transacao.status,
                        observacoes: transacao.observacoes || ''
                    });

                    if (resultado.success) {
                        transacao.id = resultado.id;
                    }
                }

                if (resultado.success) {
                    mostrarSucesso('Transa√ß√£o salva com sucesso!');

                    // Recarregar transa√ß√µes e atualizar dashboard
                    await carregarTransacoes(true);

                    // Se estiver no dashboard, atualizar tamb√©m
                    if (document.getElementById('resumo-financeiro-content').style.display !== 'none') {
                        await carregarDadosDashboard(true);
                    }

                    return true;
                } else {
                    mostrarErro('Erro ao salvar transa√ß√£o: ' + resultado.message);
                    return false;
                }
            } catch (error) {
                console.error('Erro ao salvar transa√ß√£o:', error);
                mostrarErro('Erro ao salvar transa√ß√£o');
                return false;
            } finally {
                esconderLoading();
            }
        }

        async function eliminarTransacaoAPI(id) {
            if (!confirm('Tem certeza que deseja eliminar esta transa√ß√£o?')) {
                return false;
            }

            try {
                mostrarLoading('Eliminando transa√ß√£o...');
                const resultado = await fazerRequisicaoPOST('deleteTransaction', { id });

                if (resultado.success) {
                    mostrarSucesso('Transa√ß√£o eliminada com sucesso!');
                    await carregarTransacoes();
                    return true;
                } else {
                    mostrarErro('Erro ao eliminar transa√ß√£o: ' + resultado.message);
                    return false;
                }
            } catch (error) {
                console.error('Erro ao eliminar transa√ß√£o:', error);
                mostrarErro('Erro ao eliminar transa√ß√£o');
                return false;
            } finally {
                esconderLoading();
            }
        }

        // ===== FUN√á√ïES PARA FACTURAS =====
        async function carregarFacturas() {
            if (carregandoDados) return;
            carregandoDados = true;

            try {
                mostrarLoading('Carregando facturas...');
                const resultado = await fazerRequisicao('getInvoices');

                if (resultado.success) {
                    facturas = resultado.data;
                    console.log(`‚úÖ ${facturas.length} facturas carregadas`);

                    if (document.getElementById('facturas-content').style.display !== 'none') {
                        carregarTabelaFacturas();
                    }
                } else {
                    mostrarErro('Erro ao carregar facturas: ' + resultado.message);
                }
            } catch (error) {
                console.error('Erro ao carregar facturas:', error);
                mostrarErro('Erro ao carregar facturas');
            } finally {
                carregandoDados = false;
                esconderLoading();
            }
        }

        async function salvarFacturaAPI(factura) {
            try {
                mostrarLoading('Salvando factura...');

                let resultado;
                if (factura.id && factura.id > 0) {
                    resultado = await fazerRequisicaoPOST('updateInvoice', {
                        id: factura.id,
                        numero: factura.numero,
                        data: factura.data,
                        cliente: factura.cliente,
                        natureza: factura.natureza || 'quotas',
                        funcao: factura.funcao || '',
                        numeroMembro: factura.numeroMembro || '',
                        periodo: factura.periodo || '',
                        quota: factura.quota || factura.valor,
                        multa: factura.multa || 0,
                        joia: factura.joia || 0,
                        estado: factura.estado
                    });
                } else {
                    resultado = await fazerRequisicaoPOST('addInvoice', {
                        numero: factura.numero,
                        data: factura.data,
                        cliente: factura.cliente,
                        natureza: factura.natureza || 'quotas',
                        funcao: factura.funcao || '',
                        numeroMembro: factura.numeroMembro || '',
                        periodo: factura.periodo || '',
                        quota: factura.quota || factura.valor,
                        multa: factura.multa || 0,
                        joia: factura.joia || 0,
                        estado: factura.estado
                    });

                    if (resultado.success) {
                        factura.id = resultado.id;
                    }
                }

                if (resultado.success) {
                    mostrarSucesso('Factura salva com sucesso!');
                    await carregarFacturas();
                    return true;
                } else {
                    mostrarErro('Erro ao salvar factura: ' + resultado.message);
                    return false;
                }
            } catch (error) {
                console.error('Erro ao salvar factura:', error);
                mostrarErro('Erro ao salvar factura');
                return false;
            } finally {
                esconderLoading();
            }
        }

        async function eliminarFacturaAPI(id) {
            if (!confirm('Tem certeza que deseja eliminar esta factura?')) {
                return false;
            }

            try {
                mostrarLoading('Eliminando factura...');
                const resultado = await fazerRequisicaoPOST('deleteInvoice', { id });

                if (resultado.success) {
                    mostrarSucesso('Factura eliminada com sucesso!');
                    await carregarFacturas();
                    return true;
                } else {
                    mostrarErro('Erro ao eliminar factura: ' + resultado.message);
                    return false;
                }
            } catch (error) {
                console.error('Erro ao eliminar factura:', error);
                mostrarErro('Erro ao eliminar factura');
                return false;
            } finally {
                esconderLoading();
            }
        }

        // ===== FUN√á√ïES PARA RELAT√ìRIOS =====
        async function carregarRelatorios() {
            if (carregandoDados) return;
            carregandoDados = true;

            try {
                mostrarLoading('Carregando relat√≥rios...');
                const resultado = await fazerRequisicao('getReports');

                if (resultado.success) {
                    relatorios = resultado.data;
                    console.log(`‚úÖ ${relatorios.length} relat√≥rios carregados`);

                    if (document.getElementById('relatorios-financeiros-content').style.display !== 'none') {
                        carregarTabelaRelatorios();
                        atualizarCardsRelatorios();
                    }
                } else {
                    mostrarErro('Erro ao carregar relat√≥rios: ' + resultado.message);
                }
            } catch (error) {
                console.error('Erro ao carregar relat√≥rios:', error);
                mostrarErro('Erro ao carregar relat√≥rios');
            } finally {
                carregandoDados = false;
                esconderLoading();
            }
        }

        function atualizarCardsRelatorios() {
            const contadores = { mensal: 0, trimestral: 0, anual: 0, balanco: 0 };
            relatorios.forEach(relatorio => {
                if (contadores.hasOwnProperty(relatorio.tipo)) {
                    contadores[relatorio.tipo]++;
                }
            });

            const cardMensal = document.querySelector('.card:nth-child(1) .value');
            const cardTrimestral = document.querySelector('.card:nth-child(2) .value');
            const cardAnual = document.querySelector('.card:nth-child(3) .value');
            const cardBalanco = document.querySelector('.card:nth-child(4) .value');

            if (cardMensal) cardMensal.textContent = contadores.mensal;
            if (cardTrimestral) cardTrimestral.textContent = contadores.trimestral;
            if (cardAnual) cardAnual.textContent = contadores.anual;
            if (cardBalanco) cardBalanco.textContent = contadores.balanco;
        }

        async function salvarRelatorioAPI(relatorio) {
            try {
                mostrarLoading('Salvando relat√≥rio...');

                let resultado;
                if (relatorio.id && relatorio.id > 0) {
                    resultado = await fazerRequisicaoPOST('updateReport', {
                        id: relatorio.id,
                        nome: relatorio.nome,
                        tipo: relatorio.tipo,
                        periodo: relatorio.periodo,
                        data: relatorio.data,
                        autor: relatorio.autor,
                        descricao: relatorio.descricao || ''
                    });
                } else {
                    resultado = await fazerRequisicaoPOST('addReport', {
                        nome: relatorio.nome,
                        tipo: relatorio.tipo,
                        periodo: relatorio.periodo,
                        data: relatorio.data,
                        autor: relatorio.autor,
                        descricao: relatorio.descricao || ''
                    });

                    if (resultado.success) {
                        relatorio.id = resultado.id;
                    }
                }

                if (resultado.success) {
                    mostrarSucesso('Relat√≥rio salvo com sucesso!');
                    await carregarRelatorios();
                    return true;
                } else {
                    mostrarErro('Erro ao salvar relat√≥rio: ' + resultado.message);
                    return false;
                }
            } catch (error) {
                console.error('Erro ao salvar relat√≥rio:', error);
                mostrarErro('Erro ao salvar relat√≥rio');
                return false;
            } finally {
                esconderLoading();
            }
        }

        // ===== FUN√á√ïES PARA OR√áAMENTO =====
        async function carregarOrcamentos() {
            if (carregandoDados) return;
            carregandoDados = true;

            try {
                mostrarLoading('Carregando or√ßamentos...');
                const resultado = await fazerRequisicao('getBudgets');

                if (resultado.success) {
                    orcamento = resultado.data;
                    console.log(`‚úÖ ${orcamento.length} or√ßamentos carregados`);

                    await calcularOrcamentosRealizados();

                    if (document.getElementById('or√ßamento-content').style.display !== 'none') {
                        carregarTabelaOrcamento();
                        atualizarCardsOrcamento();
                    }
                } else {
                    mostrarErro('Erro ao carregar or√ßamentos: ' + resultado.message);
                }
            } catch (error) {
                console.error('Erro ao carregar or√ßamentos:', error);
                mostrarErro('Erro ao carregar or√ßamentos');
            } finally {
                carregandoDados = false;
                esconderLoading();
            }
        }

        async function calcularOrcamentosRealizados() {
            orcamento.forEach(item => {
                const transacoesNatureza = transacoes.filter(t =>
                    t.natureza === item.natureza && t.status === 'pago'
                );

                const realizado = transacoesNatureza.reduce((total, t) =>
                    total + parseFloat(t.valor || 0), 0
                );

                item.realizado = realizado;
                item.diferenca = parseFloat(item.orcamentado) - realizado;
                item.percentual = parseFloat(item.orcamentado) > 0 ?
                    (realizado / parseFloat(item.orcamentado)) * 100 : 0;

                if (item.percentual >= 90) item.status = 'Alerta';
                else if (item.percentual >= 70) item.status = 'Aten√ß√£o';
                else if (item.percentual >= 0) item.status = 'Normal';
                else item.status = 'Normal';
            });
        }

        function atualizarCardsOrcamento() {
            if (orcamento.length === 0) {
                console.log('‚ö†Ô∏è Nenhum or√ßamento carregado');
                return;
            }

            // Usar valores DIRETAMENTE do array orcamento (que vem do GAS)
            const orcamentoTotal = orcamento.reduce((total, item) =>
                total + parseFloat(item.orcamentado || 0), 0
            );

            const realizadoTotal = orcamento.reduce((total, item) =>
                total + parseFloat(item.realizado || 0), 0
            );

            const restanteTotal = orcamentoTotal - realizadoTotal;
            const percentualTotal = orcamentoTotal > 0 ? (realizadoTotal / orcamentoTotal) * 100 : 0;

            // Previs√£o de saldo (saldo atual + or√ßamento restante)
            const saldoAtualElement = document.getElementById('saldo-atual');
            let saldoPrevisto = orcamentoTotal; // Padr√£o: or√ßamento total

            if (saldoAtualElement) {
                const saldoAtualTexto = saldoAtualElement.textContent.replace(' Kz', '').replace(/\./g, '').replace(',', '.');
                const saldoAtual = parseFloat(saldoAtualTexto);
                if (!isNaN(saldoAtual)) {
                    saldoPrevisto = saldoAtual + restanteTotal;
                }
            }

            const cards = document.querySelectorAll('#or√ßamento-content .card .value');
            if (cards.length >= 4) {
                cards[0].textContent = formatarValor(orcamentoTotal);
                cards[1].textContent = formatarValor(realizadoTotal);
                cards[2].textContent = formatarValor(restanteTotal);
                cards[3].textContent = formatarValor(saldoPrevisto);

                const trends = document.querySelectorAll('#or√ßamento-content .card .trend');
                if (trends.length >= 4) {
                    trends[0].textContent = `Para ${new Date().getFullYear()}`;
                    trends[1].textContent = `${percentualTotal.toFixed(1)}% do or√ßamento anual`;
                    trends[2].textContent = `${(100 - percentualTotal).toFixed(1)}% do or√ßamento anual`;
                    trends[3].textContent = `Proje√ß√£o at√© final do ano`;
                }
            }

            console.log('üìä Cards de or√ßamento atualizados com dados do GAS');
        }

        async function salvarOrcamentoAPI(orcamentoItem) {
            try {
                mostrarLoading('Salvando or√ßamento...');

                let resultado;
                if (orcamentoItem.id && orcamentoItem.id > 0) {
                    resultado = await fazerRequisicaoPOST('updateBudget', {
                        id: orcamentoItem.id,
                        nome: orcamentoItem.nome,
                        natureza: orcamentoItem.natureza,
                        orcamentado: orcamentoItem.orcamentado,
                        dataAprovacao: orcamentoItem.dataAprovacao,
                        dataInicio: orcamentoItem.dataInicio,
                        dataFim: orcamentoItem.dataFim,
                        descricao: orcamentoItem.descricao || ''
                    });
                } else {
                    resultado = await fazerRequisicaoPOST('addBudget', {
                        nome: orcamentoItem.nome,
                        natureza: orcamentoItem.natureza,
                        orcamentado: orcamentoItem.orcamentado,
                        dataAprovacao: orcamentoItem.dataAprovacao,
                        dataInicio: orcamentoItem.dataInicio,
                        dataFim: orcamentoItem.dataFim,
                        descricao: orcamentoItem.descricao || ''
                    });

                    if (resultado.success) {
                        orcamentoItem.id = resultado.id;
                    }
                }

                if (resultado.success) {
                    mostrarSucesso('Or√ßamento salvo com sucesso!');
                    await carregarOrcamentos();
                    return true;
                } else {
                    mostrarErro('Erro ao salvar or√ßamento: ' + resultado.message);
                    return false;
                }
            } catch (error) {
                console.error('Erro ao salvar or√ßamento:', error);
                mostrarErro('Erro ao salvar or√ßamento');
                return false;
            } finally {
                esconderLoading();
            }
        }

        // ===== FUN√á√ïES DE RESUMO FINANCEIRO =====
        function atualizarResumoFinanceiro() {
            const receitasMes = transacoes
                .filter(t => t.tipo === 'receita' && t.status === 'pago')
                .reduce((total, t) => total + parseFloat(t.valor || 0), 0);

            const despesasMes = transacoes
                .filter(t => t.tipo === 'despesa' && t.status === 'pago')
                .reduce((total, t) => total + parseFloat(t.valor || 0), 0);

            const saldoAtual = receitasMes - despesasMes;
            const saldoPrevisto = saldoAtual + 0;

            document.getElementById('saldo-atual').textContent = formatarValor(saldoAtual);
            document.getElementById('receitas-mes').textContent = formatarValor(receitasMes);
            document.getElementById('despesas-mes').textContent = formatarValor(despesasMes);
            document.getElementById('saldo-previsto').textContent = formatarValor(saldoPrevisto);

            atualizarTransacoesRecentes();
            atualizarBarrasProgresso(saldoAtual, receitasMes, despesasMes, saldoPrevisto);
        }

        function atualizarTransacoesRecentes() {
            const tbody = document.getElementById('corpo-tabela-transacoes-recentes');
            if (!tbody) return;

            tbody.innerHTML = '';

            const recentes = [...transacoes]
                .sort((a, b) => new Date(b.data) - new Date(a.data))
                .slice(0, 5);

            if (recentes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Nenhuma transa√ß√£o recente</td></tr>';
                return;
            }

            recentes.forEach(transacao => {
                const tr = document.createElement('tr');
                const tipoClass = transacao.tipo === 'receita' ? 'tipo-receita' : 'tipo-despesa';
                const tipoTexto = transacao.tipo === 'receita' ? 'Receita' : 'Despesa';

                tr.innerHTML = `
                    <td>${formatarData(transacao.data)}</td>
                    <td>${transacao.descricao}</td>
                    <td>${transacao.categoria || transacao.natureza}</td>
                    <td><span class="status ${tipoClass}">${tipoTexto}</span></td>
                    <td>${formatarValor(transacao.valor)}</td>
                    <td><span class="status ${transacao.status}">${transacao.status.charAt(0).toUpperCase() + transacao.status.slice(1)}</span></td>
                    <td class="action-buttons">
                        <button class="action-btn view" onclick="verTransacao(${transacao.id})"><i class="fas fa-eye"></i></button>
                        <button class="action-btn edit" onclick="editarTransacao(${transacao.id})"><i class="fas fa-edit"></i></button>
                        <button class="action-btn delete" onclick="eliminarTransacao(${transacao.id})"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function atualizarBarrasProgresso(saldoAtual, receitasMes, despesasMes, saldoPrevisto) {
            // Encontrar valores m√°ximos realistas baseados nos dados
            const valores = [Math.abs(saldoAtual), receitasMes, despesasMes, Math.abs(saldoPrevisto)];
            const maxValor = Math.max(...valores, 1000); // M√≠nimo 1000 para evitar divis√£o por zero

            // Calcular percentagens (limitadas a 100%)
            const percentSaldo = Math.min((Math.abs(saldoAtual) / maxValor) * 100, 100);
            const percentReceitas = Math.min((receitasMes / maxValor) * 100, 100);
            const percentDespesas = Math.min((despesasMes / maxValor) * 100, 100);
            const percentPrevisto = Math.min((Math.abs(saldoPrevisto) / maxValor) * 100, 100);

            // Atualizar barras de progresso
            const progressFills = document.querySelectorAll('#resumo-financeiro-content .progress-fill');
            if (progressFills.length >= 4) {
                progressFills[0].style.width = percentSaldo + '%';
                progressFills[1].style.width = percentReceitas + '%';
                progressFills[2].style.width = percentDespesas + '%';
                progressFills[3].style.width = percentPrevisto + '%';
            }

            // Calcular varia√ß√µes simples (pode ser aprimorado com dados hist√≥ricos)
            const hoje = new Date();
            const mesPassado = new Date(hoje.getFullYear(), hoje.getMonth() - 1, hoje.getDate());

            // Valores base para compara√ß√£o (pode ser aprimorado)
            const baseReceitas = 400000; // Valor base de refer√™ncia
            const baseDespesas = 250000; // Valor base de refer√™ncia
            const baseSaldo = 1000000; // Valor base de refer√™ncia

            // Calcular varia√ß√µes percentuais em rela√ß√£o aos valores base
            const variacaoSaldo = baseSaldo > 0 ? ((saldoAtual - baseSaldo) / baseSaldo) * 100 : 0;
            const variacaoReceitas = baseReceitas > 0 ? ((receitasMes - baseReceitas) / baseReceitas) * 100 : 0;
            const variacaoDespesas = baseDespesas > 0 ? ((despesasMes - baseDespesas) / baseDespesas) * 100 : 0;
            const variacaoPrevisto = saldoAtual !== 0 ? ((saldoPrevisto - saldoAtual) / Math.abs(saldoAtual)) * 100 : 0;

            // Atualizar percentuais nos cards
            const atualizarPercentual = (elementId, valor, positivo) => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = (valor >= 0 ? '+' : '') + valor.toFixed(1) + '%';
                    element.className = `card-percent ${positivo ? (valor >= 0 ? 'up' : 'down') : (valor <= 0 ? 'up' : 'down')}`;
                }
            };

            atualizarPercentual('percent-saldo', variacaoSaldo, true);
            atualizarPercentual('percent-receitas', variacaoReceitas, true);
            atualizarPercentual('percent-despesas', variacaoDespesas, false); // Para despesas, negativo √© bom
            atualizarPercentual('percent-previsto', variacaoPrevisto, true);

            // Atualizar textos de tend√™ncia
            const atualizarTrend = (selectorIndex, valor, textoPositivo, textoNegativo) => {
                const trends = document.querySelectorAll('#resumo-financeiro-content .trend');
                if (trends.length > selectorIndex) {
                    const icon = valor >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
                    const className = valor >= 0 ? 'up' : 'down';
                    const texto = valor >= 0 ? textoPositivo : textoNegativo;

                    trends[selectorIndex].innerHTML = `<i class="fas ${icon}"></i> ${Math.abs(valor).toFixed(1)}% ${texto}`;
                    trends[selectorIndex].className = `trend ${className}`;
                }
            };

            atualizarTrend(0, variacaoSaldo, 'desde o √∫ltimo m√™s', 'desde o √∫ltimo m√™s');
            atualizarTrend(1, variacaoReceitas, 'desde o √∫ltimo m√™s', 'desde o √∫ltimo m√™s');
            atualizarTrend(2, variacaoDespesas, 'desde o √∫ltimo m√™s', 'desde o √∫ltimo m√™s');
            atualizarTrend(3, variacaoPrevisto, 'at√© final do m√™s', 'at√© final do m√™s');
        }

        function atualizarTransacoesRecentesDashboard(transacoesRecentes) {
            const tbody = document.getElementById('corpo-tabela-transacoes-recentes');
            if (!tbody) return;

            tbody.innerHTML = '';

            if (transacoesRecentes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Nenhuma transa√ß√£o recente</td></tr>';
                return;
            }

            transacoesRecentes.forEach(transacao => {
                const tr = document.createElement('tr');
                const tipoClass = transacao.tipo === 'receita' ? 'tipo-receita' : 'tipo-despesa';
                const tipoTexto = transacao.tipo === 'receita' ? 'Receita' : 'Despesa';

                tr.innerHTML = `
            <td>${formatarData(transacao.data)}</td>
            <td>${transacao.descricao}</td>
            <td>${transacao.natureza}</td>
            <td><span class="status ${tipoClass}">${tipoTexto}</span></td>
            <td>${formatarValor(transacao.valor)}</td>
            <td><span class="status ${transacao.status}">${transacao.status.charAt(0).toUpperCase() + transacao.status.slice(1)}</span></td>
            <td class="action-buttons">
                <button class="action-btn view" onclick="verTransacao(${transacao.id})"><i class="fas fa-eye"></i></button>
                <button class="action-btn edit" onclick="editarTransacao(${transacao.id})"><i class="fas fa-edit"></i></button>
                <button class="action-btn delete" onclick="eliminarTransacao(${transacao.id})"><i class="fas fa-trash"></i></button>
            </td>
        `;
                tbody.appendChild(tr);
            });
        }

        // ===== FUN√á√ïES DE TABELAS =====
        function carregarTabelaTransacoes(dadosFiltrados = null) {
            const tbody = document.getElementById('corpo-tabela-transacoes');
            if (!tbody) return;

            tbody.innerHTML = '';

            const transacoesParaExibir = dadosFiltrados || transacoes;

            if (transacoesParaExibir.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Nenhuma transa√ß√£o encontrada</td></tr>';
            } else {
                transacoesParaExibir.forEach(transacao => {
                    const tr = document.createElement('tr');
                    const tipoClass = transacao.tipo === 'receita' ? 'tipo-receita' : 'tipo-despesa';
                    const tipoTexto = transacao.tipo === 'receita' ? 'Receita' : 'Despesa';

                    tr.innerHTML = `
                    <td>${formatarData(transacao.data)}</td>
                    <td>${transacao.descricao}</td>
                    <td>${transacao.categoria || transacao.natureza}</td>
                    <td><span class="status ${tipoClass}">${tipoTexto}</span></td>
                    <td>${formatarValor(transacao.valor)}</td>
                    <td><span class="status ${transacao.status}">${transacao.status.charAt(0).toUpperCase() + transacao.status.slice(1)}</span></td>
                    <td class="action-buttons">
                        <button class="action-btn view" onclick="verTransacao(${transacao.id})"><i class="fas fa-eye"></i></button>
                        <button class="action-btn edit" onclick="editarTransacao(${transacao.id})"><i class="fas fa-edit"></i></button>
                        <button class="action-btn delete" onclick="eliminarTransacao(${transacao.id})"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                    tbody.appendChild(tr);
                });
            }
        }

        function aplicarFiltrosTransacoes() {
            const periodo = document.getElementById('filter-periodo-transacoes').value;
            const tipo = document.getElementById('filter-tipo-transacoes').value;
            const categoria = document.getElementById('filter-categoria-transacoes').value;

            let transacoesFiltradas = [...transacoes];

            if (periodo && periodo !== 'todos') {
                const hoje = new Date();
                let dataInicio = new Date();

                switch (periodo) {
                    case 'mes': dataInicio.setMonth(hoje.getMonth() - 1); break;
                    case 'trimestre': dataInicio.setMonth(hoje.getMonth() - 3); break;
                    case 'semestre': dataInicio.setMonth(hoje.getMonth() - 6); break;
                    case 'ano': dataInicio.setFullYear(hoje.getFullYear() - 1); break;
                }

                transacoesFiltradas = transacoesFiltradas.filter(t => {
                    const dataTransacao = parsearDataPortugues(t.data);
                    return dataTransacao >= dataInicio;
                });
            }

            if (tipo) {
                transacoesFiltradas = transacoesFiltradas.filter(t => t.tipo === tipo);
            }

            if (categoria) {
                transacoesFiltradas = transacoesFiltradas.filter(t => t.categoria === categoria || t.natureza === categoria);
            }

            carregarTabelaTransacoes(transacoesFiltradas);
        }

        function carregarTabelaFacturas(dadosFiltrados = null) {
            const tbody = document.getElementById('corpo-tabela-facturas');
            if (!tbody) return;

            tbody.innerHTML = '';

            const facturasParaExibir = dadosFiltrados || facturas;

            if (facturasParaExibir.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;">Nenhuma factura encontrada</td></tr>';
                return;
            }

            facturasParaExibir.forEach(factura => {
                const tr = document.createElement('tr');
                let estadoClass = '';
                let estadoTexto = '';

                switch (factura.estado) {
                    case 'pago':
                        estadoClass = 'status pago';
                        estadoTexto = 'Pago';
                        break;
                    case 'pendente':
                        estadoClass = 'status pendente';
                        estadoTexto = 'Pendente';
                        break;
                    case 'cancelado':
                        estadoClass = 'status atrasado';
                        estadoTexto = 'Cancelado';
                        break;
                }

                tr.innerHTML = `
                <td>${factura.numero}</td>
                <td>${formatarData(factura.data)}</td>
                <td>${factura.cliente}</td>
                <td>${formatarValor(factura.total || factura.valor)}</td>
                <td><span class="${estadoClass}">${estadoTexto}</span></td>
                <td class="action-buttons">
                    <button class="action-btn view" onclick="verFactura(${factura.id})"><i class="fas fa-eye"></i></button>
                    <button class="action-btn edit" onclick="editarFactura(${factura.id})"><i class="fas fa-edit"></i></button>
                    <button class="action-btn" onclick="imprimirFactura(${factura.id})"><i class="fas fa-print"></i></button>
                </td>
            `;
                tbody.appendChild(tr);
            });
        }

        function aplicarFiltrosFacturas() {
            const nome = document.getElementById('filter-nome-factura').value.toLowerCase();
            const data = document.getElementById('filter-data-factura').value;

            if (!nome && !data) {
                carregarTabelaFacturas();
                return;
            }

            let facturasFiltradas = [...facturas];

            if (nome) {
                facturasFiltradas = facturasFiltradas.filter(f =>
                    f.cliente.toLowerCase().includes(nome) ||
                    f.numero.toLowerCase().includes(nome)
                );
            }

            if (data) {
                facturasFiltradas = facturasFiltradas.filter(f => f.data === data);
            }

            carregarTabelaFacturas(facturasFiltradas);
        }

        // ===== FUN√á√ÉO ATUALIZADA PARA CARREGAR TABELA DE RELAT√ìRIOS COM FILTROS =====
        function carregarTabelaRelatorios(dadosFiltrados = null) {
            const tbody = document.getElementById('corpo-tabela-relatorios');
            if (!tbody) return;

            tbody.innerHTML = '';

            // Determinar quais relat√≥rios mostrar
            const relatoriosParaExibir = dadosFiltrados || relatorios;

            if (relatoriosParaExibir.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;">Nenhum relat√≥rio encontrado</td></tr>';
            } else {
                relatoriosParaExibir.forEach(relatorio => {
                    const tr = document.createElement('tr');

                    let icon = 'fas fa-file-alt';
                    if (relatorio.tipo === 'mensal') icon = 'fas fa-calendar-week';
                    if (relatorio.tipo === 'trimestral') icon = 'fas fa-calendar-alt';
                    if (relatorio.tipo === 'semestral') icon = 'fas fa-calendar';
                    if (relatorio.tipo === 'anual') icon = 'fas fa-calendar';
                    if (relatorio.tipo === 'balanco') icon = 'fas fa-balance-scale';

                    tr.innerHTML = `
                <td><i class="${icon}" style="margin-right: 8px; color: var(--primary);"></i> ${relatorio.nome}</td>
                <td><span class="status ${relatorio.tipo}">${relatorio.tipo.charAt(0).toUpperCase() + relatorio.tipo.slice(1)}</span></td>
                <td>${relatorio.periodo}</td>
                <td>${formatarData(relatorio.data)}</td>
                <td><strong>${relatorio.autor || 'N/A'}</strong></td>
                <td class="action-buttons">
                    <button class="action-btn view" onclick="verRelatorio(${relatorio.id})" title="Ver detalhes">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="action-btn" onclick="baixarRelatorio(${relatorio.id})" title="Baixar relat√≥rio">
                        <i class="fas fa-download"></i>
                    </button>
                </td>
            `;
                    tbody.appendChild(tr);
                });

                // Atualizar contador de resultados
                const totalRelatorios = document.querySelector('#relatorios-financeiros-content .page-title');
                if (totalRelatorios) {
                    const contadorExistente = document.getElementById('contador-relatorios');
                    if (contadorExistente) {
                        contadorExistente.remove();
                    }

                    const contador = document.createElement('div');
                    contador.id = 'contador-relatorios';
                    contador.style.fontSize = '14px';
                    contador.style.color = 'var(--gray)';
                    contador.style.marginTop = '10px';
                    contador.innerHTML = `<i class="fas fa-filter"></i> Mostrando ${relatoriosParaExibir.length} de ${relatorios.length} relat√≥rios`;

                    // Encontrar onde inserir o contador (ap√≥s o h1)
                    const h1 = totalRelatorios.querySelector('h1');
                    if (h1) {
                        h1.parentNode.insertBefore(contador, h1.nextSibling);
                    }
                }
            }
        }

        // ===== FUN√á√ÉO PARA APLICAR FILTROS NOS RELAT√ìRIOS =====
        function aplicarFiltrosRelatorios() {
            const tipo = document.getElementById('filter-tipo-relatorio').value;
            
            const autor = document.getElementById('filter-autor-relatorio').value.toLowerCase();

            let relatoriosFiltrados = [...relatorios];

            // Filtrar por tipo
            if (tipo) {
                relatoriosFiltrados = relatoriosFiltrados.filter(r => r.tipo === tipo);
            }

            // Filtrar por autor
            if (autor) {
                relatoriosFiltrados = relatoriosFiltrados.filter(r =>
                    (r.autor || '').toLowerCase().includes(autor)
                );
            }

            // Atualizar tabela com filtros aplicados
            carregarTabelaRelatorios(relatoriosFiltrados);

            // Atualizar cards de resumo com filtros aplicados
            atualizarCardsRelatoriosComFiltros(relatoriosFiltrados);
        }

        // ===== FUN√á√ÉO PARA ATUALIZAR CARDS COM FILTROS APLICADOS =====
        function atualizarCardsRelatoriosComFiltros(relatoriosFiltrados) {
            const contadores = { mensal: 0, trimestral: 0, anual: 0, balanco: 0 };

            relatoriosFiltrados.forEach(relatorio => {
                if (contadores.hasOwnProperty(relatorio.tipo)) {
                    contadores[relatorio.tipo]++;
                }
            });

            const cardMensal = document.querySelector('#relatorios-financeiros-content .card:nth-child(1) .value');
            const cardTrimestral = document.querySelector('#relatorios-financeiros-content .card:nth-child(2) .value');
            const cardAnual = document.querySelector('#relatorios-financeiros-content .card:nth-child(3) .value');
            const cardBalanco = document.querySelector('#relatorios-financeiros-content .card:nth-child(4) .value');

            if (cardMensal) cardMensal.textContent = contadores.mensal;
            if (cardTrimestral) cardTrimestral.textContent = contadores.trimestral;
            if (cardAnual) cardAnual.textContent = contadores.anual;
            if (cardBalanco) cardBalanco.textContent = contadores.balanco;
        }

        // ===== FUN√á√ÉO PARA LIMPAR FILTROS =====
        function limparFiltrosRelatorios() {
            document.getElementById('filter-tipo-relatorio').value = '';
            document.getElementById('filter-autor-relatorio').value = '';

            // Recarregar tabela completa
            carregarTabelaRelatorios();

            // Atualizar cards com todos os relat√≥rios
            atualizarCardsRelatoriosComDadosReais();
        }

        function carregarTabelaOrcamento() {
            console.log('üîç Iniciando carregarTabelaOrcamento...');
            console.log('üìä Dados atuais do array orcamento:', orcamento);

            const tbody = document.getElementById('corpo-tabela-orcamento');
            if (!tbody) {
                console.error('‚ùå Tabela n√£o encontrada!');
                return;
            }

            tbody.innerHTML = '';

            orcamento.forEach(item => {
                const tr = document.createElement('tr');
                let statusClass = '';
                let statusText = item.status || 'Normal';

                // Mapear status para classes CSS
                if (statusText === 'Anulado') {
                    statusClass = 'status atrasado';
                } else if (statusText === 'Suspenso') {
                    statusClass = 'status pendente';
                } else if (statusText === 'Alerta') {
                    statusClass = 'status atrasado';
                } else if (statusText === 'Aten√ß√£o') {
                    statusClass = 'status pendente';
                } else {
                    statusClass = 'status pago';
                }

                tr.innerHTML = `
            <td>${item.nome}</td>
            <td>${formatarValor(item.orcamentado)}</td>
            <td>${formatarValor(item.realizado || 0)}</td>
            <td>${formatarValor(item.diferenca || 0)}</td>
            <td>${(item.percentual || 0).toFixed(1)}%</td>
            <td><span class="${statusClass}">${statusText}</span></td>
            <td class="action-buttons">
                <button class="action-btn view" onclick="visualizarOrcamento(${item.id})" title="Visualizar">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="action-btn edit" onclick="editarOrcamento(${item.id})" title="Editar">
                    <i class="fas fa-edit"></i>
                </button>
            </td>
        `;
                tbody.appendChild(tr);
            });
        }

        // ===== FUN√á√ïES MODAIS =====
        function abrirModalTransacao(transacao = null) {
            const titulo = document.getElementById('modal-titulo-transacao');
            const form = document.getElementById('form-transacao');

            if (transacao) {
                titulo.textContent = 'Editar Transa√ß√£o';
                document.getElementById('transacao-id').value = transacao.id;
                document.getElementById('transacao-tipo').value = transacao.tipo;
                document.getElementById('transacao-categoria').value = transacao.categoria || transacao.natureza;
                document.getElementById('transacao-descricao').value = transacao.descricao;
                document.getElementById('transacao-valor').value = transacao.valor;
                document.getElementById('transacao-data').value = transacao.data;
                document.getElementById('transacao-status').value = transacao.status;
                document.getElementById('transacao-observacoes').value = transacao.observacoes;
            } else {
                titulo.textContent = 'Nova Transa√ß√£o';
                form.reset();
                document.getElementById('transacao-id').value = '';
                document.getElementById('transacao-data').value = new Date().toISOString().split('T')[0];
            }

            document.getElementById('modal-transacao').style.display = 'flex';
        }

        function fecharModalTransacao() {
            document.getElementById('modal-transacao').style.display = 'none';
        }

        function cancelarTransacao() {
            fecharModalTransacao();
        }

        async function salvarTransacao() {
            const id = document.getElementById('transacao-id').value;
            const tipo = document.getElementById('transacao-tipo').value;
            const categoria = document.getElementById('transacao-categoria').value;
            const descricao = document.getElementById('transacao-descricao').value;
            const valor = parseFloat(document.getElementById('transacao-valor').value);
            const data = document.getElementById('transacao-data').value;
            const status = document.getElementById('transacao-status').value;
            const observacoes = document.getElementById('transacao-observacoes').value;

            if (!tipo || !categoria || !descricao || !valor || !data || !status) {
                alert('Por favor, preencha todos os campos obrigat√≥rios.');
                return;
            }

            const transacao = {
                id: id ? parseInt(id) : null,
                data: data,
                descricao: descricao,
                natureza: categoria,
                tipo: tipo,
                valor: valor,
                status: status,
                observacoes: observacoes
            };

            const sucesso = await salvarTransacaoAPI(transacao);
            if (sucesso) {
                // Recarregar dados do dashboard
                await carregarDadosDashboard(true);

                // Adicionar notifica√ß√£o espec√≠fica
                const tipoTexto = tipo === 'receita' ? 'Receita' : 'Despesa';
                adicionarNotificacao(
                    `Transa√ß√£o ${tipoTexto} ${transacao.id ? 'Atualizada' : 'Criada'}`,
                    `${descricao} - ${formatarValor(valor)}`,
                    tipo === 'receita' ? 'sucesso' : 'info'
                );

                // Verificar prazos imediatamente
                verificarPrazos();

                fecharModalTransacao();
            }
        }

        async function eliminarTransacao(id) {
            const sucesso = await eliminarTransacaoAPI(id);
            return sucesso;
        }

        function editarTransacao(id) {
            const transacao = transacoes.find(t => t.id === id);
            if (transacao) abrirModalTransacao(transacao);
        }

        function verTransacao(id) {
            const transacao = transacoes.find(t => t.id === id);
            if (transacao) {
                alert(`
                    Descri√ß√£o: ${transacao.descricao}
                    Tipo: ${transacao.tipo === 'receita' ? 'Receita' : 'Despesa'}
                    Categoria: ${transacao.categoria || transacao.natureza}
                    Valor: ${formatarValor(transacao.valor)}
                    Data: ${formatarData(transacao.data)}
                    Status: ${transacao.status.charAt(0).toUpperCase() + transacao.status.slice(1)}
                    Observa√ß√µes: ${transacao.observacoes || 'Nenhuma'}
                `);
            }
        }

        // ===== FUN√á√ÉO PARA CARREGAR MEMBROS DA PLANILHA =====
        async function carregarMembrosParaFacturas() {
            try {
                console.log('üì• Carregando membros para facturas...');
                mostrarLoading('Carregando lista de associados...');

                const response = await fetch(`${MEMBROS_GAS_URL}?action=getMembers`);

                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }

                const result = await response.json();
                console.log('‚úÖ Dados dos membros recebidos:', result);

                if (result.success && result.members) {
                    listaMembrosCompleta = result.members.map(membro => ({
                        id: membro.id || 0,
                        nome: membro.nome || '',
                        numeroMembro: membro.numeroMembro || '',
                        categoria: membro.categoria || '',
                        telefone: membro.telefone || '',
                        email: membro.email || '',
                        empresa: membro.empresa || '',
                        cargo: membro.funcao || 'Associado', // ATEN√á√ÉO: campo mudou para "funcao"
                        status: membro.status || 'Regular'
                    }));

                    console.log(`‚úÖ ${listaMembrosCompleta.length} membros carregados para facturas`);

                    // Atualizar o datalist do modal de facturas
                    atualizarDatalistAssociados();

                    return true;
                } else {
                    console.warn('‚ö†Ô∏è Nenhum membro encontrado ou erro na resposta');
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar membros para facturas:', error);
                mostrarErro('Erro ao carregar lista de associados');
                return false;
            } finally {
                esconderLoading();
            }
        }

        // ===== FUN√á√ÉO PARA ATUALIZAR O DATALIST =====
        function atualizarDatalistAssociados() {
            const datalist = document.getElementById('lista-associados');
            if (!datalist) {
                console.error('‚ùå Datalist n√£o encontrado');
                return;
            }

            // Limpar op√ß√µes existentes
            datalist.innerHTML = '';

            if (listaMembrosCompleta.length === 0) {
                console.log('‚ö†Ô∏è Nenhum membro para adicionar ao datalist');
                return;
            }

            // Adicionar cada membro como uma op√ß√£o
            listaMembrosCompleta.forEach(membro => {
                const option = document.createElement('option');
                option.value = membro.nome;
                option.setAttribute('data-numero', membro.numeroMembro);
                option.setAttribute('data-funcao', membro.cargo || 'Associado');
                option.setAttribute('data-categoria', membro.categoria);
                option.setAttribute('data-telefone', membro.telefone);
                option.setAttribute('data-email', membro.email);
                datalist.appendChild(option);
            });

            console.log(`‚úÖ Datalist atualizado com ${listaMembrosCompleta.length} membros`);
        }

        
        // Facturas - Modificar a fun√ß√£o abrirModalFactura
        function abrirModalFactura(factura = null) {
            const titulo = document.getElementById('modal-titulo-factura');
            const form = document.getElementById('form-factura');

            if (factura) {
                titulo.textContent = 'Editar Factura';
                document.getElementById('factura-id').value = factura.id;
                document.getElementById('factura-numero').value = factura.numero;
                document.getElementById('factura-data').value = factura.data;
                document.getElementById('factura-cliente').value = factura.cliente;
                document.getElementById('factura-descricao').value = factura.descricao;
                document.getElementById('factura-quota').value = factura.quota || factura.valor;
                document.getElementById('factura-estado').value = factura.estado;

                document.getElementById('factura-categoria').value = factura.categoria || 'quotas';
                document.getElementById('factura-funcao').value = factura.funcao || '';
                document.getElementById('factura-numero-membro').value = factura.numeroMembro || '';
                document.getElementById('factura-periodo').value = factura.periodo || '';
                document.getElementById('factura-multa').value = factura.multa || 0;
                document.getElementById('factura-joia').value = factura.joia || 0;
            } else {
                titulo.textContent = 'Emitir Nova Factura';
                form.reset();
                document.getElementById('factura-id').value = '';
                document.getElementById('factura-data').value = new Date().toISOString().split('T')[0];
                document.getElementById('factura-numero').value = 'FCT-' + new Date().getFullYear() + '-' + (facturas.length + 1).toString().padStart(3, '0');
                document.getElementById('factura-categoria').value = 'quotas';
                document.getElementById('factura-multa').value = 0;
                document.getElementById('factura-joia').value = 0;

                // CARREGAR LISTA DE MEMBROS QUANDO ABRIR O MODAL
                if (listaMembrosCompleta.length === 0) {
                    setTimeout(() => {
                        carregarMembrosParaFacturas();
                    }, 100);
                } else {
                    atualizarDatalistAssociados();
                }
            }

            atualizarTotalFactura();
            document.getElementById('modal-factura').style.display = 'flex';
        }

        function fecharModalFactura() {
            document.getElementById('modal-factura').style.display = 'none';
        }

        function cancelarFactura() {
            fecharModalFactura();
        }

        async function salvarFactura() {
            const id = document.getElementById('factura-id').value;
            const numero = document.getElementById('factura-numero').value;
            const data = document.getElementById('factura-data').value;
            const cliente = document.getElementById('factura-cliente').value;
            const descricao = document.getElementById('factura-descricao').value;
            const categoria = document.getElementById('factura-categoria').value;
            const funcao = document.getElementById('factura-funcao').value;
            const numeroMembro = document.getElementById('factura-numero-membro').value;
            const periodo = document.getElementById('factura-periodo').value;
            const quota = parseFloat(document.getElementById('factura-quota').value) || 0;
            const multa = parseFloat(document.getElementById('factura-multa').value) || 0;
            const joia = parseFloat(document.getElementById('factura-joia').value) || 0;
            const estado = document.getElementById('factura-estado').value;

            const valorTotal = quota + multa + joia;

            if (!numero || !data || !cliente || !periodo || !estado || quota <= 0) {
                alert('Por favor, preencha todos os campos obrigat√≥rios (*) e insira uma quota v√°lida.');
                return;
            }

            const factura = {
                id: id ? parseInt(id) : null,
                numero: numero,
                data: data,
                cliente: cliente,
                descricao: descricao,
                valor: valorTotal,
                estado: estado,
                categoria: categoria,
                funcao: funcao,
                numeroMembro: numeroMembro,
                periodo: periodo,
                quota: quota,
                multa: multa,
                joia: joia
            };

            const sucesso = await salvarFacturaAPI(factura);
            if (sucesso) {
                // Recarregar facturas e dashboard
                await carregarFacturas(true);
                await carregarDadosDashboard(true);

                // Adicionar notifica√ß√£o espec√≠fica
                adicionarNotificacao(
                    `Factura ${factura.id ? 'Atualizada' : 'Criada'}`,
                    `N¬∫ ${numero} - ${cliente} - ${formatarValor(valorTotal)}`,
                    estado === 'pago' ? 'sucesso' : 'alerta'
                );

                // Verificar prazos imediatamente
                verificarPrazos();

                fecharModalFactura();
            }
        }

        async function eliminarFactura(id) {
            const sucesso = await eliminarFacturaAPI(id);
            return sucesso;
        }

        function editarFactura(id) {
            const factura = facturas.find(f => f.id === id);
            if (factura) abrirModalFactura(factura);
        }

        function verFactura(id) {
            const factura = facturas.find(f => f.id === id);
            if (factura) {
                alert(`
                    N√∫mero: ${factura.numero}
                    Data: ${formatarData(factura.data)}
                    Cliente: ${factura.cliente}
                    Descri√ß√£o: ${factura.descricao}
                    Valor: ${formatarValor(factura.total || factura.valor)}
                    Estado: ${factura.estado.charAt(0).toUpperCase() + factura.estado.slice(1)}
                `);
            }
        }

        // Or√ßamento
        function abrirModalNovoOrcamento() {
            const modal = document.getElementById('modal-novo-orcamento');
            const form = document.getElementById('form-novo-orcamento');

            if (form) form.reset();

            const hoje = new Date();
            document.getElementById('orcamento-data-aprovacao').value = hoje.toISOString().split('T')[0];
            document.getElementById('orcamento-data-inicio').value = hoje.toISOString().split('T')[0];

            const umAnoDepois = new Date(hoje);
            umAnoDepois.setFullYear(hoje.getFullYear() + 1);
            document.getElementById('orcamento-data-fim').value = umAnoDepois.toISOString().split('T')[0];

            modal.style.display = 'flex';
        }

        function fecharModalNovoOrcamento() {
            document.getElementById('modal-novo-orcamento').style.display = 'none';
        }

        function cancelarNovoOrcamento() {
            fecharModalNovoOrcamento();
        }

        async function salvarNovoOrcamento() {
            const nome = document.getElementById('orcamento-nome').value.trim();
            const natureza = document.getElementById('orcamento-natureza').value;
            const orcamentado = parseFloat(document.getElementById('orcamento-valor').value);
            const descricao = document.getElementById('orcamento-descricao').value.trim();
            const dataAprovacao = document.getElementById('orcamento-data-aprovacao').value;
            const dataInicio = document.getElementById('orcamento-data-inicio').value;
            const dataFim = document.getElementById('orcamento-data-fim').value;

            if (!nome || !natureza || !orcamentado || !dataAprovacao || !dataInicio || !dataFim) {
                alert('Por favor, preencha todos os campos obrigat√≥rios.');
                return;
            }

            const inicio = new Date(dataInicio);
            const fim = new Date(dataFim);
            if (fim <= inicio) {
                alert('A Data de Fim deve ser posterior √† Data de In√≠cio.');
                return;
            }

            const orcamentoItem = {
                nome: nome,
                natureza: natureza,
                orcamentado: orcamentado,
                descricao: descricao || 'Sem descri√ß√£o',
                dataAprovacao: dataAprovacao,
                dataInicio: dataInicio,
                dataFim: dataFim
            };

            const resultado = await salvarOrcamentoAPI(orcamentoItem);
            if (resultado) fecharModalNovoOrcamento();
        }

        function visualizarOrcamento(id) {
            const item = orcamento.find(o => o.id === id);
            if (!item) {
                alert('Or√ßamento n√£o encontrado.');
                return;
            }

            const modal = document.getElementById('modal-visualizar-orcamento');
            const detalhes = document.getElementById('detalhes-orcamento');

            let statusClass = '';
            if (item.status === 'Anulado') statusClass = 'status atrasado';
            else if (item.status === 'Suspenso') statusClass = 'status pendente';
            else if (item.status === 'Alerta') statusClass = 'status atrasado';
            else if (item.status === 'Aten√ß√£o') statusClass = 'status pendente';
            else statusClass = 'status pago';

            detalhes.innerHTML = `
                <div class="form-group">
                    <label><strong>Nome do Or√ßamento:</strong></label>
                    <div class="form-control" style="background-color: #f8f9fa; margin-bottom: 15px;">${item.nome}</div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label><strong>Natureza:</strong></label>
                        <div class="form-control" style="background-color: #f8f9fa;">${item.natureza}</div>
                    </div>
                    <div class="form-group">
                        <label><strong>Or√ßamento (kz):</strong></label>
                        <div class="form-control" style="background-color: #f8f9fa;">${formatarValor(item.orcamentado)}</div>
                    </div>
                </div>
                <div class="form-group">
                    <label><strong>Descri√ß√£o:</strong></label>
                    <div class="form-control" style="background-color: #f8f9fa; min-height: 80px;">${item.descricao || 'Nenhuma descri√ß√£o fornecida'}</div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label><strong>Data de Aprova√ß√£o:</strong></label>
                        <div class="form-control" style="background-color: #f8f9fa;">${formatarData(item.dataAprovacao)}</div>
                    </div>
                    <div class="form-group">
                        <label><strong>Data de In√≠cio:</strong></label>
                        <div class="form-control" style="background-color: #f8f9fa;">${formatarData(item.dataInicio)}</div>
                    </div>
                    <div class="form-group">
                        <label><strong>Data de Fim:</strong></label>
                        <div class="form-control" style="background-color: #f8f9fa;">${formatarData(item.dataFim)}</div>
                    </div>
                </div>
                <hr style="margin: 20px 0;">
                <div class="form-row">
                    <div class="form-group">
                        <label><strong>Or√ßamentado:</strong></label>
                        <div class="form-control" style="background-color: #f8f9fa; color: var(--primary); font-weight: bold;">${formatarValor(item.orcamentado)}</div>
                    </div>
                    <div class="form-group">
                        <label><strong>Realizado:</strong></label>
                        <div class="form-control" style="background-color: #f8f9fa; color: var(--success); font-weight: bold;">${formatarValor(item.realizado)}</div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label><strong>Diferen√ßa:</strong></label>
                        <div class="form-control" style="background-color: #f8f9fa; color: ${item.diferenca >= 0 ? 'var(--success)' : 'var(--danger)'}; font-weight: bold;">${formatarValor(item.diferenca)}</div>
                    </div>
                    <div class="form-group">
                        <label><strong>% Realizado:</strong></label>
                        <div class="form-control" style="background-color: #f8f9fa; color: ${item.percentual >= 70 ? 'var(--danger)' : item.percentual >= 50 ? 'var(--warning)' : 'var(--success)'}; font-weight: bold;">${item.percentual.toFixed(1)}%</div>
                    </div>
                </div>
                <div class="form-group">
                    <label><strong>Status:</strong></label>
                    <div class="form-control" style="background-color: #f8f9fa;">
                        <span class="${statusClass}" style="font-size: 14px; padding: 8px 12px;">${item.status}</span>
                    </div>
                </div>
            `;

            modal.style.display = 'flex';
        }

        function fecharModalVisualizarOrcamento() {
            document.getElementById('modal-visualizar-orcamento').style.display = 'none';
        }

        function cancelarVisualizarOrcamento() {
            fecharModalVisualizarOrcamento();
        }

        function editarOrcamento(id) {
            const item = orcamento.find(o => o.id === id);
            if (!item) {
                alert('Or√ßamento n√£o encontrado.');
                return;
            }

            const modal = document.getElementById('modal-editar-orcamento');

            document.getElementById('editar-orcamento-id').value = item.id;
            document.getElementById('editar-orcamento-valor-atual').value = item.realizado;
            document.getElementById('editar-orcamento-status').value = item.status;
            document.getElementById('editar-orcamento-realizado').value = item.realizado;
            document.getElementById('editar-orcamento-data-inicio').value = item.dataInicio;
            document.getElementById('editar-orcamento-data-fim').value = item.dataFim;

            document.getElementById('minimo-realizado').textContent = formatarValor(item.realizado);

            const inputRealizado = document.getElementById('editar-orcamento-realizado');
            inputRealizado.min = item.realizado;

            modal.style.display = 'flex';
        }

        

        function cancelarEditarOrcamento() {
            fecharModalEditarOrcamento();
        }

        async function salvarEditarOrcamento() {
            console.log('üîß DEBUG: salvarEditarOrcamento INICIADA');
            const id = parseInt(document.getElementById('editar-orcamento-id').value);
            const valorAtual = parseFloat(document.getElementById('editar-orcamento-valor-atual').value);
            const status = document.getElementById('editar-orcamento-status').value;
            const realizado = parseFloat(document.getElementById('editar-orcamento-realizado').value);
            const dataInicio = document.getElementById('editar-orcamento-data-inicio').value;
            const dataFim = document.getElementById('editar-orcamento-data-fim').value;

            if (!status) {
                alert('Por favor, selecione o Status do or√ßamento.');
                document.getElementById('editar-orcamento-status').focus();
                return;
            }

            if (!realizado || realizado < 0) {
                alert('Por favor, insira um valor v√°lido para o Realizado.');
                document.getElementById('editar-orcamento-realizado').focus();
                return;
            }

            if (realizado < valorAtual) {
                alert(`O valor realizado (${formatarValor(realizado)}) n√£o pode ser inferior ao valor atual (${formatarValor(valorAtual)}).`);
                document.getElementById('editar-orcamento-realizado').focus();
                return;
            }

            if (!dataInicio) {
                alert('Por favor, insira a Data de In√≠cio.');
                document.getElementById('editar-orcamento-data-inicio').focus();
                return;
            }

            if (!dataFim) {
                alert('Por favor, insira a Data de Fim.');
                document.getElementById('editar-orcamento-data-fim').focus();
                return;
            }

            try {
                mostrarLoading('Atualizando or√ßamento...');

                console.log('üì§ ENVIANDO PARA O GAS:', {
                    id: id,
                    status: status,
                    realizado: realizado,
                    dataInicio: dataInicio,
                    dataFim: dataFim
                });

                const resultado = await fazerRequisicaoPOST('updateBudget', {
                    id: id,
                    status: status,
                    realizado: realizado,
                    dataInicio: dataInicio,
                    dataFim: dataFim
                });

                console.log('üì• RESPOSTA DO GAS:', resultado);

                console.log('üì• RESPOSTA DO GAS (COMPLETA):', JSON.stringify(resultado));

                if (resultado.success) {
                    mostrarSucesso('Or√ßamento atualizado com sucesso!');

                    // 1. Fechar modal PRIMEIRO
                    fecharModalEditarOrcamento();

                    // 2. Recarregar dados do GAS
                    await carregarOrcamentos(true);

                    console.log('üìä DETALHES do array orcamento:', orcamento.map(item => ({
                        id: item.id,
                        nome: item.nome,
                        realizado: item.realizado,
                        percentual: item.percentual
                    })));

                    console.log('üéØ ITEM ESPEC√çFICO ID 13:', orcamento.find(item => item.id === 13));

                    console.log('‚úÖ Tabela atualizada com dados do GAS');
                } else {
                    mostrarErro('Erro ao atualizar or√ßamento: ' + resultado.message);
                }

            } catch (error) {
                console.error('Erro ao atualizar or√ßamento:', error);
                mostrarErro('Erro ao atualizar or√ßamento no servidor');
            } finally {
                esconderLoading();
            }
        }

        function fecharModalEditarOrcamento() {
            console.log('üîß DEBUG: fecharModalEditarOrcamento CHAMADA');
            const modal = document.getElementById('modal-editar-orcamento');
            if (modal) modal.style.display = 'none';
                      }

        // Relat√≥rios
        function abrirModalNovoRelatorio() {
            const modal = document.getElementById('modal-novo-relatorio');
            if (!modal) {
                alert('Modal de relat√≥rio n√£o encontrado. Recarregue a p√°gina.');
                return;
            }

            const form = document.getElementById('form-novo-relatorio');
            if (form) form.reset();

            document.getElementById('relatorio-data').value = new Date().toISOString().split('T')[0];

            const hoje = new Date();
            const mesAtual = hoje.toLocaleString('pt-PT', { month: 'long' });
            const anoAtual = hoje.getFullYear();
            document.getElementById('relatorio-periodo').value = `${mesAtual.charAt(0).toUpperCase() + mesAtual.slice(1)} ${anoAtual}`;

            modal.style.display = 'flex';
        }

        function fecharModalNovoRelatorio() {
            const modal = document.getElementById('modal-novo-relatorio');
            if (modal) modal.style.display = 'none';
        }

        function cancelarRelatorio() {
            fecharModalNovoRelatorio();
        }

        async function salvarNovoRelatorio() {
            const nome = document.getElementById('relatorio-nome').value.trim();
            const tipo = document.getElementById('relatorio-tipo').value;
            const periodo = document.getElementById('relatorio-periodo').value.trim();
            const data = document.getElementById('relatorio-data').value;
            const autor = document.getElementById('relatorio-autor').value.trim();
            const descricao = document.getElementById('relatorio-descricao').value.trim();
            const arquivoInput = document.getElementById('relatorio-upload');
            const arquivo = arquivoInput.files[0];

            if (!nome || !tipo || !periodo || !data || !autor || !arquivo) {
                alert('‚ùå Preencha todos os campos!');
                return;
            }

            if (arquivo.type !== 'application/pdf') {
                alert('‚ùå Selecione um arquivo PDF!');
                return;
            }

            if (arquivo.size > 10 * 1024 * 1024) {
                alert('‚ùå Arquivo muito grande! M√°ximo: 10MB');
                return;
            }

            try {
                mostrarLoading('Enviando PDF...');

                // Converter para Base64
                const base64Data = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = reject;
                    reader.readAsDataURL(arquivo);
                });

                // Preparar dados
                const dados = new URLSearchParams();
                dados.append('action', 'addReportWithPdf');
                dados.append('nome', nome);
                dados.append('tipo', tipo);
                dados.append('periodo', periodo);
                dados.append('data', data);
                dados.append('autor', autor);
                dados.append('descricao', descricao);
                dados.append('pdfBase64', base64Data);
                dados.append('pdfFileName', arquivo.name);

                // Enviar
                const resposta = await fetch(GAS_URL, {
                    method: 'POST',
                    body: dados
                });

                const resultado = await resposta.json();

                if (resultado.success) {
                    mostrarSucesso('‚úÖ Relat√≥rio salvo!');
                    fecharModalNovoRelatorio();
                    await carregarRelatorios();
                } else {
                    mostrarErro('‚ùå ' + resultado.message);
                }
            } catch (error) {
                console.error('Erro:', error);
                mostrarErro('‚ùå Erro ao salvar');
            } finally {
                esconderLoading();
            }
        }

        function verRelatorio(id) {
            const relatorio = relatorios.find(r => r.id === id);
            if (relatorio) {
                alert(`
                    Nome: ${relatorio.nome}
                    Tipo: ${relatorio.tipo.charAt(0).toUpperCase() + relatorio.tipo.slice(1)}
                    Per√≠odo: ${relatorio.periodo}
                    Data de Gera√ß√£o: ${formatarData(relatorio.data)}
                    Autor: ${relatorio.autor}
                `);
            }
        }

        async function baixarRelatorio(id) {
            const relatorio = relatorios.find(r => r.id === id);
            if (!relatorio) {
                mostrarErro('Relat√≥rio n√£o encontrado');
                return;
            }

            try {
                mostrarLoading('Preparando download...');

                // Verificar se temos URL do PDF
                if (relatorio.pdfUrl) {
                    // Abrir URL em nova aba
                    window.open(relatorio.pdfUrl, '_blank');
                } else {
                    // Buscar URL do PDF no GAS
                    const resultado = await fazerRequisicao('getReportPdfUrl', { id: id });

                    if (resultado.success && resultado.pdfUrl) {
                        window.open(resultado.pdfUrl, '_blank');
                    } else {
                        mostrarErro('PDF n√£o dispon√≠vel para download');
                    }
                }
            } catch (error) {
                console.error('Erro ao baixar relat√≥rio:', error);
                mostrarErro('Erro ao baixar relat√≥rio');
            } finally {
                esconderLoading();
            }
        }

        // Previs√£o de saldo
        function abrirModalPrevisaoSaldo() {
            const modal = document.getElementById('modal-previsao-saldo');
            const form = document.getElementById('form-previsao-saldo');

            if (form) form.reset();

            const hoje = new Date();
            document.getElementById('previsao-saldo-data').value = hoje.toISOString().split('T')[0];

            const saldoAtualElement = document.getElementById('saldo-previsto');
            if (saldoAtualElement) {
                const valorAtual = saldoAtualElement.textContent.replace(' Kz', '').replace(/\./g, '').replace(',', '.');
                const valorNumerico = parseFloat(valorAtual);
                if (!isNaN(valorNumerico)) {
                    document.getElementById('previsao-saldo-valor').value = valorNumerico;
                }
            }

            modal.style.display = 'flex';
        }

        function fecharModalPrevisaoSaldo() {
            document.getElementById('modal-previsao-saldo').style.display = 'none';
        }

        function cancelarPrevisaoSaldo() {
            fecharModalPrevisaoSaldo();
        }

        function salvarPrevisaoSaldo() {
            const valor = parseFloat(document.getElementById('previsao-saldo-valor').value);
            const data = document.getElementById('previsao-saldo-data').value;

            if (!valor || valor <= 0) {
                alert('Por favor, insira um valor v√°lido para o Saldo Previsto.');
                document.getElementById('previsao-saldo-valor').focus();
                return;
            }

            if (!data) {
                alert('Por favor, insira a Data de Previs√£o.');
                document.getElementById('previsao-saldo-data').focus();
                return;
            }

            const saldoPrevistoElement = document.getElementById('saldo-previsto');
            if (saldoPrevistoElement) {
                saldoPrevistoElement.textContent = formatarValor(valor);

                const percentElement = document.getElementById('percent-previsto');
                if (percentElement) {
                    const saldoAtualElement = document.getElementById('saldo-atual');
                    if (saldoAtualElement) {
                        const saldoAtualTexto = saldoAtualElement.textContent.replace(' Kz', '').replace(/\./g, '').replace(',', '.');
                        const saldoAtual = parseFloat(saldoAtualTexto);

                        if (!isNaN(saldoAtual) && saldoAtual > 0) {
                            const percentual = ((valor - saldoAtual) / saldoAtual) * 100;
                            percentElement.textContent = percentual >= 0 ? `+${percentual.toFixed(1)}%` : `${percentual.toFixed(1)}%`;

                            const progressFill = document.querySelectorAll('.progress-fill')[3];
                            if (progressFill) {
                                const percentProgress = Math.min((valor / 2000000) * 100, 100);
                                progressFill.style.width = percentProgress + '%';
                            }
                        }
                    }
                }

                localStorage.setItem('previsaoSaldo', JSON.stringify({
                    valor: valor,
                    data: data,
                    dataAtualizacao: new Date().toISOString()
                }));

                fecharModalPrevisaoSaldo();
                mostrarSucesso('Previs√£o de saldo atualizada com sucesso!');
            }
        }

        

        // ===== FUN√á√ïES DE GR√ÅFICOS =====
        function inicializarGraficos() {
            console.log('üìä Inicializando gr√°ficos...');

            // Verificar se os elementos canvas existem
            const fluxoCanvas = document.getElementById('fluxoCaixaChart');
            const categoriasCanvas = document.getElementById('categoriasDespesasChart');

            if (!fluxoCanvas || !categoriasCanvas) {
                console.error('‚ùå Canvas dos gr√°ficos n√£o encontrados');
                return;
            }

            // DESTRUI√á√ÉO SEGURA - com verifica√ß√£o rigorosa
            try {
                if (window.fluxoCaixaChart &&
                    typeof window.fluxoCaixaChart === 'object' &&
                    typeof window.fluxoCaixaChart.destroy === 'function') {
                    console.log('üóëÔ∏è Destruindo gr√°fico de fluxo existente...');
                    window.fluxoCaixaChart.destroy();
                }
            } catch (e) {
                console.error('‚ùå Erro ao tentar destruir fluxoCaixaChart:', e);
            }

            try {
                if (window.categoriasDespesasChart &&
                    typeof window.categoriasDespesasChart === 'object' &&
                    typeof window.categoriasDespesasChart.destroy === 'function') {
                    console.log('üóëÔ∏è Destruindo gr√°fico de categorias existente...');
                    window.categoriasDespesasChart.destroy();
                }
            } catch (e) {
                console.error('‚ùå Erro ao tentar destruir categoriasDespesasChart:', e);
            }

            // Resetar as vari√°veis globais
            window.fluxoCaixaChart = undefined;
            window.categoriasDespesasChart = undefined;

            // Limpar canvas
            try {
                fluxoCanvas.width = fluxoCanvas.width;
                categoriasCanvas.width = categoriasCanvas.width;
            } catch (e) {
                console.log('‚ö†Ô∏è N√£o foi poss√≠vel limpar canvas:', e);
            }

            // CRIAR NOVOS GR√ÅFICOS com tratamento de erro
            let fluxoSucesso = false;
            let categoriasSucesso = false;

            try {
                // 1. Gr√°fico de fluxo de caixa
                const fluxoCaixaCtx = fluxoCanvas.getContext('2d');
                window.fluxoCaixaChart = new Chart(fluxoCaixaCtx, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'],
                        datasets: [
                            {
                                label: 'Receitas',
                                data: [0, 0, 0, 0, 0, 0],
                                borderColor: '#28a745',
                                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4
                            },
                            {
                                label: 'Despesas',
                                data: [0, 0, 0, 0, 0, 0],
                                borderColor: '#dc3545',
                                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function (value) {
                                        return value.toLocaleString('pt-AO') + ' Kz';
                                    }
                                }
                            }
                        }
                    }
                });
                fluxoSucesso = true;
                console.log('‚úÖ Gr√°fico de fluxo criado');
            } catch (error) {
                console.error('‚ùå Erro ao criar gr√°fico de fluxo:', error);
            }

            try {
                // 2. Gr√°fico de categorias de despesas
                const categoriasDespesasCtx = categoriasCanvas.getContext('2d');
                window.categoriasDespesasChart = new Chart(categoriasDespesasCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Carregando...'],
                        datasets: [{
                            data: [100],
                            backgroundColor: ['#f8f9fa'],
                            borderWidth: 1,
                            borderColor: 'white'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '65%',
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
                categoriasSucesso = true;
                console.log('‚úÖ Gr√°fico de categorias criado');
            } catch (error) {
                console.error('‚ùå Erro ao criar gr√°fico de categorias:', error);
            }

            // GR√ÅFICOS DE OR√áAMENTO (se os elementos existirem)
            const execucaoCanvas = document.getElementById('execucaoOrcamentoChart');
            const comparacaoCanvas = document.getElementById('comparacaoOrcamentoChart');

            if (execucaoCanvas) {
                try {
                    const execucaoOrcamentoCtx = execucaoCanvas.getContext('2d');
                    window.execucaoOrcamentoChart = new Chart(execucaoOrcamentoCtx, {
                        type: 'bar',
                        data: {
                            labels: ['Carregando...'],
                            datasets: [
                                {
                                    label: 'Or√ßamentado',
                                    data: [0],
                                    backgroundColor: 'rgba(26, 78, 142, 0.7)'
                                },
                                {
                                    label: 'Realizado',
                                    data: [0],
                                    backgroundColor: 'rgba(40, 167, 69, 0.7)'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                    console.log('‚úÖ Gr√°fico de execu√ß√£o or√ßamental criado');
                } catch (e) {
                    console.error('‚ùå Erro ao criar gr√°fico de execu√ß√£o:', e);
                }
            }

            if (comparacaoCanvas) {
                try {
                    const comparacaoOrcamentoCtx = comparacaoCanvas.getContext('2d');
                    window.comparacaoOrcamentoChart = new Chart(comparacaoOrcamentoCtx, {
                        type: 'radar',
                        data: {
                            labels: ['Carregando...'],
                            datasets: [
                                {
                                    label: 'Or√ßamentado (Kz)',  // <-- Deve dizer (Kz)
                                    data: [],
                                    backgroundColor: 'rgba(26, 78, 142, 0.2)',
                                    borderColor: '#1a4e8e',
                                    borderWidth: 2,
                                    fill: true
                                },
                                {
                                    label: 'Realizado (Kz)',  // <-- Deve dizer (Kz)
                                    data: [],
                                    backgroundColor: 'rgba(40, 167, 69, 0.2)',
                                    borderColor: '#28a745',
                                    borderWidth: 2,
                                    fill: true
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                r: {
                                    beginAtZero: true,
                                    min: 0
                                }
                            }
                        }
                    });
                    console.log('‚úÖ Gr√°fico de compara√ß√£o or√ßamental criado');
                } catch (e) {
                    console.error('‚ùå Erro ao criar gr√°fico de compara√ß√£o:', e);
                }
            }

            // Atualizar vari√°vel GLOBAL
            chartsInicializados = fluxoSucesso && categoriasSucesso;

            if (chartsInicializados) {
                console.log('‚úÖ Todos os gr√°ficos inicializados com sucesso');
            } else {
                console.warn('‚ö†Ô∏è Alguns gr√°ficos n√£o foram inicializados');
            }
        }

            
        function atualizarGraficosComDadosReais() {
            console.log('üîÑ Atualizando gr√°ficos com dados reais...');

            // Verifica√ß√£o simples
            if (!window.fluxoCaixaChart || !window.categoriasDespesasChart) {
                console.log('üìä Gr√°ficos n√£o encontrados, inicializando...');
                inicializarGraficos();

                // Aguardar um pouco e tentar novamente
                setTimeout(atualizarGraficosComDadosReais, 300);
                return;
            }

            // Calcular dados dos √∫ltimos 6 meses (CORRIGIDO)
            const hoje = new Date();
            const ultimos6Meses = [];
            const receitasPorMes = [];
            const despesasPorMes = [];

            // Primeiro: Determinar quais meses vamos mostrar (√∫ltimos 6 meses)
            for (let i = 5; i >= 0; i--) {
                const data = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1);
                const nomeMes = data.toLocaleDateString('pt-PT', { month: 'short' });
                // Corre√ß√£o: garantir apenas 3 caracteres e capitaliza√ß√£o correta
                ultimos6Meses.push(nomeMes.charAt(0).toUpperCase() + nomeMes.slice(1).replace('.', ''));
            }

            console.log('üìÖ Meses a mostrar:', ultimos6Meses);

            // Inicializar arrays com zeros
            for (let i = 0; i < 6; i++) {
                receitasPorMes.push(0);
                despesasPorMes.push(0);
            }

            // AGORA: Calcular valores para cada m√™s
            transacoes.forEach(t => {
                if (!t.data || t.status !== 'pago') return;

                try {
                    const dataTransacao = parsearDataPortugues(t.data);
                    if (isNaN(dataTransacao.getTime())) return;

                    const mesTransacao = dataTransacao.getMonth() + 1; // 1-12
                    const anoTransacao = dataTransacao.getFullYear();

                    // Verificar em qual dos √∫ltimos 6 meses esta transa√ß√£o se encaixa
                    for (let i = 0; i < 6; i++) {
                        const dataMes = new Date(hoje.getFullYear(), hoje.getMonth() - (5 - i), 1);
                        const mesTarget = dataMes.getMonth() + 1;
                        const anoTarget = dataMes.getFullYear();

                        if (mesTransacao === mesTarget && anoTransacao === anoTarget) {
                            const valor = parseFloat(t.valor || 0);

                            if (t.tipo === 'receita') {
                                receitasPorMes[i] += valor;
                            } else if (t.tipo === 'despesa') {
                                despesasPorMes[i] += valor;
                            }
                            break;
                        }
                    }
                } catch (error) {
                    console.error('Erro ao processar transa√ß√£o:', t, error);
                }
            });

            // Adicionar facturas tamb√©m
            facturas.forEach(f => {
                if (!f.data || f.estado !== 'pago') return;

                try {
                    const dataFactura = parsearDataPortugues(f.data);
                    if (isNaN(dataFactura.getTime())) return;

                    const mesFactura = dataFactura.getMonth() + 1;
                    const anoFactura = dataFactura.getFullYear();

                    for (let i = 0; i < 6; i++) {
                        const dataMes = new Date(hoje.getFullYear(), hoje.getMonth() - (5 - i), 1);
                        const mesTarget = dataMes.getMonth() + 1;
                        const anoTarget = dataMes.getFullYear();

                        if (mesFactura === mesTarget && anoFactura === anoTarget) {
                            const valor = parseFloat(f.total || f.valor || 0);
                            receitasPorMes[i] += valor;
                            break;
                        }
                    }
                } catch (error) {
                    console.error('Erro ao processar factura:', f, error);
                }
            });

            console.log('üí∞ Receitas por m√™s:', receitasPorMes);
            console.log('üí∏ Despesas por m√™s:', despesasPorMes);


                // Atualizar gr√°fico de fluxo de caixa
                if (window.fluxoCaixaChart) {
                    window.fluxoCaixaChart.data.labels = ultimos6Meses;
                    window.fluxoCaixaChart.data.datasets[0].data = receitasPorMes;
                    window.fluxoCaixaChart.data.datasets[1].data = despesasPorMes;
                    window.fluxoCaixaChart.update();
                    console.log('üìä Gr√°fico de fluxo atualizado');
                }

                // Calcular categorias de despesas do m√™s atual
                const mesAtual = hoje.getMonth() + 1;
                const anoAtual = hoje.getFullYear();

                const despesasMesAtual = transacoes.filter(t => {
                    if (!t.data || t.tipo !== 'despesa' || t.status !== 'pago') return false;
                    const dataTransacao = parsearDataPortugues(t.data);
                    if (isNaN(dataTransacao.getTime())) return false;
                    return dataTransacao.getMonth() + 1 === mesAtual &&
                        dataTransacao.getFullYear() === anoAtual;
                });

                const categoriasMap = {};
                despesasMesAtual.forEach(t => {
                    const categoria = t.natureza || 'Outros';
                    const valor = parseFloat(t.valor || 0);

                    if (!categoriasMap[categoria]) {
                        categoriasMap[categoria] = 0;
                    }
                    categoriasMap[categoria] += valor;
                });

                const categoriasLabels = Object.keys(categoriasMap);
                const categoriasValores = Object.values(categoriasMap);

                // Se n√£o houver dados, mostrar mensagem
                if (categoriasLabels.length === 0 || categoriasValores.reduce((a, b) => a + b, 0) === 0) {
                    categoriasLabels.length = 0;
                    categoriasValores.length = 0;
                    categoriasLabels.push('Sem despesas');
                    categoriasValores.push(1);
                }

                // Atualizar gr√°fico de categorias
                if (window.categoriasDespesasChart) {
                    window.categoriasDespesasChart.data.labels = categoriasLabels;
                    window.categoriasDespesasChart.data.datasets[0].data = categoriasValores;

                    // Atualizar cores se necess√°rio
                    const cores = ['#1a4e8e', '#28a745', '#ffc107', '#6f42c1', '#17a2b8', '#fd7e14'];
                    const backgroundColors = categoriasLabels.map((_, index) =>
                        cores[index % cores.length] || '#6c757d'
                    );

                    window.categoriasDespesasChart.data.datasets[0].backgroundColor = backgroundColors;
                    window.categoriasDespesasChart.update();
                    console.log('üìä Gr√°fico de categorias atualizado');
                }
            }

        

            

        // ===== FUN√á√ïES DE EXPORTA√á√ÉO =====
        async function exportarRelatorioPDF() {
            try {
                const btnExportar = document.getElementById('btn-exportar-relatorio');
                const originalText = btnExportar.innerHTML;
                btnExportar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gerando PDF...';
                btnExportar.disabled = true;

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // T√≠tulo
                doc.setFontSize(20);
                doc.text('Relat√≥rio Financeiro - AGETRHA', 105, 20, { align: 'center' });

                // Data de emiss√£o
                doc.setFontSize(12);
                doc.text(`Emitido em: ${new Date().toLocaleDateString('pt-PT')}`, 105, 30, { align: 'center' });

                // Resumo financeiro
                doc.setFontSize(16);
                doc.text('Resumo Financeiro', 20, 50);

                doc.setFontSize(12);
                doc.text(`Saldo Atual: ${document.getElementById('saldo-atual').textContent}`, 20, 65);
                doc.text(`Receitas do M√™s: ${document.getElementById('receitas-mes').textContent}`, 20, 75);
                doc.text(`Despesas do M√™s: ${document.getElementById('despesas-mes').textContent}`, 20, 85);
                doc.text(`Saldo Previsto: ${document.getElementById('saldo-previsto').textContent}`, 20, 95);

                // Transa√ß√µes recentes
                doc.addPage();
                doc.setFontSize(16);
                doc.text('Transa√ß√µes Recentes', 20, 20);

                let transacaoYPos = 40;
                const recentes = [...transacoes]
                    .sort((a, b) => new Date(b.data) - new Date(a.data))
                    .slice(0, 10);

                recentes.forEach(transacao => {
                    if (transacaoYPos > 270) {
                        doc.addPage();
                        transacaoYPos = 20;
                    }

                    doc.setFontSize(10);
                    doc.text(`${formatarData(transacao.data)} - ${transacao.descricao}`, 20, transacaoYPos);
                    doc.text(`${formatarValor(transacao.valor)} - ${transacao.status}`, 150, transacaoYPos);
                    transacaoYPos += 7;
                });

                // Rodap√©
                doc.setFontSize(10);
                doc.text('Relat√≥rio gerado automaticamente pelo Sistema de Gest√£o Financeira AGETRHA', 105, 285, { align: 'center' });

                // Salvar o PDF
                doc.save('Relatorio_Financeiro_Completo_AGETRHA.pdf');

                // Restaurar bot√£o
                btnExportar.innerHTML = originalText;
                btnExportar.disabled = false;

            } catch (error) {
                console.error('Erro ao exportar relat√≥rio:', error);
                mostrarErro('Erro ao gerar o relat√≥rio. Tente novamente.');

                const btnExportar = document.getElementById('btn-exportar-relatorio');
                if (btnExportar) {
                    btnExportar.innerHTML = '<i class="fas fa-download"></i> Exportar Relat√≥rio PDF';
                    btnExportar.disabled = false;
                }
            }
        }


        
        // ===== FUN√á√ÉO PARA ADICIONAR CARIMBO "PAGO" SOBRE A TABELA =====
        function adicionarCarimboPago(doc, centerX, centerY) {
            doc.saveGraphicsState();
            try {
                doc.setGState(new doc.GState({ opacity: 0.2 }));
            } catch (e) {
                console.log("Transpar√™ncia n√£o suportada");
            }
            doc.setFontSize(100);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(40, 167, 69);
            doc.text('PAGO', centerX, centerY, {
                align: 'center',
                baseline: 'middle',
                angle: 45
            });
            doc.restoreGraphicsState();
        }

        // ===== PR√â-CARREGAR LOGOTIPO =====
        function preCarregarLogotipo() {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = "anonymous";
                img.src = 'https://drive.google.com/thumbnail?id=1PJxV5CT_QeUftOafCZfava7XE_SPPpRI&sz=w150';

                img.onload = () => {
                    console.log('‚úÖ Logotipo carregado com sucesso');
                    resolve(img);
                };

                img.onerror = () => {
                    console.warn('‚ö†Ô∏è N√£o foi poss√≠vel carregar o logotipo');
                    resolve(null); // N√£o rejeita, apenas retorna null
                };
            });
        }

        // Chamar na inicializa√ß√£o
        // ===== INICIALIZA√á√ÉO =====
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Sistema iniciando...');
    
    // Configurar eventos de login primeiro
    configurarEventosLogin();
    
    // Verificar se j√° existe sess√£o ativa
    if (verificarSessaoAtiva()) {
        console.log('‚úÖ Sess√£o v√°lida encontrada, inicializando sistema...');
        isAuthenticated = true;
        esconderModalLogin();
        inicializarSistemaCompleto(); // ‚Üê TUDO inicializado aqui
    } else {
        console.log('üîí Exigindo autentica√ß√£o...');
        mostrarModalLogin();
    }

    preCarregarLogotipo();
       });

        // ===== FUN√á√ÉO PRINCIPAL DE IMPRESS√ÉO DE FACTURA CORRIGIDA =====
        function imprimirFactura(id) {
            console.log('üé® Gerando factura com design profissional corrigido, ID:', id);

            const factura = facturas.find(f => f.id === id);
            if (!factura || !window.jspdf) {
                alert('Factura n√£o encontrada ou biblioteca PDF n√£o dispon√≠vel.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Configura√ß√µes da p√°gina
            const pageWidth = doc.internal.pageSize.width;
            const pageHeight = doc.internal.pageSize.height;
            const marginLeft = 15;
            const marginRight = 15;
            const contentWidth = pageWidth - marginLeft - marginRight;

            // Paleta de cores profissional
            const colors = {
                primaryDark: [26, 78, 142],    // Azul escuro AGETRHA
                primaryLight: [42, 108, 186],  // Azul claro
                secondary: [40, 167, 69],      // Verde sucesso
                accent: [255, 193, 7],         // Amarelo/alerta
                lightGray: [248, 249, 250],    // Cinza claro
                mediumGray: [108, 117, 125],   // Cinza m√©dio
                darkGray: [52, 58, 64],        // Cinza escuro
                white: [255, 255, 255]
            };

            // Adicionar carimbo "PAGO" se a factura estiver paga
            if (factura.estado && factura.estado.toLowerCase() === 'pago') {
                adicionarCarimboPago(doc, pageWidth, pageHeight);
            }

            let yPos = 20;

            // ===== CABE√áALHO ELEGANTE =====
            yPos = criarCabecalhoProfissional(doc, factura, pageWidth, colors, yPos);

            // ===== INFORMA√á√ïES DA EMPRESA E CLIENTE =====
            yPos = criarSecaoInformacoes(doc, factura, marginLeft, marginRight, pageWidth, colors, yPos);

            // ===== TABELA DE ITENS COM DESIGN MODERNO =====
            yPos = criarTabelaItensProfissional(doc, factura, marginLeft, marginRight, pageWidth, colors, yPos);

            if (factura.estado && factura.estado.toLowerCase() === 'pago') {
                adicionarCarimboPago(doc, pageWidth / 2, yPos - 30);
            }

            // ===== RESUMO FINANCEIRO DESTACADO =====
            yPos = criarResumoFinanceiro(doc, factura, marginLeft, marginRight, pageWidth, colors, yPos);

            // ===== RODAP√â PROFISSIONAL CORRIGIDO =====
            criarRodapeProfissional(doc, pageWidth, colors, yPos);

            // ===== CARIMBO DE VALIDA√á√ÉO =====
            criarCarimboValidacao(doc, pageWidth, colors);

            const fileName = `Factura_${factura.numero.replace(/[^a-zA-Z0-9]/g, '_')}_AGETRHA.pdf`;
            doc.save(fileName);
            console.log('‚úÖ Factura gerada com design profissional:', fileName);
        }

        // ===== FUN√á√ÉO AUXILIAR PARA QUEBRAR TEXTO =====
        function quebrarTexto(texto, maxLength) {
            const palavras = texto.split(' ');
            const linhas = [];
            let linhaAtual = '';

            palavras.forEach(palavra => {
                if ((linhaAtual + ' ' + palavra).length <= maxLength) {
                    linhaAtual += (linhaAtual ? ' ' : '') + palavra;
                } else {
                    if (linhaAtual) linhas.push(linhaAtual);
                    linhaAtual = palavra;
                }
            });

            if (linhaAtual) linhas.push(linhaAtual);
            return linhas;
        }

        // ===== SE√á√ÉO DE INFORMA√á√ïES CORRIGIDA =====
        function criarSecaoInformacoes(doc, factura, marginLeft, marginRight, pageWidth, colors, yPos) {
            const colWidth = (pageWidth - marginLeft - marginRight) / 2 - 10;

            // Fundo para informa√ß√µes da AGETRHA
            doc.setFillColor(...colors.lightGray);
            doc.roundedRect(marginLeft, yPos, colWidth, 45, 3, 3, 'F');
            doc.setDrawColor(...colors.mediumGray);
            doc.roundedRect(marginLeft, yPos, colWidth, 45, 3, 3);

            // T√≠tulo da se√ß√£o
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(...colors.primaryDark);
            doc.text('EMITENTE', marginLeft + 10, yPos + 8);

            // Informa√ß√µes da AGETRHA
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(...colors.darkGray);
            doc.text('AGETRHA - Associa√ß√£o', marginLeft + 10, yPos + 15);
            doc.text('de Gestores de T√©cnicos,', marginLeft + 10, yPos + 20);
            doc.text('de Recursos Humanos de Angola', marginLeft + 10, yPos + 25);
            doc.text('Departamento de', marginLeft + 10, yPos + 30);
            doc.text('Planejamento e Finan√ßas', marginLeft + 10, yPos + 35);
            doc.text('Luanda, Angola', marginLeft + 10, yPos + 40);

            // Fundo para informa√ß√µes do cliente
            doc.setFillColor(...colors.lightGray);
            doc.roundedRect(marginLeft + colWidth + 20, yPos, colWidth, 45, 3, 3, 'F');
            doc.setDrawColor(...colors.mediumGray);
            doc.roundedRect(marginLeft + colWidth + 20, yPos, colWidth, 45, 3, 3);

            // T√≠tulo da se√ß√£o
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(...colors.primaryDark);
            doc.text('ASSOCIADO', marginLeft + colWidth + 30, yPos + 8);

            // Informa√ß√µes do cliente COM TRATAMENTO DE TEXTO LONGO
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(...colors.darkGray);

            // Tratar nome do associado (quebrar se for muito longo)
            const nomeLinhas = quebrarTexto(factura.cliente.toUpperCase(), 25);
            let textoY = yPos + 15;

            nomeLinhas.forEach(linha => {
                doc.text(linha, marginLeft + colWidth + 30, textoY);
                textoY += 5;
            });

            // Ajustar Y para pr√≥ximas informa√ß√µes
            let infoY = textoY > (yPos + 15) ? textoY : yPos + 15;

            if (factura.numeroMembro) {
                doc.text(`N¬∫ Membro: ${factura.numeroMembro}`, marginLeft + colWidth + 30, infoY);
                infoY += 5;
            }

            if (factura.funcao) {
                const funcaoLinhas = quebrarTexto(factura.funcao, 25);
                doc.text('Fun√ß√£o:', marginLeft + colWidth + 30, infoY);
                infoY += 5;
                funcaoLinhas.forEach(linha => {
                    doc.text(linha, marginLeft + colWidth + 35, infoY);
                    infoY += 5;
                });
            }

            if (factura.categoria) {
                doc.text(`Categoria: ${factura.categoria}`, marginLeft + colWidth + 30, infoY);
                infoY += 5;
            }

            if (factura.periodo) {
                doc.text(`Per√≠odo: ${formatarPeriodoParaFactura(factura.periodo)}`, marginLeft + colWidth + 30, infoY);
            }

            // Retornar posi√ß√£o Y para continuar
            return Math.max(yPos + 55, infoY + 10);
        }

        // ===== TABELA DE ITENS PROFISSIONAL COM ALINHAMENTO CORRIGIDO =====
        function criarTabelaItensProfissional(doc, factura, marginLeft, marginRight, pageWidth, colors, yPos) {
            const startX = marginLeft;
            const tabelaLargura = pageWidth - marginLeft - marginRight;

            // Definir larguras das colunas - AUMENTEI as larguras para UNIT√ÅRIO e TOTAL
            const colWidths = {
                descricao: 80,           // Reduzi um pouco para dar mais espa√ßo √†s outras colunas
                quantidade: 25,
                unitario: 40,            // AUMENTADO de 30 para 40
                total: 45                // AUMENTADO de 30 para 45
            };

            // Ajustar largura da descri√ß√£o para ocupar espa√ßo restante
            colWidths.descricao = tabelaLargura - colWidths.quantidade - colWidths.unitario - colWidths.total;

            // Cabe√ßalho da tabela com fundo azul
            doc.setFillColor(...colors.primaryLight);
            doc.roundedRect(startX, yPos, tabelaLargura, 10, 2, 2, 'F');

            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(...colors.white);

            // Cabe√ßalhos das colunas COM POSI√á√ïES CORRETAS E MAIS √Ä DIREITA
            // DESCRI√á√ÉO
            doc.text('DESCRI√á√ÉO', startX + 5, yPos + 7);

            // QUANT. - centralizada
            const quantX = startX + colWidths.descricao + (colWidths.quantidade / 2);
            doc.text('QUANT.', quantX, yPos + 7, { align: 'center' });

            // UNIT√ÅRIO - alinhado √† direita e mais para a direita
            const unitarioX = startX + colWidths.descricao + colWidths.quantidade + colWidths.unitario - 8;
            doc.text('UNIT√ÅRIO', unitarioX, yPos + 7, { align: 'right' });

            // TOTAL - alinhado √† direita e mais para a direita
            const totalX = startX + colWidths.descricao + colWidths.quantidade + colWidths.unitario + colWidths.total - 8;
            doc.text('TOTAL', totalX, yPos + 7, { align: 'right' });

            yPos += 10;

            // Linha de itens
            const items = [
                {
                    descricao: `Quota ${factura.categoria || ''}`.trim(),
                    quantidade: 1,
                    unitario: parseFloat(factura.quota || factura.valor || 0),
                    total: parseFloat(factura.quota || factura.valor || 0)
                }
            ];

            // Adicionar multa se houver
            if (factura.multa && parseFloat(factura.multa) > 0) {
                items.push({
                    descricao: 'Multa por atraso',
                    quantidade: 1,
                    unitario: parseFloat(factura.multa),
                    total: parseFloat(factura.multa)
                });
            }

            // Adicionar joia se houver
            if (factura.joia && parseFloat(factura.joia) > 0) {
                items.push({
                    descricao: 'Joia de Inscri√ß√£o',
                    quantidade: 1,
                    unitario: parseFloat(factura.joia),
                    total: parseFloat(factura.joia)
                });
            }

            // Desenhar itens COM ALINHAMENTO CORRETO E MAIS √Ä DIREITA
            items.forEach((item, index) => {
                const bgColor = index % 2 === 0 ? colors.white : colors.lightGray;

                doc.setFillColor(...bgColor);
                doc.rect(startX, yPos, tabelaLargura, 8, 'F');

                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(...colors.darkGray);

                // Descri√ß√£o (com quebra de linha se necess√°rio)
                const descricaoLinhas = quebrarTexto(item.descricao, 25);
                if (descricaoLinhas.length > 1) {
                    descricaoLinhas.forEach((linha, i) => {
                        doc.text(linha, startX + 5, yPos + 5 + (i * 4));
                    });
                } else {
                    doc.text(item.descricao, startX + 5, yPos + 5);
                }

                // Quantidade (centralizada)
                doc.text(item.quantidade.toString(),
                    quantX,
                    yPos + 5,
                    { align: 'center' });

                // Unit√°rio (alinhado √† direita e mais para a direita)
                doc.text(formatarValorParaTabela(item.unitario),
                    unitarioX,
                    yPos + 5,
                    { align: 'right' });

                // Total (alinhado √† direita e mais para a direita)
                doc.text(formatarValorParaTabela(item.total),
                    totalX,
                    yPos + 5,
                    { align: 'right' });

                yPos += 8;
            });

            // Linha divis√≥ria
            doc.setDrawColor(...colors.mediumGray);
            doc.setLineWidth(0.5);
            doc.line(startX, yPos, pageWidth - marginRight, yPos);

            return yPos + 5;
        }

        // ===== RODAP√â PROFISSIONAL CORRIGIDO (SEM S√çMBOLOS ESTRANHOS) =====
        function criarRodapeProfissional(doc, pageWidth, colors, yPos) {
            const footerY = 270;

            // Linha divis√≥ria
            doc.setDrawColor(...colors.primaryLight);
            doc.setLineWidth(0.5);
            doc.line(20, footerY, pageWidth - 20, footerY);

            // Informa√ß√µes de contacto SEM EMOJIS (usando texto simples)
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(...colors.mediumGray);

            const contactos = [
                'Telefone: +244 925 968 772 - 955 763 141 | Email: agetrha@gmail.com',
                'IBAN: AO0 0040.0000.9992.2646.1017.9 | Localizacao: Luanda, Angola',
                'Horario de atendimento: Segunda a Sexta, 08:00-18:00'
            ];

            contactos.forEach((texto, index) => {
                doc.text(texto, pageWidth / 2, footerY + 5 + (index * 4), { align: 'center' });
            });

            // Nota importante
            doc.setFont('helvetica', 'italic');
            doc.text('Esta factura e gerada automaticamente pelo Sistema de Gestao Financeira AGETRHA',
                pageWidth / 2, footerY + 20, { align: 'center' });
        }

        // Fun√ß√£o auxiliar para quebrar texto se splitTextToSize n√£o existir
        function splitTextToSize(text, maxWidth, doc) {
            if (typeof doc.splitTextToSize === 'function') {
                return doc.splitTextToSize(text, maxWidth);
            }

            // Implementa√ß√£o simples se n√£o existir
            const words = text.split(' ');
            const lines = [];
            let currentLine = '';

            for (let i = 0; i < words.length; i++) {
                const word = words[i];
                const testLine = currentLine ? `${currentLine} ${word}` : word;
                const testWidth = doc.getTextWidth(testLine);

                if (testWidth <= maxWidth) {
                    currentLine = testLine;
                } else {
                    if (currentLine) lines.push(currentLine);
                    currentLine = word;
                }
            }

            if (currentLine) lines.push(currentLine);
            return lines;
        }

        // ===== CABE√áALHO PROFISSIONAL =====
        function criarCabecalhoProfissional(doc, factura, pageWidth, colors, yPos) {
            const marginLeft = 15; // Margem esquerda uniforme
            const marginRight = 15; // Margem direita uniforme

            // Fundo degrad√™ azul (reduzido para 50px para acomodar melhor)
            doc.setFillColor(...colors.primaryDark);
            doc.rect(0, 0, pageWidth, 50, 'F');

            // Linha decorativa azul claro (mantida mas mais baixa)
            doc.setDrawColor(...colors.primaryLight);
            doc.setLineWidth(2);
            doc.line(0, 48, pageWidth, 48);

            // ADI√á√ÉO DO LOGOTIPO - mesma imagem do cabe√ßalho do sistema
            const logoUrl = 'https://i.postimg.cc/DyKZTbYq/Logotipo.jpg';

            // Configura√ß√µes do logo - MOVIDO MAIS PARA A ESQUERDA
            const logoSize = 35; // Reduzido um pouco
            const logoX = marginLeft; // Usando a margem esquerda
            const logoY = 7; // Ajustado para cima

            try {

                // 1. Quadrado branco com cantos curvos
                doc.setFillColor(255, 255, 255); // Branco
                doc.setDrawColor(255, 255, 255); // Borda branca

                // Desenhar quadrado com cantos curvos
                const borderRadius = 6; // Raio dos cantos

                if (typeof doc.roundedRect === 'function') {
                    // Se a fun√ß√£o existir, use-a
                    doc.roundedRect(logoX, logoY, logoSize, logoSize, borderRadius, borderRadius, 'F');
                } else {
                    // Se n√£o existir, use ret√¢ngulo normal
                    doc.rect(logoX, logoY, logoSize, logoSize, 'F');
                }

                // 2. Logotipo dentro do quadrado
                const margin = 4;
                doc.addImage(logoUrl, 'JPEG',
                    logoX + margin,
                    logoY + margin,
                    logoSize - (margin * 2),
                    logoSize - (margin * 2)
                );

                // 3. Textos √† direita do logo
                const textX = logoX + logoSize + 8;

                // Texto AGETRHA
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...colors.white);
                doc.text('AGETRHA', textX, 17);

                // Subt√≠tulo - com quebra de linha autom√°tica
                doc.setFontSize(8); // Reduzido de 9 para 8
                doc.setFont('helvetica', 'normal');

                const subtitulo = 'Associa√ß√£o de Gestores e T√©cnicos de Recursos Humanos de Angola';
                const maxWidth = 120; // Largura m√°xima para n√£o sobrepor dados da factura

                // Dividir o subt√≠tulo em linhas
                const lines = splitTextToSize(subtitulo, maxWidth, doc);
                let lineY = 22; // Posi√ß√£o inicial

                lines.forEach((line, index) => {
                    if (index < 2) { // Limitar a 2 linhas
                        doc.text(line, textX, lineY + (index * 5));
                    }
                });

            } catch (error) {
                console.log('‚ö†Ô∏è Usando fallback de texto (logotipo n√£o carregado)', error);
                // Fallback simplificado
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...colors.white);
                doc.text('AGETRHA', marginLeft, 17);
            }

            // Informa√ß√µes da factura √† DIREITA (n√£o sobrepostas)
            const infoX = pageWidth - marginRight;

            // "FACTURA" - menor e mais √† direita
            doc.setFontSize(14); // Reduzido de 18
            doc.setFont('helvetica', 'bold');
            doc.text('FACTURA', infoX, 17, { align: 'right' });

            // N√∫mero da factura
            doc.setFontSize(10); // Reduzido de 12
            doc.text(`N¬∫ ${factura.numero}`, infoX, 23, { align: 'right' });

            // Data - em linha separada
            doc.setFontSize(9); // Reduzido de 10
            doc.setFont('helvetica', 'normal');
            doc.text(`Data: ${formatarDataParaFactura(factura.data)}`, infoX, 29, { align: 'right' });

            // Linha divis√≥ria - ABAIXO do cabe√ßalho e do logo
            const barraY = 42; // Posicionada ABAIXO do logo (logoY + logoSize + margem)
            doc.setDrawColor(...colors.mediumGray);
            doc.setLineWidth(0.5);
            doc.line(marginLeft, barraY, pageWidth - marginRight, barraY);

            return barraY + 15; // Retorna posi√ß√£o para pr√≥ximo conte√∫do
        }

        // ===== RESUMO FINANCEIRO =====
        function criarResumoFinanceiro(doc, factura, marginLeft, marginRight, pageWidth, colors, yPos) {
            const startX = pageWidth - marginRight - 100;
            const width = 100;

            // Cabe√ßalho do resumo
            doc.setFillColor(...colors.primaryDark);
            doc.roundedRect(startX, yPos, width, 8, 2, 2, 'F');

            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(...colors.white);
            doc.text('RESUMO FINANCEIRO', startX + width / 2, yPos + 5, { align: 'center' });

            yPos += 10;

            // Calcular totais
            const subtotal = parseFloat(factura.quota || factura.valor || 0);
            const multa = parseFloat(factura.multa || 0);
            const joia = parseFloat(factura.joia || 0);
            const total = subtotal + multa + joia;

            // Linhas do resumo
            const linhas = [
                { label: 'Subtotal:', valor: subtotal },
                { label: 'Multa:', valor: multa },
                { label: 'Joia:', valor: joia }
            ];

            // Desenhar linhas
            linhas.forEach((linha, index) => {
                if (linha.valor > 0) {
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(...colors.darkGray);

                    doc.text(linha.label, startX + 5, yPos + 5);
                    doc.text(formatarValorParaTabela(linha.valor), startX + width - 5, yPos + 5, { align: 'right' });

                    yPos += 7;
                }
            });

            // Linha divis√≥ria antes do total
            doc.setDrawColor(...colors.mediumGray);
            doc.setLineWidth(0.5);
            doc.line(startX, yPos, startX + width, yPos);
            yPos += 5;

            // Total em destaque
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(...colors.white);
            doc.setFillColor(...colors.secondary);
            doc.roundedRect(startX, yPos, width, 10, 2, 2, 'F');

            doc.text('TOTAL A PAGAR:', startX + 5, yPos + 7);
            doc.text(formatarValorParaTabela(total) + ' Kz', startX + width - 5, yPos + 7, { align: 'right' });

            yPos += 15;

            // Estado da factura
            let estadoCor, estadoTexto;
            switch (factura.estado.toLowerCase()) {
                case 'pago':
                    estadoCor = colors.secondary;
                    estadoTexto = 'PAGO';
                    break;
                case 'pendente':
                    estadoCor = colors.accent;
                    estadoTexto = 'PENDENTE';
                    break;
                case 'cancelado':
                    estadoCor = [220, 53, 69]; // Vermelho
                    estadoTexto = 'CANCELADO';
                    break;
                default:
                    estadoCor = colors.mediumGray;
                    estadoTexto = factura.estado.toUpperCase();
            }

            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(...estadoCor);
            doc.text(`ESTADO: ${estadoTexto}`, startX + width / 2, yPos, { align: 'center' });

            return yPos + 10;
        }

        // ===== CARIMBO DE VALIDA√á√ÉO =====
        function criarCarimboValidacao(doc, pageWidth, colors) {
            doc.setFontSize(7);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(...colors.mediumGray);

            const timestamp = new Date().toLocaleString('pt-AO', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });

            doc.text(`Documento valido | Emitido em: ${timestamp}`,
                pageWidth - 10, 285, { align: 'right' });

            // C√≥digo de valida√ß√£o (simulado)
            const validationCode = `VLD-${Date.now().toString().slice(-8)}`;
            doc.text(`Codigo: ${validationCode}`, 10, 285);
        }

        // ===== FUN√á√ïES AUXILIARES PARA FORMATA√á√ÉO =====
        function formatarValorParaTabela(valor) {
            const num = parseFloat(valor || 0);
            if (isNaN(num)) return "0,00";
            return num.toFixed(2).replace('.', ',');
        }

        function formatarDataParaFactura(dataString) {
            if (!dataString) return '';
            const data = parsearDataPortugues(dataString);
            if (isNaN(data.getTime())) return dataString;

            return data.toLocaleDateString('pt-AO', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        function formatarPeriodoParaFactura(periodo) {
            if (!periodo) return '';

            try {
                if (periodo.includes('-')) {
                    const [ano, mes] = periodo.split('-');
                    const meses = [
                        'Janeiro', 'Fevereiro', 'Marco', 'Abril', 'Maio', 'Junho',
                        'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
                    ];
                    return `${meses[parseInt(mes) - 1]} de ${ano}`;
                }
                return periodo;
            } catch (error) {
                return periodo;
            }
        }

        // ===== FUN√á√ÉO PARA GARANTIR STRING =====
        function garantirString(valor) {
            if (valor === null || valor === undefined) {
                return '';
            }
            return String(valor);
        }

                                
        // ===== FUN√á√ÉO PARA FORMATAR VALORES =====
        function formatarValorParaTabela(valor) {
            const num = parseFloat(valor || 0);
            if (isNaN(num)) return "0,00";
            return String(num.toFixed(2).replace('.', ','));
        }


        // ===== FUN√á√ïES AUXILIARES =====
        function formatarPeriodoParaFactura(periodo) {
            if (!periodo) return '';

            try {
                if (periodo.includes('T')) {
                    const data = new Date(periodo);
                    if (!isNaN(data.getTime())) {
                        const mes = data.getMonth() + 1;
                        const ano = data.getFullYear();
                        return `${mes.toString().padStart(2, '0')}/${ano}`;
                    }
                }
                return periodo;
            } catch (error) {
                return periodo;
            }
        }

        function formatarValorNumerico(valor) {
            const num = parseFloat(valor || 0);
            if (isNaN(num)) return '0,00 Kz';

            // Formata com separadores de milhares e 2 casas decimais
            return num.toLocaleString('pt-AO', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }) + ' Kz';
        }

        // ===== FUN√á√ÉO PARA FORMATAR DATA =====
        function formatarDataParaFactura(dataString) {
            if (!dataString) return '';
            const data = parsearDataPortugues(dataString);
            if (isNaN(data.getTime())) return dataString;

            const dia = String(data.getDate()).padStart(2, '0');
            const mes = String(data.getMonth() + 1).padStart(2, '0');
            const ano = data.getFullYear();

            return `${dia}/${mes}/${ano}`;
        }

        

        // Fun√ß√£o auxiliar para formatar valores (sem "Kz")
        function formatarValorNumerico(valor) {
            return new Intl.NumberFormat('pt-AO', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(parseFloat(valor || 0));
        }

        // ===== FUN√á√ïES PARA CONTROLO DE PAGAMENTOS =====
        function loadPresidentPhoto() {
            const img = document.getElementById('presidentPhoto');
            if (!img) return;

            img.src = 'https://drive.google.com/thumbnail?id=1YsOaQewTX-_-K2fZGdF7omP8L68jvsNP&sz=w400';

            img.onerror = function () {
                this.src = '';
                this.classList.add('photo-placeholder');
            };

            img.onload = function () {
                this.classList.remove('photo-placeholder');
            };
        }

        function carregarCategoriasFiltro() {
            const selectCategoria = document.getElementById('filter-categoria');

            while (selectCategoria.children.length > 1) {
                selectCategoria.removeChild(selectCategoria.lastChild);
            }

            const categoriasUnicas = [...new Set(membros.map(m => m.categoria).filter(Boolean))].sort();
            categoriasUnicas.forEach(categoria => {
                const option = document.createElement('option');
                option.value = categoria;
                option.textContent = categoria;
                selectCategoria.appendChild(option);
            });
        }

        async function sincronizarComSheets() {
            try {
                mostrarLoading('Sincronizando com a planilha...');

                const timestamp = new Date().getTime();
                const response = await fetch(`${SCRIPT_URL}?action=getMembers&t=${timestamp}`);

                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }

                const result = await response.json();
                console.log('Dados recebidos da planilha:', result);

                if (result.success && result.members) {
                    membros = result.members.map((membro, index) => {
                        let status = membro.status || 'Regular';
                        if (status === 'Dvida') {
                            status = 'D√≠vida';
                        }

                        return {
                            id: index + 1,
                            nome: membro.nome || '',
                            categoria: membro.categoria || '',
                            dataAdmissao: membro.dataAdmissao || '',
                            numeroMembro: membro.numeroMembro || '',
                            status: status,
                            ultimoPagamento: membro.ultimoPagamento || '',
                            bi: membro.bi || '',
                            telefone: membro.telefone || '',
                            email: membro.email || '',
                            empresa: membro.empresa || '',
                            cargo: membro.cargo || '',
                            endereco: membro.endereco || '',
                            dataNascimento: membro.dataNascimento || '',
                            nacionalidade: membro.nacionalidade || ''
                        };
                    });

                    localStorage.setItem('membros', JSON.stringify(membros));
                    console.log(`${membros.length} membros sincronizados com a planilha`);

                    carregarCategoriasFiltro();
                    carregarTabelaMembros();

                    mostrarSucesso('Dados sincronizados com sucesso!');
                } else {
                    console.warn('Nenhum membro encontrado na planilha');
                    mostrarInfo('Nenhum dado novo encontrado na planilha');
                }
            } catch (error) {
                console.error('Erro na sincroniza√ß√£o:', error);
                mostrarErro('Erro ao sincronizar com a planilha: ' + error.message);
                // Carregar dados do localStorage como fallback
                carregarTabelaMembros();
            } finally {
                esconderLoading();
            }
        }

        function carregarTabelaMembros() {
            const tbody = document.getElementById('corpo-tabela-membros');
            if (!tbody) return;

            tbody.innerHTML = '';

            let membrosFiltrados = [...membros];

            if (currentFilters.categoria) {
                membrosFiltrados = membrosFiltrados.filter(m => m.categoria === currentFilters.categoria);
            }

            if (currentFilters.status) {
                membrosFiltrados = membrosFiltrados.filter(m => m.status === currentFilters.status);
            }

            if (currentFilters.nome) {
                const termoBusca = currentFilters.nome.toLowerCase();
                membrosFiltrados = membrosFiltrados.filter(m =>
                    m.nome.toLowerCase().includes(termoBusca)
                );
            }

            if (membrosFiltrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Nenhum membro encontrado</td></tr>';
            } else {
                membrosFiltrados.forEach(membro => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${membro.nome}</td>
                        <td>${membro.categoria}</td>
                        <td>${formatarData(membro.dataAdmissao)}</td>
                        <td>${membro.numeroMembro}</td>
                        <td><span class="status ${membro.status.toLowerCase().replace('√≠', 'i').replace(' ', '-')}">${membro.status}</span></td>
                        <td class="action-buttons">
                            <button class="action-btn view" onclick="verMembro(${membro.id})"><i class="fas fa-eye"></i></button>
                            <button class="action-btn edit" onclick="editarMembroModal(${membro.id})"><i class="fas fa-edit"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }

        function editarMembroModal(id) {
            const membro = membros.find(m => m.id === id);
            if (membro) {
                document.getElementById('membro-id').value = membro.id;
                document.getElementById('nome').value = membro.nome;
                document.getElementById('numero-membro').value = membro.numeroMembro;
                document.getElementById('categoria').value = membro.categoria;
                document.getElementById('telefone').value = membro.telefone;
                document.getElementById('status').value = membro.status;

                if (membro.status === 'D√≠vida') {
                    document.getElementById('btn-em-divida').style.display = 'inline-block';
                    document.getElementById('info-pagamento').innerHTML = '<i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i> Este membro est√° em d√≠vida';
                } else {
                    document.getElementById('btn-em-divida').style.display = 'none';
                    document.getElementById('info-pagamento').innerHTML = '<i class="fas fa-check" style="color: var(--success);"></i> Pagamento em dia';
                }

                document.getElementById('modal-membro').style.display = 'flex';
            }
        }

        function fecharModalMembro() {
            document.getElementById('modal-membro').style.display = 'none';
            document.getElementById('modal-ver-membro').style.display = 'none';
        }

        async function salvarMembro() {
            const id = document.getElementById('membro-id').value;
            const status = document.getElementById('status').value;

            const membro = membros.find(m => m.id == id);
            if (membro) {
                const statusAntigo = membro.status; // Guardar o status antigo
                membro.status = status;

                // Atualizar no localStorage
                localStorage.setItem('membros', JSON.stringify(membros));

                // ATUALIZAR NA PLANILHA DO GOOGLE SHEETS
                try {
                    mostrarLoading('Atualizando status na planilha...');

                    // Enviar atualiza√ß√£o para o GAS
                    const resultado = await atualizarStatusMembroAPI(membro.numeroMembro, status);

                    if (resultado.success) {
                        mostrarSucesso('Membro atualizado com sucesso na planilha!');
                    } else {
                        mostrarErro('Erro ao atualizar na planilha: ' + resultado.message);
                        // Mesmo com erro, continuamos para atualizar a interface local
                    }
                } catch (error) {
                    console.error('Erro ao atualizar planilha:', error);
                    mostrarErro('Erro ao atualizar na planilha, mas altera√ß√£o local foi salva.');
                } finally {
                    esconderLoading();
                }

                // Adicionar notifica√ß√£o para mudan√ßa de status
                if (statusAntigo !== status) {
                    adicionarNotificacao(
                        'Status do Membro Alterado',
                        `${membro.nome} mudou de "${statusAntigo}" para "${status}"`,
                        status === 'Regular' ? 'sucesso' :
                            status === 'D√≠vida' ? 'erro' : 'alerta'
                    );
                }

                carregarTabelaMembros();
                fecharModalMembro();
            }
        }

        async function marcarPagamento() {
    const id = document.getElementById('membro-id').value;
    const membro = membros.find(m => m.id == id);

    if (membro) {
        // Guardar status anterior
        const statusAnterior = membro.status;
        
        // Mudar status para "Regular"
        membro.status = 'Regular';
        membro.ultimoPagamento = new Date().toISOString().split('T')[0];

        try {
            mostrarLoading('Registrando pagamento...');
            
            // USAR A MESMA API DO BOT√ÉO "SALVAR"
            const resultado = await atualizarStatusMembroAPI(membro.numeroMembro, membro.status);
            
            if (resultado.success) {
                // Atualizar localStorage
                localStorage.setItem('membros', JSON.stringify(membros));
                
                // Atualizar tabela
                carregarTabelaMembros();
                
                // Fechar modal
                fecharModalMembro();
                
                // Mostrar mensagem de sucesso
                mostrarSucesso('Pagamento registrado com sucesso! Status alterado para Regular.');
            } else {
                // Reverter se falhar
                membro.status = statusAnterior;
                delete membro.ultimoPagamento;
                mostrarErro('Erro ao registrar pagamento na planilha');
            }
        } catch (error) {
            // Reverter se falhar
            membro.status = statusAnterior;
            delete membro.ultimoPagamento;
            mostrarErro('Erro ao registrar pagamento');
        } finally {
            esconderLoading();
        }
    }
}

        function verMembro(id) {
            const membro = membros.find(m => m.id === id);
            if (membro) {
                const modalCorpo = document.getElementById('modal-ver-corpo');
                modalCorpo.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label><strong>Nome Completo</strong></label>
                            <div>${membro.nome || 'N√£o informado'}</div>
                        </div>
                        <div class="form-group">
                            <label><strong>N√∫mero de Membro</strong></label>
                            <div>${membro.numeroMembro || 'N√£o informado'}</div>
                        </div>
                        <div class="form-group">
                            <label><strong>Categoria</strong></label>
                            <div>${membro.categoria || 'N√£o informado'}</div>
                        </div>
                        <div class="form-group">
                            <label><strong>Status</strong></label>
                            <div><span class="status ${membro.status.toLowerCase().replace('√≠', 'i').replace(' ', '-')}">${membro.status}</span></div>
                        </div>
                        <div class="form-group">
                            <label><strong>Data de Admiss√£o</strong></label>
                            <div>${formatarData(membro.dataAdmissao) || 'N√£o informado'}</div>
                        </div>
                        <div class="form-group">
                            <label><strong>BI/Passaporte</strong></label>
                            <div>${membro.bi || 'N√£o informado'}</div>
                        </div>
                        <div class="form-group">
                            <label><strong>Telefone</strong></label>
                            <div>${membro.telefone || 'N√£o informado'}</div>
                        </div>
                        <div class="form-group">
                            <label><strong>E-mail</strong></label>
                            <div>${membro.email || 'N√£o informado'}</div>
                        </div>
                        <div class="form-group">
                            <label><strong>Empresa/Institui√ß√£o</strong></label>
                            <div>${membro.empresa || 'N√£o informado'}</div>
                        </div>
                        <div class="form-group">
                            <label><strong>Cargo/Fun√ß√£o</strong></label>
                            <div>${membro.cargo || 'N√£o informado'}</div>
                        </div>
                        <div class="form-group">
                            <label><strong>Endere√ßo</strong></label>
                            <div>${membro.endereco || 'N√£o informado'}</div>
                        </div>
                        <div class="form-group">
                            <label><strong>Data de Nascimento</strong></label>
                            <div>${formatarData(membro.dataNascimento) || 'N√£o informado'}</div>
                        </div>
                        <div class="form-group">
                            <label><strong>Nacionalidade</strong></label>
                            <div>${membro.nacionalidade || 'N√£o informado'}</div>
                        </div>
                        <div class="form-group">
                            <label><strong>√öltimo Pagamento</strong></label>
                            <div>${formatarData(membro.ultimoPagamento) || 'N√£o registrado'}</div>
                        </div>
                    </div>
                `;

                document.getElementById('modal-ver-membro').style.display = 'flex';
            }
        }

        function inicializarPaginaGestaoMembros() {
            console.log('üöÄ Inicializando p√°gina de gest√£o de membros...');
            loadPresidentPhoto();
            carregarCategoriasFiltro();
            sincronizarComSheets();
        }

        // ===== FUN√á√ïES AUXILIARES =====
        function carregarListaAssociados() {
            const listaAssociados = [
                { nome: 'Jo√£o Silva', numeroMembro: 'MEM001', funcao: 'Associado' },
                { nome: 'Maria Santos', numeroMembro: 'MEM002', funcao: 'Associado' },
                { nome: 'Carlos Oliveira', numeroMembro: 'MEM003', funcao: 'Coordenador' },
                { nome: 'Ana Pereira', numeroMembro: 'MEM004', funcao: 'Associado' },
                { nome: 'Pedro Costa', numeroMembro: 'MEM005', funcao: 'Tesoureiro' }
            ];

            const datalist = document.getElementById('lista-associados');
            datalist.innerHTML = '';

            listaAssociados.forEach(associado => {
                const option = document.createElement('option');
                option.value = associado.nome;
                option.setAttribute('data-numero', associado.numeroMembro);
                option.setAttribute('data-funcao', associado.funcao);
                datalist.appendChild(option);
            });
        }

        function atualizarTotalFactura() {
            const quota = parseFloat(document.getElementById('factura-quota').value) || 0;
            const multa = parseFloat(document.getElementById('factura-multa').value) || 0;
            const joia = parseFloat(document.getElementById('factura-joia').value) || 0;

            const total = quota + multa + joia;
            document.getElementById('factura-total').textContent = formatarValor(total);
        }

        // ===== FUN√á√ÉO PARA CONFIGURAR AUTOCOMPLETE COM DADOS DOS MEMBROS =====
        function configurarAutocompleteAssociado() {
            const clienteInput = document.getElementById('factura-cliente');

            if (!clienteInput) {
                console.error('‚ùå Campo factura-cliente n√£o encontrado');
                return;
            }

            clienteInput.addEventListener('input', function () {
                const nome = this.value.trim();

                if (!nome) {
                    // Limpar campos se o nome estiver vazio
                    document.getElementById('factura-numero-membro').value = '';
                    document.getElementById('factura-funcao').value = '';
                    return;
                }

                // Procurar o membro na lista completa
                const associado = listaMembrosCompleta.find(m =>
                    m.nome.toLowerCase() === nome.toLowerCase()
                );

                if (associado) {
                    // Preencher automaticamente os campos
                    document.getElementById('factura-numero-membro').value = associado.numeroMembro || '';
                    document.getElementById('factura-funcao').value = associado.cargo || 'Associado';

                    // Se quiser preencher mais campos automaticamente:
                    // document.getElementById('factura-categoria').value = associado.categoria || 'quotas';

                    console.log(`‚úÖ Associado encontrado: ${associado.nome}, N¬∫: ${associado.numeroMembro}`);
                } else {
                    // Se n√£o encontrar, limpar os campos extras
                    document.getElementById('factura-numero-membro').value = '';
                    document.getElementById('factura-funcao').value = '';
                }
            });

            // Adicionar evento de mudan√ßa para quando selecionar do datalist
            clienteInput.addEventListener('change', function () {
                const nome = this.value;
                const associado = listaMembrosCompleta.find(m => m.nome === nome);

                if (associado) {
                    document.getElementById('factura-numero-membro').value = associado.numeroMembro || '';
                    document.getElementById('factura-funcao').value = associado.cargo || 'Associado';
                }
            });
        }

        // ===== FUN√á√ÉO PARA BUSCAR MEMBRO POR NOME =====
        function buscarMembroPorNome(nome) {
            return listaMembrosCompleta.find(membro =>
                membro.nome.toLowerCase().includes(nome.toLowerCase()) ||
                membro.numeroMembro === nome
            );
        }

        // ===== FUN√á√ÉO PARA SUGERIR MEMBROS =====
        function sugerirMembros(termo) {
            if (!termo || termo.length < 2) return [];

            return listaMembrosCompleta.filter(membro =>
                membro.nome.toLowerCase().includes(termo.toLowerCase()) ||
                membro.numeroMembro.includes(termo) ||
                (membro.cargo && membro.cargo.toLowerCase().includes(termo.toLowerCase()))
            ).slice(0, 10); // Limitar a 10 sugest√µes
        }

            // ===== FUN√á√ÉO DE DEBUG =====
            function logEstadoDados() {
                console.log('üìä ESTADO DOS DADOS:');
                console.log('- Transa√ß√µes carregadas:', dadosCarregados.transacoes, `(${transacoes.length} registros)`);
                console.log('- Facturas carregadas:', dadosCarregados.facturas, `(${facturas.length} registros)`);
                console.log('- Relat√≥rios carregadas:', dadosCarregados.relatorios, `(${relatorios.length} registros)`);
                console.log('- Or√ßamento carregado:', dadosCarregados.orcamento, `(${orcamento.length} registros)`);
                console.log('- Dashboard carregado:', dadosCarregados.dashboard);
                console.log('- Gr√°ficos inicializados:', chartsInicializados);
            }

        

        

        // ===== FUN√á√ÉO PARA ATUALIZAR GR√ÅFICOS DE OR√áAMENTO =====
        function atualizarGraficosOrcamentoComDadosReais() {
            if (!window.execucaoOrcamentoChart || !window.comparacaoOrcamentoChart) return;

            console.log('üîÑ Atualizando gr√°ficos de or√ßamento com dados reais...');
            console.log('üìä Dados do or√ßamento:', orcamento);

            // 1. Gr√°fico de execu√ß√£o or√ßamental (barras) - mant√©m como est√°
            const categorias = orcamento.map(item => item.natureza);
            const orcamentado = orcamento.map(item => item.orcamentado);
            const realizado = orcamento.map(item => item.realizado || 0);

            window.execucaoOrcamentoChart.data.labels = categorias;
            window.execucaoOrcamentoChart.data.datasets[0].data = orcamentado;
            window.execucaoOrcamentoChart.data.datasets[1].data = realizado;
            window.execucaoOrcamentoChart.update();

            // 2. Gr√°fico de compara√ß√£o (radar) - CORRE√á√ÉO APLICADA AQUI
            // Agrupar dados por natureza para evitar duplicatas
            const dadosAgregados = {};

            orcamento.forEach(item => {
                const categoria = item.natureza || 'Sem nome';
                const orcamentadoVal = parseFloat(item.orcamentado) || 0;
                const realizadoVal = parseFloat(item.realizado) || 0;

                if (!dadosAgregados[categoria]) {
                    dadosAgregados[categoria] = {
                        natureza: categoria,
                        orcamentado: 0,
                        realizado: 0
                    };
                }

                dadosAgregados[categoria].orcamentado += orcamentadoVal;
                dadosAgregados[categoria].realizado += realizadoVal;
            });

            // Converter objeto em array
            const dadosConsolidados = Object.values(dadosAgregados);

            // Extrair categorias √∫nicas e valores
            const categoriasConsolidadas = dadosConsolidados.map(item => item.natureza);
            const valoresOrcamentadoKz = dadosConsolidados.map(item => item.orcamentado);
            const valoresRealizadoKz = dadosConsolidados.map(item => item.realizado);

            console.log('üìà Categorias consolidadas:', categoriasConsolidadas);
            console.log('üí∞ Or√ßamentado (Kz):', valoresOrcamentadoKz);
            console.log('üí∏ Realizado (Kz):', valoresRealizadoKz);

            // Atualizar gr√°fico de radar com valores ABSOLUTOS (Kz), n√£o percentuais
            window.comparacaoOrcamentoChart.data.labels = categoriasConsolidadas;
            window.comparacaoOrcamentoChart.data.datasets[0].data = valoresOrcamentadoKz;
            window.comparacaoOrcamentoChart.data.datasets[1].data = valoresRealizadoKz;
            window.comparacaoOrcamentoChart.update();

            console.log('‚úÖ Gr√°ficos de or√ßamento atualizados com sucesso');
        }



        // ===== FUN√á√ÉO PARA CARREGAR DADOS DO DASHBOARD =====
        async function carregarDadosDashboard(forcarRecarga = false) {

            console.log('üîç DEPURA√á√ÉO: Verificando transa√ß√µes do m√™s atual');
            const hoje = new Date();
            const mesAtual = hoje.getMonth() + 1;
            const anoAtual = hoje.getFullYear();

            transacoes.forEach(t => {
                if (t.data) {
                    const dataTransacao = parsearDataPortugues(t.data);
                    const mesTransacao = dataTransacao.getMonth() + 1;
                    const anoTransacao = dataTransacao.getFullYear();

                    if (mesTransacao === mesAtual && anoTransacao === anoAtual) {
                        console.log(`üìù ${t.id}: ${t.descricao}, ${t.valor}, ${t.tipo}, ${t.status}, Data: ${t.data} (${mesTransacao}/${anoTransacao})`);
                    }
                }
            });
                if (!forcarRecarga && dadosCarregados.dashboard) {
                    console.log('üìä Dados do dashboard j√° carregados');
                    return;
                }

                try {
                    mostrarLoading('Carregando dados do dashboard...');

                    // Garantir que os gr√°ficos est√£o inicializados
                    if (!window.fluxoCaixaChart || !window.categoriasDespesasChart) {
                        console.log('üìä Inicializando gr√°ficos (n√£o encontrados)...');
                        inicializarGraficos();
                        // Dar tempo para inicializa√ß√£o
                        await new Promise(resolve => setTimeout(resolve, 300));
                    }

                    // Carregar todas as transa√ß√µes primeiro
                    if (transacoes.length === 0 || forcarRecarga) {
                        await carregarTransacoes(forcarRecarga);
                    }

                    // Carregar todas as facturas para c√°lculos precisos
                    if (facturas.length === 0 || forcarRecarga) {
                        await carregarFacturas(forcarRecarga);
                    }

                    // Data atual para filtros
                    const hoje = new Date();
                    const mesAtual = hoje.getMonth() + 1; // Janeiro = 1
                    const anoAtual = hoje.getFullYear();

                    console.log(`üìÖ Filtro: M√™s ${mesAtual}, Ano ${anoAtual}`);
                    console.log(`üìä Total transa√ß√µes: ${transacoes.length}`);
                    console.log(`üìä Total facturas: ${facturas.length}`);

                    // 1. Calcular receitas do m√™s (facturas pagas + transa√ß√µes de receita)
                    const facturasMesPagas = facturas.filter(f => {
                        if (!f.data || f.estado !== 'pago') {
                            console.log(`‚ùå Factura ${f.numero}: sem data ou estado n√£o √© pago (${f.estado})`);
                            return false;
                        }

                        const dataFactura = parsearDataPortugues(f.data);
                        const mesFactura = dataFactura.getMonth() + 1;
                        const anoFactura = dataFactura.getFullYear();

                        const corresponde = mesFactura === mesAtual && anoFactura === anoAtual;
                        if (corresponde) {
                            console.log(`‚úÖ Factura ${f.numero}: R$${f.total}, data: ${f.data}`);
                        }
                        return corresponde;
                    });

                    const transacoesReceitaMes = transacoes.filter(t => {
                        if (!t.data || t.tipo !== 'receita' || t.status !== 'pago') {
                            return false;
                        }

                        const dataTransacao = parsearDataPortugues(t.data);
                        const mesTransacao = dataTransacao.getMonth() + 1;
                        const anoTransacao = dataTransacao.getFullYear();

                        return mesTransacao === mesAtual && anoTransacao === anoAtual;
                    });

                    const receitasFacturas = facturasMesPagas.reduce((total, f) => {
                        const valor = parseFloat(f.total || f.valor || 0);
                        return total + valor;
                    }, 0);

                    const receitasTransacoes = transacoesReceitaMes.reduce((total, t) => {
                        const valor = parseFloat(t.valor || 0);
                        return total + valor;
                    }, 0);

                    const receitasMes = receitasFacturas + receitasTransacoes;

                    console.log(`üí∞ Receitas do m√™s: ${receitasMes} (Facturas: ${receitasFacturas}, Transa√ß√µes: ${receitasTransacoes})`);

                    // 2. Calcular despesas do m√™s (transa√ß√µes de despesa)
                    const transacoesDespesaMes = transacoes.filter(t => {
                        if (!t.data || t.tipo !== 'despesa' || t.status !== 'pago') {
                            return false;
                        }

                        const dataTransacao = parsearDataPortugues(t.data);
                        const mesTransacao = dataTransacao.getMonth() + 1;
                        const anoTransacao = dataTransacao.getFullYear();

                        return mesTransacao === mesAtual && anoTransacao === anoAtual;
                    });

                    const despesasMes = transacoesDespesaMes.reduce((total, t) => {
                        const valor = parseFloat(t.valor || 0);
                        return total + valor;
                    }, 0);

                    console.log(`üí∏ Despesas do m√™s: ${despesasMes}`);

                    // 3. Calcular saldo atual (receitas - despesas)
                    const saldoAtual = receitasMes - despesasMes;

                    console.log(`üí≥ Saldo atual: ${saldoAtual}`);

                    // 4. Calcular saldo previsto (considerando facturas pendentes do m√™s)
                    const facturasPendentesMes = facturas.filter(f => {
                        if (!f.data || f.estado !== 'pendente') return false;

                        const dataFactura = parsearDataPortugues(f.data);
                        const mesFactura = dataFactura.getMonth() + 1;
                        const anoFactura = dataFactura.getFullYear();

                        return mesFactura === mesAtual && anoFactura === anoAtual;
                    });

                    const receitasPrevistas = facturasPendentesMes.reduce((total, f) => {
                        const valor = parseFloat(f.total || f.valor || 0);
                        return total + valor;
                    }, 0);

                    const saldoPrevisto = saldoAtual + receitasPrevistas;

                    console.log(`üîÆ Saldo previsto: ${saldoPrevisto} (pendentes: R$${receitasPrevistas})`);

                    // 5. Atualizar elementos da p√°gina COM VALORES REAIS
                    document.getElementById('saldo-atual').textContent = formatarValor(saldoAtual);
                    document.getElementById('receitas-mes').textContent = formatarValor(receitasMes);
                    document.getElementById('despesas-mes').textContent = formatarValor(despesasMes);
                    document.getElementById('saldo-previsto').textContent = formatarValor(saldoPrevisto);

                    // 6. Atualizar barras de progresso com valores reais
                    atualizarBarrasProgressoDashboard({
                        saldoAtual,
                        receitasMes,
                        despesasMes,
                        saldoPrevisto
                    });

                    // 7. Atualizar transa√ß√µes recentes
                    const transacoesRecentes = [...transacoes]
                        .sort((a, b) => new Date(b.data) - new Date(a.data))
                        .slice(0, 5);

                    atualizarTransacoesRecentesDashboard(transacoesRecentes);

                    // 8. Atualizar gr√°ficos com dados reais (√∫ltimos 6 meses)
                    if (window.fluxoCaixaChart) {
                        // Preparar dados dos √∫ltimos 6 meses
                        const ultimos6Meses = [];
                        const receitasPorMes = [];
                        const despesasPorMes = [];

                        const hoje = new Date();
                        for (let i = 5; i >= 0; i--) {
                            const data = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1);
                            const mes = data.getMonth() + 1;
                            const ano = data.getFullYear();
                            const nomeMes = data.toLocaleDateString('pt-PT', { month: 'short' });
                            ultimos6Meses.push(nomeMes.charAt(0).toUpperCase() + nomeMes.slice(1, 3));

                            // Calcular receitas deste m√™s
                            const receitasMes = transacoes.filter(t => {
                                if (!t.data || t.tipo !== 'receita' || t.status !== 'pago') return false;
                                const dataTransacao = parsearDataPortugues(t.data);
                                return dataTransacao.getMonth() + 1 === mes &&
                                    dataTransacao.getFullYear() === ano;
                            }).reduce((total, t) => total + parseFloat(t.valor || 0), 0);

                            // Adicionar receitas de facturas pagas
                            const facturasMes = facturas.filter(f => {
                                if (!f.data || f.estado !== 'pago') return false;
                                const dataFactura = parsearDataPortugues(f.data);
                                return dataFactura.getMonth() + 1 === mes &&
                                    dataFactura.getFullYear() === ano;
                            }).reduce((total, f) => total + parseFloat(f.total || f.valor || 0), 0);

                            receitasPorMes.push(receitasMes + facturasMes);

                            // Calcular despesas deste m√™s
                            const despesasMes = transacoes.filter(t => {
                                if (!t.data || t.tipo !== 'despesa' || t.status !== 'pago') return false;
                                const dataTransacao = parsearDataPortugues(t.data);
                                return dataTransacao.getMonth() + 1 === mes &&
                                    dataTransacao.getFullYear() === ano;
                            }).reduce((total, t) => total + parseFloat(t.valor || 0), 0);

                            despesasPorMes.push(despesasMes);
                        }

                        // Atualizar gr√°fico de fluxo de caixa
                        window.fluxoCaixaChart.data.labels = ultimos6Meses;
                        window.fluxoCaixaChart.data.datasets[0].data = receitasPorMes;
                        window.fluxoCaixaChart.data.datasets[1].data = despesasPorMes;
                        window.fluxoCaixaChart.update();
                    }

                    if (window.categoriasDespesasChart) {
                        // Calcular distribui√ß√£o de despesas por categoria
                        const categoriasMap = {};
                        const hoje = new Date();
                        const mesAtual = hoje.getMonth() + 1;
                        const anoAtual = hoje.getFullYear();

                        // Filtrar despesas do m√™s atual
                        const despesasMesAtual = transacoes.filter(t => {
                            if (!t.data || t.tipo !== 'despesa') return false; // Removido filtro de status

                            try {
                                const dataTransacao = parsearDataPortugues(t.data);
                                if (isNaN(dataTransacao.getTime())) return false;

                                const mesTransacao = dataTransacao.getMonth() + 1;
                                const anoTransacao = dataTransacao.getFullYear();

                                return mesTransacao === mesAtual && anoTransacao === anoAtual;
                            } catch (error) {
                                console.error('Erro ao processar transa√ß√£o para gr√°fico de categorias:', t, error);
                                return false;
                            }

                            console.log(`üìä Despesas do m√™s atual (${mesAtual}/${anoAtual}):`, despesasMesAtual.length, 'registros');
                            despesasMesAtual.forEach(d => {
                                console.log(`  - ${d.descricao}: ${d.valor} (${d.natureza})`);
                            });
                        });

                        // Agrupar por categoria
                        despesasMesAtual.forEach(transacao => {
                            const categoria = transacao.natureza || 'Outros';
                            const valor = parseFloat(transacao.valor || 0);

                            if (!categoriasMap[categoria]) {
                                categoriasMap[categoria] = 0;
                            }
                            categoriasMap[categoria] += valor;
                        });

                        // Preparar dados para o gr√°fico
                        const categorias = Object.keys(categoriasMap);
                        const valores = Object.values(categoriasMap);

                        // Se n√£o houver dados, usar valores padr√£o
                        if (categorias.length === 0) {
                            categorias.push('Infraestrutura', 'Pessoal', 'Eventos', 'Outros');
                            valores.push(120000, 150000, 45000, 10250);
                        }

                        // Atualizar gr√°fico de categorias
                        window.categoriasDespesasChart.data.labels = categorias;
                        window.categoriasDespesasChart.data.datasets[0].data = valores;
                        window.categoriasDespesasChart.update();
                    }

                    dadosCarregados.dashboard = true;

                    console.log('‚úÖ Dashboard atualizado com dados reais:', {

                        saldoAtual,
                        receitasMes,
                        despesasMes,
                        saldoPrevisto
                    });

                    // Atualizar gr√°ficos com dados reais
                    atualizarGraficosComDadosReais();

                } catch (error) {
                    console.error('‚ùå Erro ao carregar dados do dashboard:', error);
                    mostrarErro('Erro ao carregar dados do dashboard: ' + error.message);
                } finally {
                    // Garantir que o loading seja removido
                    esconderLoading();
                }
            }

        // Fun√ß√µes auxiliares para c√°lculos do dashboard
        function calcularEvolucaoMensal(transacoes, facturas, meses) {
            const hoje = new Date();
            const mesesLabels = [];
            const receitasMensais = [];
            const despesasMensais = [];

            for (let i = meses - 1; i >= 0; i--) {
                const data = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1);
                const mes = data.getMonth() + 1;
                const ano = data.getFullYear();

                // Nome do m√™s
                const nomeMes = data.toLocaleString('pt-PT', { month: 'short' });
                mesesLabels.push(nomeMes.charAt(0).toUpperCase() + nomeMes.slice(1, 3));

                // Calcular receitas do m√™s (facturas pagas + transa√ß√µes de receita)
                const facturasMes = facturas.filter(f => {
                    if (!f.data || f.estado !== 'pago') return false;
                    const dataFactura = parsearDataPortugues(f.data);
                    return dataFactura.getMonth() + 1 === mes &&
                        dataFactura.getFullYear() === ano;
                });

                const transacoesReceita = transacoes.filter(t => {
                    if (!t.data || t.tipo !== 'receita' || t.status !== 'pago') return false;
                    const dataTransacao = parsearDataPortugues(t.data);
                    return dataTransacao.getMonth() + 1 === mes &&
                        dataTransacao.getFullYear() === ano;
                });

                const receitas = facturasMes.reduce((total, f) => total + parseFloat(f.total || f.valor || 0), 0) +
                    transacoesReceita.reduce((total, t) => total + parseFloat(t.valor || 0), 0);

                // Calcular despesas do m√™s
                const transacoesDespesa = transacoes.filter(t => {
                    if (!t.data || t.tipo !== 'despesa' || t.status !== 'pago') return false;
                    const dataTransacao = parsearDataPortugues(t.data);
                    return dataTransacao.getMonth() + 1 === mes &&
                        dataTransacao.getFullYear() === ano;
                });

                const despesas = transacoesDespesa.reduce((total, t) => total + parseFloat(t.valor || 0), 0);

                receitasMensais.push(receitas);
                despesasMensais.push(despesas);
            }

            return {
                meses: mesesLabels,
                receitas: receitasMensais,
                despesas: despesasMensais
            };
        }

        function calcularCategoriasDespesas(transacoesDespesa) {
            const categorias = {};

            transacoesDespesa.forEach(t => {
                const categoria = t.natureza || 'Outros';
                if (!categorias[categoria]) {
                    categorias[categoria] = 0;
                }
                categorias[categoria] += parseFloat(t.valor || 0);
            });

            // Converter para arrays para o gr√°fico
            const labels = Object.keys(categorias);
            const valores = Object.values(categorias);

            // Se n√£o houver dados, usar dados padr√£o
            if (labels.length === 0 || valores.reduce((a, b) => a + b, 0) === 0) {
                return {
                    labels: ['Infraestrutura', 'Pessoal', 'Eventos', 'Outros'],
                    valores: [42.1, 52.6, 15.8, 0.5]
                };
            }

            // Converter para porcentagens
            const total = valores.reduce((sum, val) => sum + val, 0);
            const valoresPercent = valores.map(val => (val / total) * 100);

            return {
                labels: labels,
                valores: valoresPercent
            };
        }

        function atualizarBarrasProgressoDashboard(dados) {
            if (!dados) return;

            // Usar valores reais para calcular porcentagens
            const maxValor = Math.max(
                dados.saldoAtual,
                dados.receitasMes,
                dados.despesasMes,
                dados.saldoPrevisto,
                1000 // Valor m√≠nimo para evitar divis√£o por zero
            );

            const percentSaldo = (dados.saldoAtual / maxValor) * 100;
            const percentReceitas = (dados.receitasMes / maxValor) * 100;
            const percentDespesas = (dados.despesasMes / maxValor) * 100;
            const percentPrevisto = (dados.saldoPrevisto / maxValor) * 100;

            const progressFills = document.querySelectorAll('#resumo-financeiro-content .progress-fill');
            if (progressFills.length >= 4) {
                progressFills[0].style.width = Math.min(percentSaldo, 100) + '%';
                progressFills[1].style.width = Math.min(percentReceitas, 100) + '%';
                progressFills[2].style.width = Math.min(percentDespesas, 100) + '%';
                progressFills[3].style.width = Math.min(percentPrevisto, 100) + '%';
            }

            // Calcular percentuais de varia√ß√£o
            document.getElementById('percent-saldo').textContent = dados.saldoAtual >= 0 ?
                `+${((dados.saldoAtual / maxValor) * 100).toFixed(1)}%` :
                `${((dados.saldoAtual / maxValor) * 100).toFixed(1)}%`;

            document.getElementById('percent-receitas').textContent = `+${((dados.receitasMes / maxValor) * 100).toFixed(1)}%`;
            document.getElementById('percent-despesas').textContent = `-${((dados.despesasMes / maxValor) * 100).toFixed(1)}%`;
            document.getElementById('percent-previsto').textContent = dados.saldoPrevisto >= 0 ?
                `+${((dados.saldoPrevisto / maxValor) * 100).toFixed(1)}%` :
                `${((dados.saldoPrevisto / maxValor) * 100).toFixed(1)}%`;
        }

        // ATUALIZAR CARDS DOS OR√áAMENTOS
        function atualizarCardsOrcamentoComDadosReais() {
            if (orcamento.length === 0) {
                console.log('‚ö†Ô∏è Nenhum or√ßamento carregado');
                return;
            }

            const orcamentoTotal = orcamento.reduce((total, item) =>
                total + parseFloat(item.orcamentado || 0), 0
            );

            const realizadoTotal = orcamento.reduce((total, item) =>
                total + parseFloat(item.realizado || 0), 0
            );

            const restanteTotal = orcamentoTotal - realizadoTotal;
            const percentualTotal = orcamentoTotal > 0 ? (realizadoTotal / orcamentoTotal) * 100 : 0;

            // Previs√£o de saldo (saldo atual + or√ßamento restante)
            const saldoAtualElement = document.getElementById('saldo-atual');
            let saldoPrevisto = realizadoTotal;

            if (saldoAtualElement) {
                const saldoAtualTexto = saldoAtualElement.textContent.replace(' Kz', '').replace(/\./g, '').replace(',', '.');
                const saldoAtual = parseFloat(saldoAtualTexto);
                if (!isNaN(saldoAtual)) {
                    saldoPrevisto = saldoAtual + restanteTotal;
                }
            }

            const cards = document.querySelectorAll('#or√ßamento-content .card .value');
            if (cards.length >= 4) {
                cards[0].textContent = formatarValor(orcamentoTotal);
                cards[1].textContent = formatarValor(realizadoTotal);
                cards[2].textContent = formatarValor(restanteTotal);
                cards[3].textContent = formatarValor(saldoPrevisto || orcamentoTotal);

                const trends = document.querySelectorAll('#or√ßamento-content .card .trend');
                if (trends.length >= 4) {
                    trends[0].textContent = `Para ${new Date().getFullYear()}`;
                    trends[1].textContent = `${percentualTotal.toFixed(1)}% do or√ßamento anual`;
                    trends[2].textContent = `${(100 - percentualTotal).toFixed(1)}% do or√ßamento anual`;
                    trends[3].textContent = `Proje√ß√£o at√© final do ano`;
                }
            }

            console.log('üìä Cards de or√ßamento atualizados com dados reais');
        }

        function atualizarCardsRelatoriosComDadosReais() {
            const contadores = { mensal: 0, trimestral: 0, anual: 0, balanco: 0 };

            relatorios.forEach(relatorio => {
                if (contadores.hasOwnProperty(relatorio.tipo)) {
                    contadores[relatorio.tipo]++;
                }
            });

            const cardMensal = document.querySelector('#relatorios-financeiros-content .card:nth-child(1) .value');
            const cardTrimestral = document.querySelector('#relatorios-financeiros-content .card:nth-child(2) .value');
            const cardAnual = document.querySelector('#relatorios-financeiros-content .card:nth-child(3) .value');
            const cardBalanco = document.querySelector('#relatorios-financeiros-content .card:nth-child(4) .value');

            if (cardMensal) cardMensal.textContent = contadores.mensal;
            if (cardTrimestral) cardTrimestral.textContent = contadores.trimestral;
            if (cardAnual) cardAnual.textContent = contadores.anual;
            if (cardBalanco) cardBalanco.textContent = contadores.balanco;

            console.log('üìä Cards de relat√≥rios atualizados com dados reais');
        }

        // ===== FUN√á√ÉO 2: ATUALIZAR CARDS COM RELAT√ìRIOS FILTRADOS (NOVA) =====
        function atualizarCardsRelatoriosComFiltros(relatoriosFiltrados) {
            const contadores = { mensal: 0, trimestral: 0, anual: 0, balanco: 0 };

            relatoriosFiltrados.forEach(relatorio => {
                if (contadores.hasOwnProperty(relatorio.tipo)) {
                    contadores[relatorio.tipo]++;
                }
            });

            const cardMensal = document.querySelector('#relatorios-financeiros-content .card:nth-child(1) .value');
            const cardTrimestral = document.querySelector('#relatorios-financeiros-content .card:nth-child(2) .value');
            const cardAnual = document.querySelector('#relatorios-financeiros-content .card:nth-child(3) .value');
            const cardBalanco = document.querySelector('#relatorios-financeiros-content .card:nth-child(4) .value');

            if (cardMensal) cardMensal.textContent = contadores.mensal;
            if (cardTrimestral) cardTrimestral.textContent = contadores.trimestral;
            if (cardAnual) cardAnual.textContent = contadores.anual;
            if (cardBalanco) cardBalanco.textContent = contadores.balanco;
        }

        // Fun√ß√µes auxiliares para c√°lculos
        function calcularEvolucaoMensal(transacoes, facturas, meses) {
            const hoje = new Date();
            const mesesLabels = [];
            const receitasMensais = [];
            const despesasMensais = [];

            for (let i = meses - 1; i >= 0; i--) {
                const data = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1);
                const mes = data.getMonth() + 1;
                const ano = data.getFullYear();

                // Nome do m√™s
                const nomeMes = data.toLocaleString('pt-PT', { month: 'short' });
                mesesLabels.push(nomeMes.charAt(0).toUpperCase() + nomeMes.slice(1, 3));

                // Calcular receitas do m√™s (facturas pagas + transa√ß√µes de receita)
                const facturasMes = facturas.filter(f => {
                    if (!f.data || f.estado !== 'pago') return false;
                    const dataFactura = parsearDataPortugues(f.data);
                    return dataFactura.getMonth() + 1 === mes &&
                        dataFactura.getFullYear() === ano;
                });

                const transacoesReceita = transacoes.filter(t => {
                    if (!t.data || t.tipo !== 'receita' || t.status !== 'pago') return false;
                    const dataTransacao = parsearDataPortugues(t.data);
                    return dataTransacao.getMonth() + 1 === mes &&
                        dataTransacao.getFullYear() === ano;
                });

                const receitas = facturasMes.reduce((total, f) => total + parseFloat(f.total || f.valor || 0), 0) +
                    transacoesReceita.reduce((total, t) => total + parseFloat(t.valor || 0), 0);

                // Calcular despesas do m√™s
                const transacoesDespesa = transacoes.filter(t => {
                    if (!t.data || t.tipo !== 'despesa' || t.status !== 'pago') return false;
                    const dataTransacao = parsearDataPortugues(t.data);
                    return dataTransacao.getMonth() + 1 === mes &&
                        dataTransacao.getFullYear() === ano;
                });

                const despesas = transacoesDespesa.reduce((total, t) => total + parseFloat(t.valor || 0), 0);

                receitasMensais.push(receitas);
                despesasMensais.push(despesas);
            }

            return {
                meses: mesesLabels,
                receitas: receitasMensais,
                despesas: despesasMensais
            };
        }

        function calcularCategoriasDespesas(transacoesDespesa) {
            const categorias = {};

            transacoesDespesa.forEach(t => {
                const categoria = t.natureza || 'Outros';
                if (!categorias[categoria]) {
                    categorias[categoria] = 0;
                }
                categorias[categoria] += parseFloat(t.valor || 0);
            });

            // Converter para arrays para o gr√°fico
            const labels = Object.keys(categorias);
            const valores = Object.values(categorias);

            // Se n√£o houver dados, usar dados padr√£o
            if (labels.length === 0) {
                return {
                    labels: ['Infraestrutura', 'Pessoal', 'Eventos', 'Outros'],
                    valores: [42.1, 52.6, 15.8, 0.5]
                };
            }

            // Converter para porcentagens
            const total = valores.reduce((sum, val) => sum + val, 0);
            const valoresPercent = valores.map(val => (val / total) * 100);

            return {
                labels: labels,
                valores: valoresPercent
            };
        }

        // ===== FUN√á√ÉO ATUALIZADA PARA ATUALIZAR BARRAS DE PROGRESSO =====
        function atualizarBarrasProgressoDashboard(dados) {
            if (!dados) return;

            const maxSaldo = Math.max(dados.saldoAtual, dados.saldoPrevisto) * 1.5;
            const maxReceitas = dados.receitasMes * 1.5;
            const maxDespesas = dados.despesasMes * 1.5;

            const percentSaldo = maxSaldo > 0 ? (dados.saldoAtual / maxSaldo) * 100 : 0;
            const percentReceitas = maxReceitas > 0 ? (dados.receitasMes / maxReceitas) * 100 : 0;
            const percentDespesas = maxDespesas > 0 ? (dados.despesasMes / maxDespesas) * 100 : 0;
            const percentPrevisto = maxSaldo > 0 ? (dados.saldoPrevisto / maxSaldo) * 100 : 0;

            const progressFills = document.querySelectorAll('#resumo-financeiro-content .progress-fill');
            if (progressFills.length >= 4) {
                progressFills[0].style.width = Math.min(percentSaldo, 100) + '%';
                progressFills[1].style.width = Math.min(percentReceitas, 100) + '%';
                progressFills[2].style.width = Math.min(percentDespesas, 100) + '%';
                progressFills[3].style.width = Math.min(percentPrevisto, 100) + '%';
            }

            // Calcular percentuais de varia√ß√£o (simplificado)
            document.getElementById('percent-saldo').textContent = `+${(percentSaldo / 10).toFixed(1)}%`;
            document.getElementById('percent-receitas').textContent = `+${(percentReceitas / 10).toFixed(1)}%`;
            document.getElementById('percent-despesas').textContent = `-${(percentDespesas / 10).toFixed(1)}%`;
            document.getElementById('percent-previsto').textContent = `+${(percentPrevisto / 10).toFixed(1)}%`;
        }

        // ===== FUN√á√ÉO ATUALIZADA PARA CARDS DE OR√áAMENTO =====
        function atualizarCardsOrcamentoComDadosReais(dados) {
            if (!dados) return;

            const cards = document.querySelectorAll('#or√ßamento-content .card .value');
            if (cards.length >= 4) {
                cards[0].textContent = formatarValor(dados.orcamentoTotal);
                cards[1].textContent = formatarValor(dados.realizadoTotal);
                cards[2].textContent = formatarValor(dados.restanteTotal);
                cards[3].textContent = formatarValor(dados.saldoPrevisto);

                const trends = document.querySelectorAll('#or√ßamento-content .card .trend');
                if (trends.length >= 4) {
                    trends[0].textContent = `Para ${new Date().getFullYear()}`;
                    trends[1].textContent = `${dados.percentualTotal.toFixed(1)}% do or√ßamento anual`;
                    trends[2].textContent = `${(100 - dados.percentualTotal).toFixed(1)}% do or√ßamento anual`;
                    trends[3].textContent = `At√© final de ${new Date().getFullYear()}`;
                }
            }
        }

        // ===== FUN√á√ÉO ATUALIZADA PARA CARDS DE RELAT√ìRIOS =====
        function atualizarCardsRelatoriosComDadosReais() {
            const contadores = { mensal: 0, trimestral: 0, anual: 0, balanco: 0 };

            relatorios.forEach(relatorio => {
                if (contadores.hasOwnProperty(relatorio.tipo)) {
                    contadores[relatorio.tipo]++;
                }
            });

            const cardMensal = document.querySelector('#relatorios-financeiros-content .card:nth-child(1) .value');
            const cardTrimestral = document.querySelector('#relatorios-financeiros-content .card:nth-child(2) .value');
            const cardAnual = document.querySelector('#relatorios-financeiros-content .card:nth-child(3) .value');
            const cardBalanco = document.querySelector('#relatorios-financeiros-content .card:nth-child(4) .value');

            if (cardMensal) cardMensal.textContent = contadores.mensal;
            if (cardTrimestral) cardTrimestral.textContent = contadores.trimestral;
            if (cardAnual) cardAnual.textContent = contadores.anual;
            if (cardBalanco) cardBalanco.textContent = contadores.balanco;
        }

        // ===== FUN√á√ïES PARA CARREGAR DADOS =====
        async function carregarTransacoes(forcarRecarga = false) {
            if (carregandoDados && !forcarRecarga) return;
            carregandoDados = true;

            try {
                mostrarLoading('Carregando transa√ß√µes...');
                const resultado = await fazerRequisicao('getTransactions');

                if (resultado.success) {
                    transacoes = resultado.data || [];
                    console.log(`‚úÖ ${transacoes.length} transa√ß√µes carregadas`);

                    // Atualizar dashboard se estiver vis√≠vel
                    if (document.getElementById('resumo-financeiro-content').style.display !== 'none') {
                        atualizarResumoFinanceiro();
                    }

                    // Atualizar tabela de transa√ß√µes se estiver vis√≠vel
                    if (document.getElementById('transacoes-content').style.display !== 'none') {
                        carregarTabelaTransacoes();
                    }

                    dadosCarregados.transacoes = true;
                } else {
                    mostrarErro('Erro ao carregar transa√ß√µes: ' + resultado.message);
                }
            } catch (error) {
                console.error('Erro ao carregar transa√ß√µes:', error);
                mostrarErro('Erro ao carregar transa√ß√µes');
            } finally {
                carregandoDados = false;
                esconderLoading();
            }
        }

        async function carregarFacturas(forcarRecarga = false) {
            if (carregandoDados && !forcarRecarga) return;
            carregandoDados = true;

            try {
                mostrarLoading('Carregando facturas...');
                const resultado = await fazerRequisicao('getInvoices');

                if (resultado.success) {
                    facturas = resultado.data || [];
                    console.log(`‚úÖ ${facturas.length} facturas carregadas`);

                    // Atualizar tabela se a p√°gina estiver vis√≠vel
                    if (document.getElementById('facturas-content').style.display !== 'none') {
                        carregarTabelaFacturas();
                    }

                    dadosCarregados.facturas = true;
                } else {
                    mostrarErro('Erro ao carregar facturas: ' + resultado.message);
                }
            } catch (error) {
                console.error('Erro ao carregar facturas:', error);
                mostrarErro('Erro ao carregar facturas');
            } finally {
                carregandoDados = false;
                esconderLoading();
            }
        }

        async function carregarRelatorios(forcarRecarga = false) {
            if (carregandoDados && !forcarRecarga) return;
            carregandoDados = true;

            try {
                mostrarLoading('Carregando relat√≥rios...');
                const resultado = await fazerRequisicao('getReports');

                if (resultado.success) {
                    relatorios = resultado.data;
                    console.log(`‚úÖ ${relatorios.length} relat√≥rios carregados`);

                    // Atualizar tabela se a p√°gina estiver vis√≠vel
                    if (document.getElementById('relatorios-financeiros-content').style.display !== 'none') {
                        carregarTabelaRelatorios();
                        atualizarCardsRelatorios();
                    }
                } else {
                    mostrarErro('Erro ao carregar relat√≥rios: ' + resultado.message);
                }
            } catch (error) {
                console.error('Erro ao carregar relat√≥rios:', error);
                mostrarErro('Erro ao carregar relat√≥rios');
            } finally {
                carregandoDados = false;
                esconderLoading();
            }
        }

             

        // ===== FUN√á√ïES PARA CARREGAR DADOS =====
        async function carregarOrcamentos(forcarRecarga = false) {
            if (carregandoDados && !forcarRecarga) return;
            carregandoDados = true;

            try {
                console.log('üì• Carregando or√ßamentos do GAS...');
                mostrarLoading('Carregando or√ßamentos...');

                const resultado = await fazerRequisicao('getBudgets');
                console.log('üìä Resposta do GAS (getBudgets):', resultado);

                if (resultado.success) {
                    orcamento = resultado.data || [];
                    console.log(`‚úÖ ${orcamento.length} or√ßamentos carregados do GAS:`, orcamento);

                    // Atualizar tabela SEMPRE, mesmo se o modal estiver aberto
                    // A p√°gina de or√ßamento continua vis√≠vel por tr√°s do modal
                    if (document.getElementById('or√ßamento-content')) {
                        console.log('üîÑ Atualizando tabela de or√ßamentos...');
                        carregarTabelaOrcamento();
                        atualizarCardsOrcamento();
                        atualizarGraficosOrcamentoComDadosReais();
                    }

                    dadosCarregados.orcamento = true;
                } else {
                    console.error('‚ùå Erro ao carregar or√ßamentos:', resultado.message);
                    mostrarErro('Erro ao carregar or√ßamentos: ' + resultado.message);
                }
            } catch (error) {
                console.error('‚ùå Erro em carregarOrcamentos:', error);
                mostrarErro('Erro ao carregar or√ßamentos');
            } finally {
                carregandoDados = false;
                esconderLoading();
            }
        }

        async function carregarFacturas(forcarRecarga = false) {
            if (carregandoDados && !forcarRecarga) return;
            carregandoDados = true;

            try {
                mostrarLoading('Carregando facturas...');
                const resultado = await fazerRequisicao('getInvoices');

                if (resultado.success) {
                    facturas = resultado.data || [];
                    console.log(`‚úÖ ${facturas.length} facturas carregadas`);

                    // Atualizar tabela se a p√°gina estiver vis√≠vel
                    if (document.getElementById('facturas-content').style.display !== 'none') {
                        carregarTabelaFacturas();
                    }

                    dadosCarregados.facturas = true;
                } else {
                    mostrarErro('Erro ao carregar facturas: ' + resultado.message);
                }
            } catch (error) {
                console.error('Erro ao carregar facturas:', error);
                mostrarErro('Erro ao carregar facturas');
            } finally {
                carregandoDados = false;
                esconderLoading();
            }
        }

        async function carregarRelatorios(forcarRecarga = false) {
            if (carregandoDados && !forcarRecarga) return;
            carregandoDados = true;

            try {
                mostrarLoading('Carregando relat√≥rios...');
                const resultado = await fazerRequisicao('getReports');

                if (resultado.success) {
                    relatorios = resultado.data || [];
                    console.log(`‚úÖ ${relatorios.length} relat√≥rios carregados`);

                    // Atualizar tabela e cards se a p√°gina estiver vis√≠vel
                    if (document.getElementById('relatorios-financeiros-content').style.display !== 'none') {
                        carregarTabelaRelatorios();
                        atualizarCardsRelatoriosComDadosReais();
                    }

                    dadosCarregados.relatorios = true;
                } else {
                    mostrarErro('Erro ao carregar relat√≥rios: ' + resultado.message);
                }
            } catch (error) {
                console.error('Erro ao carregar relat√≥rios:', error);
                mostrarErro('Erro ao carregar relat√≥rios');
            } finally {
                carregandoDados = false;
                esconderLoading();
            }
        }

        
        async function calcularOrcamentosRealizados() {
            // Se n√£o temos transa√ß√µes, carregue-as primeiro
            if (transacoes.length === 0) {
                await carregarTransacoes();
            }

            orcamento.forEach(item => {
                // Filtrar transa√ß√µes da mesma natureza e que s√£o despesas pagas
                const transacoesNatureza = transacoes.filter(t =>
                    t.natureza === item.natureza &&
                    t.tipo === 'despesa' &&
                    t.status === 'pago'
                );

                const realizado = transacoesNatureza.reduce((total, t) =>
                    total + parseFloat(t.valor || 0), 0
                );

                item.realizado = realizado || 0;
                item.diferenca = parseFloat(item.orcamentado) - realizado;
                item.percentual = parseFloat(item.orcamentado) > 0 ?
                    (realizado / parseFloat(item.orcamentado)) * 100 : 0;

                // Atualizar status baseado no percentual
                if (item.percentual >= 90) item.status = 'Alerta';
                else if (item.percentual >= 70) item.status = 'Aten√ß√£o';
                else if (item.percentual >= 0) item.status = 'Normal';
                else item.status = 'Normal';
            });
        }

        // ===== INICIALIZA√á√ÉO =====
        function inicializarEventListeners() {
            // Configurar event listeners para transa√ß√µes
            document.getElementById('btn-nova-transacao').addEventListener('click', () => abrirModalTransacao());
            document.getElementById('btn-nova-transacao-lista').addEventListener('click', () => abrirModalTransacao());
            document.getElementById('btn-fechar-modal-transacao').addEventListener('click', fecharModalTransacao);
            document.getElementById('btn-cancelar-transacao').addEventListener('click', cancelarTransacao);
            document.getElementById('btn-salvar-transacao').addEventListener('click', salvarTransacao);

            // Configurar event listeners para facturas
            document.getElementById('btn-nova-factura').addEventListener('click', () => abrirModalFactura());
            document.getElementById('btn-fechar-modal-factura').addEventListener('click', fecharModalFactura);
            document.getElementById('btn-cancelar-factura').addEventListener('click', cancelarFactura);
            document.getElementById('btn-salvar-factura').addEventListener('click', salvarFactura);
            document.getElementById('btn-imprimir-factura').addEventListener('click', function () {
                const id = document.getElementById('factura-id').value;
                if (id) {
                    imprimirFactura(parseInt(id));
                } else {
                    alert('Primeiro salve a factura antes de imprimir.');
                }
            });

            // Exportar relat√≥rio em PDF
            document.getElementById('btn-exportar-relatorio').addEventListener('click', exportarRelatorioPDF);

            // Configurar navega√ß√£o
            document.querySelectorAll('.sidebar-menu a').forEach(item => {
                item.addEventListener('click', function (e) {
                    e.preventDefault();
                    const pagina = this.getAttribute('data-page');
                    if (pagina) alternarPagina(pagina);
                });
            });

            // Event listeners para filtros
            document.getElementById('btn-aplicar-filtros-transacoes').addEventListener('click', aplicarFiltrosTransacoes);
            document.getElementById('filter-periodo-transacoes').addEventListener('change', aplicarFiltrosTransacoes);
            document.getElementById('filter-tipo-transacoes').addEventListener('change', aplicarFiltrosTransacoes);
            document.getElementById('filter-categoria-transacoes').addEventListener('change', aplicarFiltrosTransacoes);

            document.getElementById('btn-aplicar-filtros-facturas').addEventListener('click', aplicarFiltrosFacturas);

            // Event listeners para c√°lculo autom√°tico do total da factura
            document.getElementById('factura-quota').addEventListener('input', atualizarTotalFactura);
            document.getElementById('factura-multa').addEventListener('input', atualizarTotalFactura);
            document.getElementById('factura-joia').addEventListener('input', atualizarTotalFactura);

            // Configurar autocomplete
            configurarAutocompleteAssociado();

            // Event listeners para or√ßamento
            document.getElementById('btn-novo-orcamento').addEventListener('click', abrirModalNovoOrcamento);
            document.getElementById('btn-previsao-saldo').addEventListener('click', abrirModalPrevisaoSaldo);

            // Event listeners para relat√≥rios
            document.getElementById('btn-gerar-relatorio').addEventListener('click', abrirModalNovoRelatorio);

            // EVENT LISTENERS PARA RELAT√ìRIOS
            document.getElementById('btn-aplicar-filtros-relatorios').addEventListener('click', aplicarFiltrosRelatorios);
            document.getElementById('btn-limpar-filtros-relatorios').addEventListener('click', limparFiltrosRelatorios);

            // Filtro autom√°tico ao pressionar Enter
            document.getElementById('filter-autor-relatorio').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') aplicarFiltrosRelatorios();
            });


            // Event listeners para controlo de pagamento
            document.getElementById('btn-aplicar-filtros-membros').addEventListener('click', function () {
                currentFilters.categoria = document.getElementById('filter-categoria').value;
                currentFilters.status = document.getElementById('filter-status').value;
                currentFilters.nome = document.getElementById('filter-nome').value;
                carregarTabelaMembros();
            });

            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function () {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');

                    const tabName = this.getAttribute('data-tab');
                    let status = '';

                    if (tabName === 'regulares') status = 'Regular';
                    else if (tabName === 'suspensos') status = 'Suspenso';
                    else if (tabName === 'pendentes') status = 'Pendente';
                    else if (tabName === 'divida') status = 'D√≠vida';

                    currentFilters.status = status;
                    document.getElementById('filter-status').value = status;
                    carregarTabelaMembros();
                });
            });

            // Event listeners para modais de controlo de pagamento
            document.getElementById('btn-fechar-modal').addEventListener('click', fecharModalMembro);
            document.getElementById('btn-cancelar').addEventListener('click', fecharModalMembro);
            document.getElementById('btn-salvar-membro').addEventListener('click', salvarMembro);
            document.getElementById('btn-pagou').addEventListener('click', marcarPagamento);
            document.getElementById('btn-fechar-modal-ver').addEventListener('click', fecharModalMembro);
            document.getElementById('btn-fechar-ver').addEventListener('click', fecharModalMembro);

            document.getElementById('status').addEventListener('change', function () {
                const status = this.value;
                if (status === 'D√≠vida') {
                    document.getElementById('btn-em-divida').style.display = 'inline-block';
                    document.getElementById('info-pagamento').innerHTML = '<i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i> Este membro est√° em d√≠vida';
                } else {
                    document.getElementById('btn-em-divida').style.display = 'none';
                    document.getElementById('info-pagamento').innerHTML = '<i class="fas fa-check" style="color: var(--success);"></i> Pagamento em dia';
                }
            });

            // Event listeners para modais adicionais
            const btnFecharModalRelatorio = document.getElementById('btn-fechar-modal-relatorio');
            if (btnFecharModalRelatorio) {
                btnFecharModalRelatorio.addEventListener('click', fecharModalNovoRelatorio);
            }

            const btnFecharModalPrevisaoSaldo = document.getElementById('btn-fechar-modal-previsao-saldo');
            if (btnFecharModalPrevisaoSaldo) {
                btnFecharModalPrevisaoSaldo.addEventListener('click', fecharModalPrevisaoSaldo);
            }

            const btnFecharModalNovoOrcamento = document.getElementById('btn-fechar-modal-novo-orcamento');
            if (btnFecharModalNovoOrcamento) {
                btnFecharModalNovoOrcamento.addEventListener('click', fecharModalNovoOrcamento);
            }

            const btnFecharModalVisualizarOrcamento = document.getElementById('btn-fechar-modal-visualizar-orcamento');
            if (btnFecharModalVisualizarOrcamento) {
                btnFecharModalVisualizarOrcamento.addEventListener('click', fecharModalVisualizarOrcamento);
            }

            const btnFecharModalEditarOrcamento = document.getElementById('btn-fechar-modal-editar-orcamento');
            if (btnFecharModalEditarOrcamento) {
                btnFecharModalEditarOrcamento.addEventListener('click', fecharModalEditarOrcamento);
            }

            // Event listeners para bot√µes de cancelar
            const btnCancelarRelatorio = document.getElementById('btn-cancelar-relatorio');
            if (btnCancelarRelatorio) {
                btnCancelarRelatorio.addEventListener('click', cancelarRelatorio);
            }

            const btnCancelarPrevisaoSaldo = document.getElementById('btn-cancelar-previsao-saldo');
            if (btnCancelarPrevisaoSaldo) {
                btnCancelarPrevisaoSaldo.addEventListener('click', cancelarPrevisaoSaldo);
            }

            const btnCancelarNovoOrcamento = document.getElementById('btn-cancelar-novo-orcamento');
            if (btnCancelarNovoOrcamento) {
                btnCancelarNovoOrcamento.addEventListener('click', cancelarNovoOrcamento);
            }

            const btnCancelarEditarOrcamento = document.getElementById('btn-cancelar-editar-orcamento');
            if (btnCancelarEditarOrcamento) {
                btnCancelarEditarOrcamento.addEventListener('click', cancelarEditarOrcamento);
            }

            const btnCancelarVisualizarOrcamento = document.getElementById('btn-cancelar-visualizar-orcamento');
            if (btnCancelarVisualizarOrcamento) {
                btnCancelarVisualizarOrcamento.addEventListener('click', cancelarVisualizarOrcamento);
            }

            // Event listeners para bot√µes de salvar
            const btnSalvarRelatorio = document.getElementById('btn-salvar-relatorio');
            if (btnSalvarRelatorio) {
                btnSalvarRelatorio.addEventListener('click', salvarNovoRelatorio);
            }

            const btnSalvarPrevisaoSaldo = document.getElementById('btn-salvar-previsao-saldo');
            if (btnSalvarPrevisaoSaldo) {
                btnSalvarPrevisaoSaldo.addEventListener('click', salvarPrevisaoSaldo);
            }

            const btnSalvarNovoOrcamento = document.getElementById('btn-salvar-novo-orcamento');
            if (btnSalvarNovoOrcamento) {
                btnSalvarNovoOrcamento.addEventListener('click', salvarNovoOrcamento);
            }

            const btnSalvarEditarOrcamento = document.getElementById('btn-salvar-editar-orcamento');
            if (btnSalvarEditarOrcamento) {
                btnSalvarEditarOrcamento.addEventListener('click', salvarEditarOrcamento);
            }

            const btnFecharVisualizarOrcamento = document.getElementById('btn-fechar-visualizar-orcamento');
            if (btnFecharVisualizarOrcamento) {
                btnFecharVisualizarOrcamento.addEventListener('click', cancelarVisualizarOrcamento);
            }
        }

        document.addEventListener('DOMContentLoaded', async function () {
            console.log('üöÄ Sistema iniciando...');

            // Inicializar sistemas
            inicializarSistemaNotificacoes();
            inicializarEventListeners();

            // Inicializar gr√°ficos com retardo para garantir que o DOM esteja pronto
            setTimeout(function () {
                inicializarGraficos();
                console.log('üìä Gr√°ficos inicializados ap√≥s delay');
            }, 500);

            // Carregar dados iniciais
            await carregarTransacoes();

            // Pr√©-carregar membros para facturas (opcional)
            setTimeout(() => {
                carregarMembrosParaFacturas().then(success => {
                    if (success) {
                        console.log('‚úÖ Membros pr√©-carregados para facturas');
                    }
                });
            }, 2000);

            // Garantir que a p√°gina inicial seja o Resumo Financeiro
            alternarPagina('resumo-financeiro');
        
                    // Configurar sincroniza√ß√£o autom√°tica a cada 30 minutos de inatividade
            let inactivityTimer;

            function resetInactivityTimer() {
                clearTimeout(inactivityTimer);
                inactivityTimer = setTimeout(() => {
                    if (!carregandoDados) {
                        console.log('‚è∞ Atualiza√ß√£o autom√°tica ap√≥s 30 minutos de inatividade');

                        // S√≥ recarregar se os dados estiverem vis√≠veis
                        if (document.getElementById('resumo-financeiro-content').style.display !== 'none') {
                            carregarDadosDashboard(true).catch(console.error);
                        }
                        if (document.getElementById('transacoes-content').style.display !== 'none') {
                            carregarTransacoes(true).catch(console.error);
                        }
                        if (document.getElementById('facturas-content').style.display !== 'none') {
                            carregarFacturas(true).catch(console.error);
                        }
                        if (document.getElementById('relatorios-financeiros-content').style.display !== 'none') {
                            carregarRelatorios(true).catch(console.error);
                        }
                        if (document.getElementById('or√ßamento-content').style.display !== 'none') {
                            carregarOrcamentos(true).catch(console.error);
                        }
                    }
                }, 1800000); // 30 minutos = 1.800.000 ms ‚Üê‚Üê‚Üê NOVO TEMPO
            }

            // Reiniciar timer em qualquer intera√ß√£o do usu√°rio
            ['click', 'mousemove', 'keypress', 'scroll'].forEach(event => {
                document.addEventListener(event, resetInactivityTimer);
            });

            // Iniciar timer inicial
            resetInactivityTimer();

            // Garantir que a p√°gina inicial seja o Resumo Financeiro
            alternarPagina('resumo-financeiro');


            // ===== INICIALIZA√á√ÉO ROBUSTA DO SISTEMA =====
            document.addEventListener('DOMContentLoaded', function () {
                console.log('üöÄ Sistema iniciando...');

                // 1. Inicializar notifica√ß√µes (sempre funciona)
                if (typeof inicializarSistemaNotificacoes === 'function') {
                    inicializarSistemaNotificacoes();
                }

                // 2. Inicializar gr√°ficos COM SEGURAN√áA
                setTimeout(function inicializarGraficosComSeguranca() {
                    try {
                        console.log('üìä Tentando inicializar gr√°ficos...');

                        // Resetar vari√°veis para garantir estado limpo
                        window.fluxoCaixaChart = undefined;
                        window.categoriasDespesasChart = undefined;
                        window.chartsInicializados = false;

                        // Chamar a fun√ß√£o
                        inicializarGraficos();

                        console.log('‚úÖ Gr√°ficos inicializados com sucesso');

                    } catch (error) {
                        console.error('‚ùå Falha cr√≠tica na inicializa√ß√£o de gr√°ficos:', error);

                        // Tentar m√©todo alternativo
                        console.log('üîÑ Usando m√©todo alternativo...');
                        setTimeout(function () {
                            try {
                                // Criar gr√°ficos m√≠nimos diretamente
                                const fluxoCanvas = document.getElementById('fluxoCaixaChart');
                                const categoriasCanvas = document.getElementById('categoriasDespesasChart');

                                if (fluxoCanvas && categoriasCanvas) {
                                    const ctx1 = fluxoCanvas.getContext('2d');
                                    window.fluxoCaixaChart = new Chart(ctx1, {
                                        type: 'line',
                                        data: { labels: [], datasets: [] },
                                        options: { responsive: true }
                                    });

                                    const ctx2 = categoriasCanvas.getContext('2d');
                                    window.categoriasDespesasChart = new Chart(ctx2, {
                                        type: 'doughnut',
                                        data: { labels: [], datasets: [] },
                                        options: { responsive: true }
                                    });

                                    console.log('‚úÖ Gr√°ficos alternativos criados');
                                    window.chartsInicializados = true;
                                }
                            } catch (e) {
                                console.error('üí• Falha mesmo no m√©todo alternativo:', e);
                            }
                        }, 500);
                    }
                }, 400); // Delay maior para garantir estabilidade

                // 3. Carregar dados do dashboard (com delay maior)
                setTimeout(function () {
                    if (typeof carregarDadosDashboard === 'function') {
                        console.log('üìà Carregando dados do dashboard...');
                        carregarDadosDashboard();
                    }
                }, 1500);

                console.log('üèÅ Sistema em processo de inicializa√ß√£o');
            });

                // ===== FALLBACK DE EMERG√äNCIA =====
                // Se algo der errado, esta fun√ß√£o garante que os gr√°ficos sejam criados
                function criarGraficosDeEmergencia() {
                    console.log('üÜò Criando gr√°ficos de emerg√™ncia...');

                    // Resetar tudo
                    window.fluxoCaixaChart = undefined;
                    window.categoriasDespesasChart = undefined;
                    chartsInicializados = false;

                    const fluxoCanvas = document.getElementById('fluxoCaixaChart');
                    const categoriasCanvas = document.getElementById('categoriasDespesasChart');

                    if (!fluxoCanvas || !categoriasCanvas) {
                        console.error('‚ùå Canvas n√£o encontrados mesmo no fallback');
                        return;
                    }

                    try {
                        // Gr√°fico de fluxo m√≠nimo
                        const fluxoCtx = fluxoCanvas.getContext('2d');
                        window.fluxoCaixaChart = new Chart(fluxoCtx, {
                            type: 'line',
                            data: { labels: [], datasets: [] },
                            options: { responsive: true }
                        });

                        // Gr√°fico de categorias m√≠nimo
                        const categoriasCtx = categoriasCanvas.getContext('2d');
                        window.categoriasDespesasChart = new Chart(categoriasCtx, {
                            type: 'doughnut',
                            data: { labels: ['Erro'], datasets: [{ data: [1], backgroundColor: ['#dc3545'] }] },
                            options: { responsive: true }
                        });

                        console.log('‚úÖ Gr√°ficos de emerg√™ncia criados');
                        chartsInicializados = true;
                    } catch (e) {
                        console.error('üí• Falha at√© no fallback:', e);
                    }
                }

                // ===== INICIALIZA√á√ÉO FINAL =====
                // Aguardar a p√°gina carregar completamente
                window.addEventListener('load', function () {
                    console.log('üåê P√°gina carregada, iniciando sistema...');

                    // Pequeno delay para garantir estabilidade
                    setTimeout(function () {
                        try {
                            // Inicializar notifica√ß√µes
                            if (typeof inicializarSistemaNotificacoes === 'function') {
                                inicializarSistemaNotificacoes();
                            }

                            // Verificar se os gr√°ficos foram inicializados
                            if (!window.fluxoCaixaChart || !window.categoriasDespesasChart || !chartsInicializados) {
                                console.log('üîÑ Gr√°ficos n√£o inicializados, tentando criar...');
                                if (typeof inicializarGraficos === 'function') {
                                    inicializarGraficos();
                                } else {
                                    criarGraficosDeEmergencia();
                                }
                            }

                            // Carregar dados do dashboard
                            setTimeout(function () {
                                if (typeof carregarDadosDashboard === 'function') {
                                    carregarDadosDashboard();
                                }
                            }, 1000);

                            console.log('‚úÖ Sistema inicializado');
                        } catch (error) {
                            console.error('üí• Erro fatal na inicializa√ß√£o:', error);
                            criarGraficosDeEmergencia();
                        }
                    }, 300);
                });
        });
    </script>
</body>
</html>
